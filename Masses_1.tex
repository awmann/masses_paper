\documentclass[twocolumn]{aastex62}
%\documentclass[iop,revtex4]{emulateapj}
\let\pwiflocal=\iffalse \let\pwifjournal=\iffalse
\input{setup}
\usepackage[outdir=./]{epstopdf}

\newcommand{\ktwo}{{\it K2}}
\newcommand{\av}{$A_V$}
\newcommand{\mks}{$M_{K_S}$}
\newcommand{\mmk}{$M_{K_S}-M_*$}
\newcommand{\order}{5}
\usepackage{mathrsfs}
%\usepackage[colorlinks=true,urlcolor=blue,citecolor=black]{hyperref}
%\usepackage{xcolor}
%\usepackage[colorlinks = true,
% linkcolor = blue,
% urlcolor = blue,
% citecolor = blue,
% anchorcolor = blue]{hyperref}
%\newcommand{\href}{\href}%
%\newcommand{\href}[3][blue]{\href{#2}{\color{#1}{#3}}}%
%\slugcomment{To be Submitted to ApJ}

\shorttitle{Mass-luminosity relation of cool stars}
\shortauthors{Mann et al.}
\submitjournal{The Astrophysical Journal}


\bibliographystyle{apj}


\begin{document}

%% 
\title{How to Constrain your M dwarf II:\\ the mass-luminosity-metallicity relation from 0.70$M_\odot$ to 0.075$M_\odot$ }
%$M_*$-$M_{K_S}$ relation from 0.7$M_\odot$ to 0.075$M_\odot$%. \\
%or \\
%How to constrain your M dwarf II: \\
 %the $M_*$-$M_{K_S}$ relation from 0.7$M_\odot$ to 0.075$M_\odot$

 

\correspondingauthor{Andrew W. Mann}
\email{mann.andrew.w@gmail.com}

\author[0000-0003-3654-1602]{Andrew W. Mann}
\altaffiliation{Hubble Fellow}
\affiliation{Columbia University, Department of Astronomy, 550 West 120th Street, New York, NY 10027}
\affiliation{Department of Physics and Astronomy, University of North Carolina at Chapel Hill, Chapel Hill, NC 27599-3255, USA}

\author[0000-0001-9823-1445]{Trent Dupuy}
\affiliation{Gemini Observatory, Northern Operations Center, 670 N. Aohoku Place, Hilo, HI 96720, USA}
 
\author[0000-0001-9811-568X]{Adam Kraus}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0002-5258-6846]{Eric Gaidos}
\affiliation{Department of Geology \& Geophysics, University of Hawaii at M\={a}noa, Honolulu, Hawaii 96822 USA}

\author[0000-0001-9982-1332]{Aaron Rizzuto}
\altaffiliation{51 Peg b Fellow}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0002-6194-043X]{Michael Ireland}%
\affiliation{Research School of Astronomy \& Astrophysics, Australian National University, Canberra ACT 2611, Australia}

\author[0000-0003-4142-9842]{Megan Ansdell}%
\affiliation{Department of Astronomy, University of California at Berkeley, Berkeley, CA 94720, USA}

%\author{Jean-Luc Beuzit}
%\affiliation{Observatoire de Grenoble, Institut de Planetologie et d'Astrophysique de Grenoble, BP 53, 38041 Grenoble Cedex 9, France}

\author[0000-0002-6879-3639]{Chao-Ling Hung}
\affiliation{Department of Physics, Manhattan College, 4513 Manhattan College Parkway, Riverdale, NY 10471, USA}

\author[0000-0001-7730-2240]{Jason Dittmann}
\altaffiliation{51 Peg b Fellow}
\affiliation{Massachusetts Institute of Technology, 77 Massachusetts Avenue, Cambridge, Massachusetts 02138, USA}
%\affiliation{Harvard-Smithsonian Center for Astrophysics, 60 Garden St., Cambridge, MA, 02138}

\author[0000-0002-8332-8516]{Samuel Factor}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

%\author[0000-0003-0536-4607]{Thierry Forveille}
%\affiliation{Observatoire de Grenoble, Institut de Planetologie et d'Astrophysique de Grenoble, BP 53, 38041 Grenoble Cedex 9, France}

\author[0000-0001-6301-896X]{Raquel A. Martinez}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0003-3573-8163]{Dary Ru\'iz-Rodr\'iguez}
\affiliation{Chester F. Carlson Center for Imaging Science, School of Physics \& Astronomy, and Laboratory for Multiwavelength Astrophysics,
Rochester Institute of Technology, 54 Lomb Memorial Drive, Rochester NY 14623 USA}
\affiliation{Research School of Astronomy and Astrophysics, Australian National University, Canberra, ACT 2611, Australia}

%\watermark{}

\begin{abstract}
The mass-luminosity relation for late-type stars has long been a critical tool for estimating masses of late-type stars, with implications for a wide range of astrophysics. Here we present an empirical \mmk\ relation spanning 0.70$M_\odot$ to the hydrogen burning limit ($\simeq0.075M_\odot$). The relation is derived from observations of 59 nearby binaries, whose orbits we determine using a a combination of our own monitoring with NIRC2 on Keck, archival adaptive optics data, and astrometry from the literature. From their orbital parameters, we determine the total mass of each system to better than 1\% in the best cases (median precision on $M_*$ of 5.6\%). We join our mass determinations with resolved \mks\ magnitudes for each component to constrain the relation between \mks\ and $M_*$. Our resulting equation yields masses of single stars to 2\% for $0.10M_\odot<M_*<0.55M_\odot$, and 4\% for $0.075M_\odot<M_*<0.18M_\odot$ or $0.55M_\odot<M_*<0.75M_\odot$. The primarily precision limit is scatter around the best-fit relation larger than expected by the input $M_*$ uncertainties. This may be due to intrinsic variation in the \mmk\ relation or underestimated uncertainties in the input parallaxes. We demonstrate that the effect of [Fe/H] on the \mmk\ relation is significantly weaker than predicted by evolutionary models ($4.0\sigma$), and is negligible for the metallicity range in the Solar neighborhood. A sample of binaries with a wider range of abundances will be required to see if metallicity becomes important for more extreme populations (e.g., in the Galactic Halo). 
\end{abstract}

\keywords{stars: fundamental parameters; stars: low-mass; stars: luminosity function, mass function}
\NewPageAfterKeywords

% without latex:

%% To do:
%% Applications section (Trappist-1, etc.)
%% GJ1245 in table section


\section{Introduction}\label{sec:intro}
Over the past decade, M dwarfs have become critical for a wide range of astrophysics. On the small scale, M dwarfs are attractive targets for the identification and characterization of exoplanets. The small size, low mass, and low luminosity of late-type dwarfs facilitate the discovery of small planets \citep[e.g.][]{Muirhead2012,Martinez:2017aa,Mann:2018} and those in their circumstellar habitable zone \citep[e.g.,][]{Tarter2007,Shields:2016aa,2017Natur.544..333D}. Close-in, rocky planets are also significantly more common around M dwarfs than their Sun-like counterparts \citep{Dressing2013,2013PNAS..11019273P,Mulders2015,Gaidos2016b}

The properties of both the Milky Way and more distant galaxies are inexorably linked to parameters of their most numerous constituents \citep[$>$70\% of stars in the Solar neighborhood are M dwarfs,][]{Henry:1994fk,Reid:2004lr}. Late-type dwarfs weigh heavily on the Galactic mass function \citep[e.g.,][]{Covey:2008lr}, and are useful probes of the Milky Way's structure \citep[e.g.,][]{2008ApJ...673..864J,2017ApJ...843..141F}, kinematics \citep[e.g.,][]{2007AJ....134.2418B,2015RAA....15..860Y} and chemical evolution \citep{Woolf:2012lr,2015AJ....149..140H}. Although K and M dwarfs are much fainter than their higher-mass counterparts, they contribute significantly to the integrated spectra of massive galaxies; thus M dwarf fundamental properties have become an essential component to studies of extragalactic initial mass functions \citep[e.g.,][]{2012ApJ...747...69C,2016ApJ...821...39M} and mass-to-light ratios \citep{2015MNRAS.452L..21S}. M dwarf - white dwarf pairs are a plausible progenitor for Type Ia supernovae \citep{2012ApJ...758..123W}, and hence late-type stars are important to understand even for cosmological problems.

For all these areas, it is essential that we have a method to estimate the fundamental parameters of late-type dwarfs. For exoplanet research, this means stellar radii for planet radii in transit surveys, stellar masses for planet masses in radial velocity surveys, and both (stellar densities) for determining occurrence rates and exoplanet structures. Spectra, photometry, and distances of stars provide a relatively direct means to measure \teff\ \citep[e.g.,][]{Rojas-Ayala:2012uq,Mann2013c}, luminosity \citep[e.g.,][]{2002AJ....124.2721R}, metallicity \citep[e.g.,][]{2005A&A...442..635B,2010ApJ...720L.113R}, and radius \citep[e.g., via Stefan-Boltzmann, ][]{Newton2015A,2018arXiv180404133K}. Masses are much more difficult to infer from observations alone, yet they are one of the most important and fundamental properties of a star.  

In the case of a binary, it is possible to directly determine the mass of a star from its orbital parameters and Kepler's laws. For systems with reasonably short orbital periods, this can be done by monitoring the motion of the stars over time.  Radial velocity variation can yield individual stellar masses but only modulo the sine of the orbita inclination \citep[e.g.,][]{Torres2002,Kraus2011,2017arXiv171205046S}. In systems where binary components are spatially resolved, monitoring of their position angle and separation can yield a measurement of the total system mass, assuming the parallax is known or measured from the same astrometry \citep[e.g.,][]{Soderhjelm1999,Woi2003,2009ApJ...699..168D}.  

For single stars, mass estimates can be derived from evolutionary models \citep[e.g.,][]{Muirhead2012a,2012ApJ...747...69C}. However, differences between empirical and model-predicted mass-radius and radius-luminosity relations for late-type stars \citep[e.g.,][]{Boyajian2012,Feiden2012a} raise concerns about the reliability of model-based masses. Further, the masses derived depend on both the model grid used \citep{Spada2013,MIST1}, and the observed parameter over which the interpolation is done \citep[e.g., color versus luminosity,][]{Mann:2012,Mann2015b}. Ultimately, these models need to be tested empirically; differences between the models and empirical determinations can reveal important missing physics or erroneous assumptions in the model grids. 

An empirical approach to estimating single-star masses is through a relation between mass and luminosity \citep[e.g.,][]{Henry:1993fk, Delfosse2000}, calibrated with dynamical mass measurements from binary stars. Absolute magnitude can be used as a proxy for luminosity, and is generally easy to measure for visual binaries from the same data used to establish the orbit. Because late-type stars evolve slowly on the main sequence, the stellar locus in mass-luminosity space is tight for a fixed metallicity. Using near-infrared magnitudes instead of optical bands mitigates the effect of metallicity, as detailed abundances have a weaker effect on the absolute flux levels of M dwarfs past 1.2\um\ when compared to optical regions. As a result, the $M_K-M_*$ relation provides the most precise masses and has become the most commonly used relation. 

Empirical $M_K-M_*$ relations from \citet{Henry:1993fk} and \citet{Delfosse2000} determine masses to $\simeq$10\% precision, with more recent improvements by \citet{Benedict2016}. However, as fields that rely on M dwarf parameters have pushed to higher precision, there has been need for proportionately improved precision for M dwarf masses. Further, since the advent of Gaia parallaxes, even late-type dwarfs beyond the Solar neighborhood now have $<1\%$ parallaxes, making scatter in the \mmk\ relation the primary source of error when estimating their masses. Existing relations also have gaps in their calibration sample, particularly below $0.1M_\odot$, where there is need for stellar masses to match new exoplanet surveys \citep[e.g.,][]{2017Natur.542..456G}. Lastly, methods to measure metallicities of M dwarfs have become increasingly precise \citep[e.g.,][]{2010ApJ...720L.113R, 2014A&A...568A.121N,2016A&A...586A.100L}, making it possible to explore the impact of metallicity on the \mmk\ relation. 

Here we present a revised empirical relation between $M_*$, $M_{K_S}$, and [Fe/H], spanning almost an order of magnitude in mass, from 0.075$M_\odot$ to 0.70$M_\odot$, and typical metallicities in the Solar neighborhood ($-0.6<$[Fe/H]$<+0.4$). The relation is built on orbital fits to visual binaries from a combination of adaptive optics imaging and astrometric measurements in the literature with metallicities estimated from the stars' near-infrared spectra. In Section~\ref{sec:targets} we detail our selection of nearby late-type binaries with orbits amenable to mass determinations. We overview our astrometric and spectroscopic observations in Section~\ref{sec:obs}, including those from telescope archives and the literature. Our orbit-fitting procedure is explained in Section~\ref{sec:orbit}. We describe our method to determine other parameters of each system ([Fe/H], distance, and \mks) in Section~\ref{sec:params}. Our technique to fit the \mmk\ relation from these binaries is described in Section~\ref{sec:relation}, including an analysis of the errors as a function of \mks, a detailed look at the effects of [Fe/H], and a comparison to earlier relations. We conclude in Section~\ref{sec:discussion} with a brief summary, and a discussion of the important caveats and complications to consider when using our relation, as well as future directions we are taking to expand on the work given here.

 {\it If you want to use the relations in this manuscript, we advise at least reading Section~\ref{sec:caveats} to understand the potential limitations of the \href{https://github.com/awmann/M_-M_K-}{program and posteriors} we provide.}


\section{Sample Selection}\label{sec:targets}
Our selection of binaries was designed to sample the region of mass space over which the mass-luminosity relation should not evolve significantly between the zero-age main sequence and the age of the Galactic disk ($\sim$10~Gyr). We quantified this using the \citet{BHAC15} models, which we show in Figure~\ref{fig:age}. Above $0.75M_\odot$, a fixed luminosity (the observable) could correspond to a $\simeq$5\% range in masses over 1-10\, Gyr. Stars below $\simeq0.1M_\odot$ take a long time (100-1000\,Myr) to arrive on the main sequence, but obey a tight relation beyond this point. Those objects below $\simeq0.08M_\odot$ are predicted to never reach the main sequence and hence obey no mass-luminosity relation (although this transition likely depends on metallicity). We therefore attempt to select systems spanning $0.075M_\odot \lesssim M_* \lesssim0.70M_\odot$.

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Model_age2.eps}
\caption{Stellar luminosity as a function of mass predicted by the \citet{BHAC15} models, color-coded by age (metallicity fixed at Solar). The grey regions denote masses excluded by this study due to a significant age dependence on the mass-luminosity relation.}
\label{fig:age}
\end{center}
\end{figure}

We first selected systems by cross-matching catalogs of nearby M dwarfs \citep{Lepine:2013, Gaidos2014, 2014ApJ...784..156D,Winters2015}, with the fourth catalog of interferometric measurements of binary stars \citep[INT4,][]{Hartkopf:2001}, and adaptive optics (AO) images from the Keck Observatory Archive (KOA). As part of this cross-match, we also included targets matching the M dwarf selection criteria of \citet{Gaidos2014}, but with a bluer color cut ($V-J>1.8$) to incorporate additional late-K dwarfs. We kept any binaries with separations less than 5\arcsec. We then added in other known late-type binaries from \citet{2008MNRAS.384..150L}, \citet{Janson2012}, \citet{Jnn2014}, and \citet{Ward-Duong2015}. This provided a list of more than 300 multi-star systems.

From here we selected binaries for which we expect to be able to obtain a precise orbit on a reasonable (few year) timescale. We assumed that the average of available (literature) separation measurements approximate the semi-major axis of the system. We then identified systems for which we would have at least 30\% of the orbit, including the two years of our orbital monitoring program with Keck. This cut accounted for existing data. As a result, long-period binaries with extensive previous observations were included, depending on the baseline available, while those with only a single epoch would generally need to have orbits of $\ll$10 years to be observed. After this cut we were left with 125 systems. Excluding 38 systems at $\delta<-30~deg$ that are difficult to observe from Maunakea, 87 systems were included in our observing program.

We removed 21 systems from our analysis because of an unresolved tertiary (or quaternary) component noted in the literature \citep[e.g.,][]{2010ApJ...720.1727L,2002A&A...382..118T,2018ApJS..235....6T}. In their current form, such systems were not useful for our analysis, as we had no $\Delta K$ magnitudes or mass ratios for the unresolved components. Since many of these are double- or triple-lined systems, it is possible to recover their parameters with multi-epoch radial velocities, and some systems have the necessary data in the literature \citep[e.g.,][]{Sgr2000}. We continued to monitor these systems with high-resolution near-infrared spectrographs \citep{2010SPIE.7735E..1MY, 2012SPIE.8446E..2CR, Park2014}, but they were excluded from the analysis done here. Triples where the third component is more distant (and well resolved) were retained.

A total of 18 systems were flagged as young, i.e. affiliated with nearby young moving groups or clusters \citep{Shkolnik2012, Kraus2014, Gagne2014, Malo2014a, Gagne2015, 2017AJ....153...95R, 2017AJ....154...69S, Rizzuto2017, 2018MNRAS.475.2955L}. We monitored these targets even after flagging them as young, but they were not included in the analysis for this paper. Many of these are likely pre-main-sequence stars and hence will not follow the same mass-luminosity relation. Even for those that are on the main-sequence, young M dwarfs may have higher luminosities for a given mass due to effects of activity and spots \citep[e.g.,][]{2015ApJ...807....3K,Stassun2012,Somers2017}. These young systems will be the subject of a future study into the effects of age and activity on the parameters of M dwarfs. We note that this cut did not remove any young stars in the field population.

After the completion of our observing program, we removed targets for which we had $<$30\% of the orbit or fewer than six independent measurements. We attempted to fit orbits of the remaining 75 systems (Section~\ref{sec:orbit}). Seven of the orbits fits failed to converge, mostly because their semi-major axes were much larger than expected (e.g., eccentric systems caught near periapsis). An additional 16 were removed because the derived mass for the system was too imprecise ($>$20\% errors on $M_{tot}$) to be useful. Most of these 16 were systems with a poor or no parallax measurement. This left us with 52 binaries (106 stars).

We added in seven targets with orbits from \citet{Dupuy2017}, primarily to fill in the sample around the end of the M dwarf sequence. These seven were selected because they are theoretically massive enough to sustain hydrogen fusion and satisfy all our other selection criteria. Systems from \citet{Dupuy2017} also had their orbits fit using a nearly identical method to our own, often using similar or identical sources of data and analysis methods (primarily Keck/NIRC2). Two addition systems in \citet{Dupuy2017} matched our initial cut, but were still omitted from this analysis. These were LP415-20, which \citet{Dupuy2017} argue is an unresolved triple, and 2M1847+55, which has a relatively imprecise orbit compared to the rest of the sample.

Parameters of the final 59 systems included in our analysis are given in Table~\ref{tab:sample}.

\section{Observations and Data Reduction}\label{sec:obs} 

\subsection{Near-infrared Spectra with IRTF/SpeX}

To estimate the metallicities of our targets we obtained near-infrared spectra for 56 of 59 targets using the SpeX spectrograph \citep{Rayner2003} on the NASA Infrared Telescope Facility (IRTF) atop Maunakea. Observations were taken between May 2011 and November 2017. Most data were taken as part of programs to characterize the fundamental properties of nearby M dwarfs \citep[e.g.,][]{Mann2013c,Gaidos2014,Terrien2015}. All spectra were taken in SXD mode, providing simultaneous wavelength coverage from 0.9 to 2.5$\mu$m. For 56 of the targets, observations were taking using the 0.3$\times15\arcsec$ slit, which yielded a resolution of $R\simeq2000$. Spectra for two targets were taken from \citet{2009ApJ...706..328D}, \citet{Dupuy2012}, or \citet{Dupuy2017}, using the 0.5$\times15\arcsec$ or 0.8$\times15\arcsec$ slits, which gave spectral resolutions of $\simeq$750-1500. 

For Gl 65 and HD 239960 the SpeX slit was aligned to get spectra of both targets simultaneously. For all other targets the binary was unresolved or too poorly resolved to separate in the reduction procedure, and instead the slit was aligned with the parallactic angle. Each target was nodded between two positions along the slit to remove  sky background. Depending on the target brightness and conditions, between 6 and 30 individual exposures were taken following this nodding pattern, with exposure times varying from 8s to 180s. An A0V-type star was observed immediately before or after each target to measure (and remove) telluric lines and flux calibrate the spectrum. The final stacked spectra had S/N of $>100$ per resolving element in the $K$-band for all but the four faintest targets (which had S/N$>50$). 

Basic data reduction was performed with {\tt SpeXTool} package \citep{Cushing2004}. This included flat fielding, sky subtraction, extraction of the one-dimensional spectrum, wavelength calibration, stacking of individual exposures, and merging of separate orders. Telluric lines were removed and the spectrum was flux calibrated using the A0V star observations and the \textit{xtellcor} software package \citep{Vacca2003}. When possible, the same A0V star was used for multiple targets taken near each other in time. 

Two of the three targets lacking SpeX spectra are too warm (earlier than K5) to derive a metallicity from NIR spectra (Gl 792.1 and Gl 765.2), and the third (Gl 54) is too far south to be observed with IRTF. 

\subsection{Adaptive Optics Imaging and Masking}\label{sec:ao}

We analyzed a mix of AO data from our own program with Keck/NIRC2 and archival imaging from the Keck II Telescope, the Canada France Hawaii Telescope (CFHT), the Very Large Telescope (VLT), and the Gemini North Telescope. In general we analyzed all usable images (e.g., non saturated, components resolved) regardless of observing mode and filter. 

For our analysis, we considered a single dataset a collection of observations with a unique combination of filter, target, and epoch. Each combined dataset consisted of a $\Delta m$ (for a given filter), separation, and position angle. 

We separate the observations and reduction by instrument/telescope below. The full list of astrometry and contrast measurements is given in Table~\ref{tab:astrom}, sorted by target and date. 

\subsubsection{Keck II/NIRC2 Imaging and Masking}

As part of a long-term monitoring program with Keck II atop Maunakea, between June 2015 and November 2017 we observed 49 of the 52 multiple-star systems fit in this paper. All observations were taken using the facility AO imager NIRC2 in the vertical angle mode (fixed angle relative to elevation axis) and the narrow camera ($\approx$10\,mas\,pixel$^{-1}$). Depending on target brightness and observing conditions, images were usually obtained through either the $K'$ ($\lambda_c=2.124$\um) or narrow $K_{\rm{cont}}$ ($\lambda_c=2.2706$\um) filters, and non-redundant aperture masking (NRM) was always taken using the 9-hole mask and $K'$ filter. After acquiring the target and allowing the AO loops to close, we took four to 10 images or 6-8 interferograms, adjusting coadds and integration time based on the brightness of the target. As most of our targets are bright, observations were usually taken using the Natural Guide Star (NGS) system \citep{2000PASP..112..315W,2004ApOpt..43.5458V}, only utilizing the Laser Guide Star (LGS) mode for the faintest ($R\gtrsim13$) targets or in poor conditions. In total, our observations provided 154 datasets.

In addition to our own data, we downloaded images from the Keck Observatory Archive (KOA), spanning March 2002 to November 2015, all of which were taken with the NIRC2 imager. Archival data comprised a wide range of observing modes, filters, and cameras, although the majority was taken with the narrow camera and either the $H$- or $K$-band filter. We included nearly all data with clear detections of both binary components independent of the observing setup. We discarded saturated images, those taken with the coronagraph for either of the component stars, and those with extremely poor AO correction. A total of 36 datasets were used from the archive. 

The same data reduction was applied to observations both from our own program and from the archive, following our custom procedure described in \citet{Kraus2016a}. To briefly summarize, we corrected for pixel value nonlinearity in each frame then dark- and flat-corrected it using calibrations taken the same night. In cases where no appropriate darks or flats were taken in the same night, we use a set from the nearest available night. We interpolated over ``dead'' and ``hot'' pixels, which were identified from superflats and superdarks built from data spanning 2006 to 2016. Because flats are rarely taken in narrowband filters, we used superflats built from the nearest (in wavelength) broadband filter where appropriate (e.g., for $K_{\rm{cont}}$ we used $K'$ flats). Pixels with flux levels $>10\sigma$ above the median of the eight adjacent pixels (primarily cosmic rays) were replaced with the median (average of the 4th and 5th ranked). Images were visually inspected as part of identifying the binary location, and a handful ($<$1\%) of images were negatively impacted by our cosmic ray removal (e.g., removal of part of the source). These images were manually corrected.


\subsubsection{CFHT/PUEO Imaging}

We obtained data for 31 of our targets from the Canadian Astronomy Data Centre archive, taken with the 3.6m Canada-France-Hawaii Telescope (CFHT) using the Adaptive Optics Bonnette \citep[AOB, often referred to as PUEO after the Hawaiian owl,][]{1994SPIE.2201..833A} and the KIR infrared camera \citep{1998SPIE.3354..760D}. After removing bad observations (e.g., saturated, unresolved, or poor AO correction), a total of 226 datasets were included. Observations spanned December 1997 to January 2007, covering most of the time PUEO was in use at CFHT (1996 to 2011). Most observations were taken in a few-year period from 2000 to 2003. Observations spanned a range of filters across $JHK$ bands, but the majority used either the narrowband [Br$\gamma$] or [FeII] filters. All observations used a 3-5 point dither pattern and took at least two images at each dither location. 

Data reduction for PUEO observations followed the same basic steps as our NIRC2 data. We first applied flat-fielding and dark correction using a set of superflats and superdarks built by splitting the datasets into 6 month blocks and combining calibration data within the same time period. We identified bad pixels by median filtering stacks of science images taken of dozens of objects, which were then replaced with the median of the eight surrounding pixels. To identify cosmic rays, we median-filtered consecutive images of each target (at a fixed location), then compared the stack to individual images. Pixels $>10\sigma$ above the robust mean of the stacks are replaced with the median of the eight surrounding points. Because PUEO/KIR data were taken in sets of $>$5 images before the object was dithered, this median-filtering was effective for removing nearly all cosmic rays.


\subsubsection{VLT/NaCo Imaging}

We downloaded AO-corrected images from the ESO archive taken with the Nasmyth Adaptive Optics System Near-Infrared Imager and Spectrograph (NAOS-CONICA, or NaCo) instrument on VLT. Data spanned November 2001 to October 2016, with about half of these 70 datasets taken from 2001 to 2005. Based on the program abstracts, $\lesssim$1/2 of the observations were meant to use these binaries as astrometric or photometric calibration (e.g., science case is unrelated to M dwarfs or binaries). Data covered 20 of our targets, excluding saturated or otherwise unusable data. Observations were taken with a wide range of filters, cameras, and observing patterns, but the majority were taken using the S13 camera ($\approx$13\,mas\,pixel$^{-1}$) with either broadband $K_s$ and $L$, or narrowband [FeII] and [Br$\gamma$] filters, and always following a 2-4 point dither pattern. 

Basic data reduction was applied to NaCo images following a similar procedure with the PUEO and NIRC2 data. We applied flat-fielding and dark corrections to each observation using the standard set of calibrations taken each night as part of the VLT queue. In the case where calibration (dark or flat) images were missing or unusable, we used the nearest (in time) set of calibration images matching the filter (for flats) and exposure setup (for darks). Flats taken in broadband filters were used for flat-fielding narrow-band images at similar wavelengths. We built bad pixel masks using median stacks of all images taken within a night after applying flat and dark corrections. To identify and remove cosmic rays we used the L.A. Cosmic software \citep{2001PASP..113.1420V}.


\subsubsection{Gemini/NIRI Imaging}

We retrieved 39 datasets for 8 of our targets from the Gemini archive, all taken with the AO imager NIRI \citep{2003PASP..115.1388H} on the Gemini North Telescope. All observations were taken between August 2008 and February 2011 and were taken with the assistance of the ALTtitude conjugate Adaptive optics for the InfraRed (ALTAIR). Most observations were taken with the f32 camera ($\approx$21\,mas\,pixel$^{-1}$) using broadband $J$-, $H$-, or $K$-band filters. All observations followed a 2-4 point dither pattern and took at least two images at each dither location. 

Data from NIRI were reduced using the same basic methods as for all other adaptive optics data. First, we applied flat and dark corrections to each set of images using the standard calibration images taken as part of the Gemini queue, usually within 24h of the target observations. In most cases, flats taken in broadband filters were used for narrowband flat-fielding. We then identified bad pixels from median filtering of all images within a given night. Observations with a target near or on top of a heavily impacted pixel (identified with the mask) were discarded. We used the L.A. Cosmic software for the identification and removal of cosmic rays. 

\section{Astrometry and photometry}\label{sec:astrometry}

Extracting separations and position angle measurements followed a similar multi-step procedure across all instruments, excluding the NRM data (which is described below). Our method is based largely on that described in \citet{2016ApJ...817...80D} and \citet{Dupuy2017}, which is built on the techniques from \citet{2008ApJ...689..436L} and \citet{2010ApJ...721.1725D} and we briefly describe here. 

We first cross-correlated each image with a model Gaussian PSF to identify the most significant peaks. The cross-correlation peak occasionally centers on instrumental artifacts, often struggles to separate out partially overlapping binaries, and can easily identify the wrong source for triple systems. So this step was checked by eye and updated as needed. The eye-check phase also allowed us to manually remove data of poor quality: e.g., no or poor AO correction, saturated data, or an unresolved system. We used these centers as the initial guess for the $x, y$ pixel position used in the next phase. 

We then fit the PSF centers by either: 1) fitting the binary image with a PSF modeled by three-component elliptical 2D Gaussians using the least-squares minimization routine MPFIT \citep{Markwart2009}, or 2) running {\tt StarFinder}, a routine designed to measure astrometry and photometry from adaptive optics data by deriving a PSF template from the image and iteratively fitting this model to the components \citep[for more details, see][]{2000A&AS..147..335D}. Although the results of these two methods generally agreed, {\tt StarFinder} was preferred, as it used a non-parametric and more realistic model of the PSF and worked even with mediocre AO correction, provided the component PSFs were well separated. {\tt StarFinder}, however, failed on the tightest binaries, where it was unable to distinguish two stars and thus incorrectly built a pathological, extended PSF that fit the blended image. The Gaussian fit was used for these cases where {\tt StarFinder} failed. 

As part of the PSF fit, both methods provide a flux ratio of the PSF normalization factors, which we used this to determine the contrast $\Delta m$ in the relevant band. Data from all filters are used for astrometry, although only $\Delta K$ measurements were used in the estimate of \mks\ (see Section~\ref{sec:mags}).

PSF fitting provides pixel-position ($x$, $y$) measurements of each component, but converting these to separation ($\rho$) and position angle (PA) on the sky requires an astrometric calibration of the instrument. For the NIRC2 narrow camera, we used the \citet{Yelda2010} distortion solution for data taken before 2015 Apr 13 UT, and \citet{2016PASP..128i5004S} for data taken after this. These calibrations include a pixel scale and orientation determination of 9.952$\pm$0.002 mas\,pixel$^{-1}$ and $0.252\pm0.009\,deg$ for the former, and 9.971$\pm$0.004 mas\,pixel$^{-1}$ and $0.262\pm0.020\,deg$ for the latter. For the NIRC2 wide camera we used the solution from Fu et al. (2012, priv. comm.)\footnote{\href{http://homepage.physics.uiowa.edu/~haifu/idl/nirc2wide/}{http://homepage.physics.uiowa.edu/$\sim$haifu/idl/nirc2wide/}}, with a pixel scale of $39.686\pm0.008$ mas\,pixel$^{-1}$ and the same orientation as the narrow camera. For the f/32 camera on NIRI, we used the distortion solution from the Gemini webpage\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/undistort.pro}{http://www.gemini.edu/sciops/instruments/niri/undistort.pro}}. 

For other instruments and cameras, data were always taken following a dither pattern to sample different regions of the CCD distortion pattern. So the RMS between dithered images should reflect errors due to uncorrected distortion (which is included in our errors; see below). For KIR, we adopted a pixel scale of 34.8$\pm$0.1 mas pixel$^{-1}$ \citep{2003ApJ...589..410S} and an orientation of $0\pm2$~deg\footnote{\href{http://www.cfht.hawaii.edu/Instruments/Detectors/IR/KIR/}{KIR specifications, filters, and performance.}}. For NaCo, we assumed a pixel scale of 13.24$\pm0.05$ mas pixel$^{-1}$ for the S13 camera \citep{2003A&A...411..157M,2005A&A...435L..13N} and the values given in the ESO documentation for all others\footnote{\href{http://www.eso.org/sci/facilities/paranal/instruments/naco/doc.html}{NaCo Documentation, user manual, calibration, and reduction.}} (with the same error). The rotation taken from the NaCo headers was assumed to be correct to 0.4~deg. \citep{Sef2008}. For NIRI observations, we used a pixel scale provided in the Gemini documentation\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/imaging/pixel-scales-fov-and-field-orientation}{NIRI pixel scales, field of view, and field orientation.}} for each camera (117.1, 49.9, and 21.9 mas pixel$^{-1}$ for f/6, f/14, and f/32, respectively), with a global uncertainty of 0.05 mas pixel$^{-1}$ on the pixel scale and 0.7~deg. on the orientation. The NIRI orientation error was determined using observations of the same target between observing runs (separated by weeks to months), but over which no orbital motion should have been visible ($P\gg50$ years). 

Calculation of separations and position angles from of non-redundant masking (NRM) observations followed the procedures in the appendix of \citet{Kraus2008} with the aid of the latest version of the ``Sydney'' aperture-masking interferometry code\footnote{\href{https://github.com/mikeireland/idlnrm}{https://github.com/mikeireland/idlnrm}}. To remove systematics, each NRM observation of a science star was paired with that of a single calibrator star taken in the same night with a similar magnitude and airmass. Binary system profiles were then fit to the closure phases to produce estimates of the separation, position angle, and contrast of the binary components. More details on the analysis of masking data can be found in \citet{2006ApJ...650L.131L}, \citet{Kraus2008} and \citet{2012ApJ...744..120E}.

All data in a single set (same target, filter, and night) were combined into a single measurement (after applying all corrections above), with errors estimated using the RMS in the individual images within a night. This scatter across images was combined with the uncertainty in the orientation and pixel scale in quadrature. We assumed that the pixel scale and orientation uncertainties were completely correlated within a night and filter so they do not decrease with $\sqrt{N}$. 

We also corrected separation and position angle for differential atmospheric refraction \citep{2010SPIE.7736E..1IL} using filter wavelength information and weather data from the header (for VLT) or from the CFHT weather archive\footnote{\href{http://mkwc.ifa.hawaii.edu/archive/wx/cfht/}{CFHT weather archive.}} (for Keck, CFHT, and Gemini). We neglected the chromatic component of this effect as the correction is already small compared to measurement errors. 


\subsection{Literature Astrometry}\label{sec:litas}

We included  measurements from the literature for 50 of the 52 binaries in our sample for which we analyzed astrometry. To help identify sources of astrometry, we used the fourth catalog of interferometric observations of binary stars \citep[INT4,][]{Hartkopf:2001}. We only used measurements that included both a separation and position angle. In cases where the literature data was also available in one of the archives above (i.e., the same dataset used in the reference), we adopted our own measurements over the literature data to ensure more homogeneous measurements and errors. We did not utilize $\Delta m$ measurements from the literature, although in some cases this information was used to verify the astrometry was for the correct binary system or component.  

In total, we used 558 measurements (each including a separation and position angle) from 60 references. The literature astrometry was very non-uniform; roughly half of the points were for just 11 targets, predominately taken with the goal of measuring their orbits. Approximately 180 measurements came from speckle observations on the Special Astrophysical Observatory (SAO) 6m \citep[e.g.,][]{Bag2002}, WIYN \citep[e.g.,][]{Hor2017}, or SOAR \citep[][]{Tok2017b} telescopes. About 160 points came from {\it HST}, primarily Fine Guidance Sensors measurements  of $\sim$10 binaries \citep[e.g.,][]{Benedict2016}. The rest of the measurements are from a mix of surveys focusing on taking many epochs of specific systems to determine orbits \citep[e.g.,][]{Koh2012} and broader surveys (e.g., for multiplicity) that obtain 1-2 epochs on each of dozens of binaries \citep[e.g.,][]{Janson2012}.  

One complication using older literature astrometry is inhomogeneous reporting of separation and position angle errors. Many references provided measurements without errors, and many more reported errors without accounting for field distortion or errors in the pixel scale and orientation. We mitigated this problem by generating an error common to a given reference. For each literature source, we identified a set of binaries where an orbit can be fit (with $<$5\% errors on the angular separation) without astrometry from that particular reference. Some literature sources were merged for this comparison, provided they used the same instrument and basic analysis. We included binaries outside the sample considered here. We fit the orbit following the method outlined in Section~\ref{sec:orbit}, using only the least-squares method for efficiency. We then compared the expected position angle and separation to the measurements from the reference in question. From this difference we computed the required missing error term, which, when added in quadrature with the reported errors (zero for those without errors) would yield a reduced $\chi^2$ ($\chi^2_\nu$) of 1. References where we could not test the reported errors (e.g., due to insufficient data) and those with extremely large aded error terms ($>$50\,mas) were not used. This term was added in quadrature with literature reported uncertainties (if any were reported). 

All literature astrometry used in this paper is listed alongside our own measurements in Table~\ref{tab:astrom}. 

\subsection{Summary of input astrometry}

In total we measured or gathered 1083 unique datasets (unique filter/night/target combinations), approximately half of which we measured from adaptive optics images (525) and the other half were drawn from the literature (558). Most of the astrometry measurements derived from our analysis came from either NIRC2 (190) or PUEO (226), with a smaller contribution from NaCo (70) and NIRI (39). 

Although they represent only $\simeq$20\% of the total astrometric measurements, the NIRC2 measurements are the most critical in constraining orbital parameters. NIRC2 astrometry was 1-2 orders of magnitude more precise than those from the literature, and a factor of 3-8$\times$ more precise than those from PUEO, NIRI, and NaCo. We characterized the relative importance of each data source using the total number of unique separation measurements weighted by their uncertainties. Under this metric, the NIRC2 points contributed $\gtrsim10\times$ more orbital information than the literature data. Measurements from CFHT/PUEO had a comparable total contribution to the literature data, each of which had $\simeq2\times$ the impact of NaCo measurements, and $\simeq3\times$ that of data from NIRI. This comparison likely underestimated the importance of the NIRC2 data; literature and archive images tended to be concentrated on the best-characterized systems, while our NIRC2 observations were specifically coordinated to complete orbits and cover under- or un-sampled regions of binary orbits. However, the combination of NIRC2 and literature and/or PUEO points is the most useful, since this provides both the precision and long baseline (PUEO and NIRC2 data is typically separated by $>15$\,years) needed to fully constrain the orbital parameters.

\section{Orbit Fitting}\label{sec:orbit}

We fit the astrometry with the Monte Carlo Markov Chain (MCMC) software {\tt emcee} \citep{Foreman-Mackey2013}, a Python implementation of the affine-invariant ensemble sampler \citep{goodman2010}. For each system, we explored seven orbital elements: the orbital period ($P$), combined angular semi-major axis ($a\arcsec$), eccentricity ($e$), inclination ($i$), epoch of periastron passage ($T_0$), argument of periastron ($\omega$), and position angle of the line of nodes ($\Omega$). Parameters were limited by physical or definitional constraints, e.g., $P>0$, $0<e<1$, and $0<i<\pi$, but were given no additional boundaries. 

We applied non-uniform priors of 1/$P$, 1/$a\arcsec$, and $\sin(i)$ to $P$, $a\arcsec$, and $i$, respectively. All other parameters evolved under uniform priors. Walkers were initialized with the best-fit orbit determined using \textit{MPFIT} \citep{Markwart2009} and a spread in starting values based on the \textit{MPFIT} estimated errors. Each MCMC chain was initially run for $10^5$ steps with 100 walkers. We tested to see if a chain converged using the autocorrelation time \citep{2010CAMCS...5...65G} and chains were checked by eye for signs on convergence. In about 1/4 of the systems the fit did not converge after the initial $10^5$ steps, so we ran these for $10^6$ total steps. Those that did not converge after $10^6$ steps were not included in our final sample. These were not included in our final sample of 59 binaries (see Section~\ref{sec:targets}), as these were the least-well characterized systems. We saved every 100 steps in the chain, and the first 5\% of each chain was removed for burn-in. 

Systems of near-equal mass may have the primary and companion confused, both in our own measurements and also those taken from the literature. We identified such measurements by eye during the \textit{MPFIT} stage and manually adjusted the position angles before starting the MCMC run. In total $\simeq$16 measurements were corrected this way, almost all of which were for three systems with contrast ratios close to unity. A more robust solution to this problem would be to feed a double-peaked prior at the reported value and $\pm$180~deg. into the likelihood function. However, in all cases the problematic points were obvious by eye, had reported $\Delta m$ consistent with zero, and a simple 180~deg correction completely fixed the orbit. 


\begin{figure*}[htb]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl301BAB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl469AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3454AB.eps}
\caption{Example results of our orbit fitting procedure for Gl 301AB (left), Gl 469AB (middle), and GJ 3454AB (right). Points are individual measurements of the separation and position angle, color-coded by the astrometry source. Black solid line shows the best-fit (highest likelihood). Dark grey lines are drawn by randomly sampling 50 orbit fits from the MCMC chain to display an estimate of the errors. The dotted line connects periastron passage, with an arrow pointing in the orbital direction, and the dashed-line showing the line of nodes. For Gl469AB, high-quality astrometry is available for the full orbit, and the resulting errors on orbital parameters are so small that the grey lines cannot be seen. All orbits are shown in Appendix~\ref{sec:a1}.}
\label{fig:orbits}
\end{center}
\end{figure*}

Overall the quality of the fits is extremely good, with $\chi^2_\nu$ values ranging from 0.1 to 2, and cumulative distribution values (the probability of getting the $\chi^2$ or smaller given the degrees of freedom) ranging from 2\% to 99\% (mean probability of 47\%). We show some example orbital fits in Figure~\ref{fig:orbits} (with the full set in Appendix~\ref{sec:orbitplots}) and provide the median orbital parameters in Table~\ref{tab:orbits}. Orbits span a wide range in period; the tightest binaries have $P<1$\,yr, while the widest have $P>50$\,yr. The two systems with $P>50$\,yr (Gl 301 and Gl 277) were also some of the least-well characterized. No systems show evidence of period-doubling due to limited sampling, an advantage of using data with non-uniform temporal sampling.

Our orbital fits made heavy use of literature astrometry, many of which had no reported errors. Our method for assigning or correcting errors assumed that all measurements have a common missing error term per source (Section~\ref{sec:litas}). It is more likely that errors depend on the separation and contrast ratio, as well as quantities that were not consistently reported, like weather, setup, and observational strategy. Further, this technique assumed an uncorrelated error term. In the case of an erroneous pixel scale or imperfectly aligned instrument, all measurements from a common instrument err in the same sense.   In practice, it is difficult to correct for these effects without access to the actual images. The data suggest this does not impact our results; the final $\chi^2_\nu$ values for the best-fit orbits shows no correlation with the fraction of astrometry from the literature versus our own measurements, and measurements taken on the same target and night but from different sources agree within errors. 

As an additional test, we tried refitting six binaries with the most literature data twice, first doubling the error term added to the literature points, then halving it. In all cases, overall parameters and errors did not change significantly (although the final $\chi^2_\nu$ values changed). The main reason for this is that our new measurements are generally far more more precise (with the exception of measurements from {\it HST}) and hence dictate the final solution, even in cases where most of the individual measurements are from the literature. In the case of halving errors, the MCMC landed on a similar solution, but with smaller parameter uncertainties and increased $\chi^2$ values. We conclude this treatment of errors does not significantly impact our final orbital fits and that our assigned errors are reasonable overall.

\section{Stellar Parameters}\label{sec:params}

\subsection{Parallaxes}\label{sec:plx}

Parallaxes for 56 of the 59 systems were drawn from the literature. In general we adopted the most precise parallax available, although preference was given to those accounting for centroid motion of the binary and those with a baseline significantly different from the binary's orbital period. A few systems are in hierarchical triples with a wider companion that has a separate (mostly independent) parallax measurement, which we used where possible. For $\simeq$1/3 of the sample, we drew parallaxes from the new reduction of the Hipparcos data \citep{van-Leeuwen:2007yq}. For the seven systems in \citet{Dupuy2017}, we used their parallaxes, and those from \citet{Benedict2016} for 13 systems in both samples. For nine systems we pulled parallaxes from the general catalogue of trigonometric parallaxes \citep{van-Altena1995}. 

About half (28) of our targets do not have entries in the second data release of Gaia \citep[DR2, ][]{GaiaDr2,2018arXiv180409365G}. They were likely excluded because centroid shifts from orbital motion prevented a five-parameter (single-star) solution (a requirement to be included in DR2). We also found significant differences between the Gaia DR2 values and earlier measurements \citep[including from Gaia DR1, ][]{gaiadr1} even when measurements were available. Many wide triples in Gaia DR2 (where the third star is several arc seconds away, and hence easily resolved) have significantly different parallaxes reported for the unresolved pair than for the wider companion. Orbital motion is likely impacting the parallax values or uncertainties, an issue that should be resolved in future Gaia data releases that will include fits for orbital motion. We found no such issues with our other parallax sources. So we decided to not use Gaia DR2 parallaxes in most cases. 

We ultimately adopted Gaia DR2 parallaxes for three systems, GJ1245AC, GJ277AC, and GJ4287AB, where we adopted the parallax of their wider common proper motion companion. In all cases the wider associated stars are not known to harbor another unresolved star, and hence they should not be impacted by the same binarity issue. GJ 570BC, Gl 695BC, GJ 2005BC, Gl 22AC, and 2M1047+40 also have nearby associated stars. However, Gl 570A is extremely bright ($G\simeq5$) and hence may have an unreliable parallax due to saturation in DR2, GJ 2005A has no entries in Gaia DR2, the available parallaxes (from {\it HST} and Hipparcos) for Gl 695BC and Gl 22AC are similar or more precise than the those reported for Gl 695A and Gl 22B from Gaia DR2, and the wide pair to 2M1047+40 is itself a tight binary \citep[LP 213-67AB,][]{Dupuy2017} with a large reported excess astrometric noise in Gaia \citep[a sign of binarity,][]{2018RNAAS...2...20E}.

For three systems we derived new parallaxes using MEarth astrometry \citep{Nutzman:2008gf}. Updated parallaxes were measured following the procedure from \citet{2014ApJ...784..156D}. The only difference was we used a dataset with a baseline $\simeq$two years longer, which helps average out systematic errors arising from centroid motion due to the binary orbit, and significantly reduces the overall uncertainties. 

We list all parallaxes and references in Table~\ref{tab:sample}.

\subsection{Metallicity}\label{sec:feh}

We estimated [Fe/H] using our SpeX spectra and the empirical relations from \citet{Mann2013a} for K5-M6 dwarfs, and \citet{Mann2014} for M6-M9 dwarfs. These relations use a series of atomic lines (primarily Na, Ca, and K features) in the optical or NIR \citep[e.g.,][]{2010ApJ...720L.113R,Terrien:2012lr}, empirically calibrated using wide binaries containing a solar-type primary and an M-dwarf companion \citep[e.g.,][]{2005A&A...442..635B,Johnson2009,Neves2012}. The calibrations were based on the assumption that components of such binaries have similar or identical metallicities \citep[e.g.,][]{2015ApJ...801L..10T}. Similar methods have been used extensively to assign metallicities across the M dwarf sequence \citep[e.g.,][]{Terrien2015,Muirhead2015,Dressing2017,2018ApJ...853...30V,2018ApJ...854..145M}. Final adopted [Fe/H] values are given in Table~\ref{tab:sample}. Errors account for Poisson noise in the spectrum, but because of the relatively high SNR of the spectra, final errors on [Fe/H] are generally dominated by the uncertainties in the calibration itself, conservatively estimated to be 0.08~dex \citep{Mann2013a,Mann2014}.

For all but two systems (Gl 65 and HD 239960), our NIR spectra are for the combined flux of the binary components. \citet{Mann2014} explored the issue of measuring metallicities of binaries with unresolved data by combining spectra of single-stars with equal metallicities and re-applying the same calibration. The bias introduced is negligible ($\lesssim0.02$~dex) when compared to overall uncertainties. The added scatter is smaller than the measurement uncertainties, and can be almost entirely explained entirely by the Poisson noise introduced in the addition of component spectra. This may be more complicated for nearly or marginally resolved systems, where the narrow slit (0.3\arcsec) is preferentially including light from one star. However, repeating the tests of \citet{Mann2014} and adding a random flux weighting to the fainter star produced a small change to the increased uncertainties (0.01-0.03\,dex).

Three systems (LP415-20, 2M2140+16, and 2M2206-20) have SpeX spectra taken with a wider slit, yielding lower spectral resolution. The bands in \citet{Mann2014} are defined using a homogeneous dataset taken with the narrow (0.3\arcsec) slit, so this difference may impact the derived [Fe/H]. We tested this by convolving a set of single-star SpeX spectra taken with the 0.3\arcsec\ slit with a Gaussian to put them at the appropriate lower resolution. The median of the derived [Fe/H] values changed by $<0.01$~dex, but the change varies between targets. Based on the resulting scatter, we estimate the errors on [Fe/H] from the lower-resolution spectra to be 0.12~dex on a Solar scale and 0.08~dex on a relative scale. These systems are marked separately in Table~\ref{tab:sample}. 

Two of the systems in our sample are L dwarfs (2M0746+20 and 2M1017+13). These are most likely above the hydrogen burning limit, and hence are included in our analysis. However, the \citet{Mann2014} method contains no L dwarf calibrators. We report our derived [Fe/H] values for these systems, but advise treating the assigned values with skepticism until an L dwarf calibration becomes available. 

Two targets (Gl 792.1 and Gl 765.2) are too warm (earlier than K5) for the calibration of \citet{Mann2013a}. For these we take [Fe/H] values from \citet{2011A&A...530A.138C} and \citet{2010A&ARv..18...67T}, respectively. These [Fe/H] measurements are not necessarily on the same scale as those from \citet{Mann2013a}, which are calibrated against abundances of Sun-like stars from \citet{2015ApJ...805..126B,2016ApJS..225...32B}. Given reported variations in [Fe/H] for these stars, as well as [Fe/H] determination differences \citep{2014AJ....148...54H,2016ApJS..226....4H} we adopt conservative 0.08~dex uncertainties on both systems. For the other target lacking a SpeX spectrum (Gl 54), we derive [Fe/H] using the optical calibration of \citet{Mann2013a} and a moderate-resolution optical spectrum taken from \citet{Gaidos2014}.

\subsection{$K_S$-magnitudes} \label{sec:mags}

We adopted unresolved $K_S$ magnitudes from the Two Micron All Sky Survey \citep[2MASS,][]{Skrutskie2006}. Some of the brightest stars in our sample are near or beyond saturation in 2MASS. For these targets we recalculated $K_S$ magnitudes using available optical and NIR spectra, following the method of \citet{Mann2015a} and \citet{Mann2015b}, using available optical spectra from \citet{Gaidos2014}. Synthetic magnitudes were broadly consistent with 2MASS $K_S$ magnitudes (and at similar precision) for fainter targets ($K_S>7$). We only updated $K_S$ magnitudes for bright systems where where our synthetic photometry differed from the 2MASS value by more than 2$\sigma$ (five systems). We mark these systems in Table~\ref{tab:sample}. 

While all targets considered here had at least one measurement in a filter centered with the $K$ band, none of the response functions used was a close match to 2MASS $K_S$. Many of the observations were taken with narrow-band $K_{\rm{cont}}$ ($\lambda_c\simeq2.27$\um) or Br$\gamma$ ($\lambda_c\simeq2.17$\um) filters (to avoid saturation), for example. We transformed these into 2MASS magnitudes before computing the final $\Delta K_S$. These corrections were usually small ($\lesssim0.1$ magnitudes), and details on their derivation are given in Appendix~\ref{sec:a1}.

To compute $\Delta K_S$, we calculated the robust weighted mean of contrast ratios derived from our AO data (Section~\ref{sec:astrometry}). For $\Delta K_S$, we used all data centered somewhere within the $K$ band. Errors on contrasts for a given dataset were taken to be the RMS in flux measurements among consecutive images. The errors may be underestimated because of imperfect PSF modeling, flat-fielding, uncorrected non-linearities in the detector, as well as intrinsic variability of the star. We compared $\Delta K_X$ measurements of the same star using the same filter and instrument but on different nights (Figure~\ref{fig:magnitudes}). The comparison suggested a missing error term of 0.016\,magnitudes for NIRC2, 0.02 for PUEO and NaCo, and 0.03 for NIRI. We only tested this for $K$-band filters, but we found consistent values for different $K$-band filters from the same instrument. We included this term as an additional error term in our computation of $\Delta K_S$.

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{errors.eps}
\caption{Distribution of contrast ratio differences (in units of standard deviations) for data taken on the same target but in different nights. The red line is before adding the missing error term, while the blue line shows the distribution after adding this. The grey dashed line shows the expected Normal distribution. The histograms are offset slightly for clarity, although identical bins are used as input.}
\label{fig:magnitudes}
\end{center}
\end{figure}

%We did not use literature contrast ratios (even those in $K$-band), as we cannot perform and the same corrections applied to those from our own analysis. The exception was Gl 762.1, for which we have no AO data. For this target we adopt the value from \citet{CIA2010}.

For GJ 2005BC and Gl 900BC, the 2MASS PSF includes flux from the A component. In both cases we use our AO data to measure $\Delta K$ between all three components. The total $K_S$ magnitude given in Table~\ref{tab:sample} already have the A component removed. 

\section{The Mass-Luminosity Relation}\label{sec:relation}

\subsection{Methodology}

For main-sequence stars, the mass-luminosity relation traditionally takes the form:
\begin{equation}\label{eqn:ml}
\frac{L_*}{L_\odot} = C \left(\frac{M_*}{M_\odot}\right)^\alpha,
\end{equation}
where $\alpha$ depends on the dominant energy transport mechanism (e.g., radiative versus convective) and internal structure of the star \citep{2004sipp.book.....H}. 

We rewrite Equation~\ref{eqn:ml} in terms of \mks\ (and $\log(M_*/M_\odot)$) instead of $L_*$. Absolute magnitudes are more easily measured than overall luminosity, and avoid introducing errors from uncertain bolometric corrections or the need to take flux-calibrated spectra in order to measure the bolometric flux directly. Switching to \mks\ also mitigates effects of abundances. The $K$-band is heavily dominated by metal-insensitive CO and H$_2$O absorption bands. Optical bands are dominated by strong molecular (e.g. TiO, CO, CaH, MgH, and VO) bands that introduce a strong dependence to [Fe/H] and [$\alpha$/Fe] (Figure~\ref{fig:metal}). 

\begin{figure*}[htb]
\begin{center}
\includegraphics[width=\textwidth]{metallicity_effect.eps}
\caption{Effect of changes in [M/H] on a model spectrum at \teff=3200\,K, $\log(g)=5$ in $g$- (left), $r$ (middle), and $K$-band (right). The top panel shows [M/H]=0 (black) and [M/H]=+0.5 (red) spectra from the CFIST BT-SETTL models \citep{2012RSPTA.370.2765A}. The bottom panel shows the ratio of the two, highlighting how small an effect [M/H] has in the $K$-band compared to optical regions. The one feature that stands out in the $K$-band is the Na doublet, which is a commonly used as a metallicity diagnostic for dwarfs \citep{2010ApJ...720L.113R,Terrien:2012lr,Newton:2014}, and a gravity diagnostic for pre-main-sequence stars \citep[e.g.,][]{Schlieder2012}. }
\label{fig:metal}
\end{center}
\end{figure*}

Our sample encompasses almost an order of magnitude in mass and hence a range of underlying stellar physics. No single power law is expected to fit over the full sequence. Instead, we assumed that $\alpha$ depends on \mks, which we approximated as a polynomial. This yields a \mmk\ relation of the form:
\begin{equation}\label{eqn:mmk}
\log \left( \frac{M_*}{M_\odot} \right) = \sum_{i=0}^{n} a_i(M_{K_S}-zp)^i,
\end{equation}
where $a_i$ are the fit coefficients. The number of coefficients ($n$) was determined by testing how the fit improves with increasing $n$. The constant $zp$ is a zero-point (or anchor) magnitude, which we fixed at 7.5. This approximately corresponded to the logarithmic central mass of stars in our sample. 

For the left hand side, we computed the total system mass ($M_{\rm{tot}}$) for each binary by combining the the orbital period ($P$) and total angular semi-major axis ($a\arcsec$) from our fits to the orbital parameters (Section~\ref{sec:orbit}) with the parallaxes ($\pi$, Section~\ref{sec:plx}), following a rewritten form of Kepler's laws:
\begin{equation}\label{eqn:mass}
M_{\rm{tot}} = M_{1}+M_{2} = \frac{(a\arcsec/\pi)^3}{P^2},
\end{equation}
where $P$ is in years, $a\arcsec$ and $\pi$ are in arcseconds, and $M_{\rm{tot}}$ is in Solar masses. 

Because Equation~\ref{eqn:mass} does not provide component masses, when fitting for the $a_i$ coefficients we performed the comparison between the predicted and dynamical {\it total} mass for each system. For this, we rewrote Equation~\ref{eqn:mmk} in terms of total mass:
\begin{eqnarray}\label{eqn:mmk2}
M_{tot} &=& 10^{b_1} + 10^{b_2},\\
b_j &=& \sum_{i=0}^{n} a_i(M_{K_S,j}-zp)^i, \label{eqn:mmk2_b}
\end{eqnarray}
where \mks$_{,1}$ and \mks$_{,2}$ are the primary and companion absolute $K$-band magnitudes, which were calculated from our measured $\Delta K_S$ and unresolved $K_S$ magnitudes (Section~\ref{sec:mags}). Equation~\ref{eqn:mmk2} could easily be modified for higher-order star systems, providing individual \mks\ magnitudes and the total mass of the system are known. 

We fit for the $a_i$ terms in Equation~\ref{eqn:mmk2} using the MCMC code {\tt emcee}, which accounts for the strong covariance between coefficients. Each coefficient was allowed to evolve under uniform priors without limits, and was initialized with the best-fit value derived from \textit{MPFIT}. We ran the MCMC chain with 600 walkers for $10^6$ steps after a burn-in of 50,000 steps. We ran separate MCMC chains testing values of $n$ (fit order) from three to seven. 

Errors on the dynamical mass are correlated to the errors on \mks. The system mass scales with the cube of the semi-major axis, which depends linearly with the parallax. As a result, the parallax was a major, if not the largest, source of uncertainty on the mass for most systems. Similarly, our $K_S$ magnitudes had relatively small errors (0.01-0.03\,mag), so \mks\ errors tended to be dominated by the parallax. Because this correlation is usually along (parallel to) the direction of the \mmk\ relation, it can tighten the fit if properly taken into account (when compared to assuming uncorrelated errors). 

Our strategy was to treat the distance of each system as a free parameter, letting them evolve under a prior from the observed parallax. The MCMC fit to Equation~\ref{eqn:mmk2} was provided $a\arcsec^3/P^2$ and $K_S$ (with uncertainties) for each system, from which total mass and \mks\ were recomputed from the varying parallax of each system at each step in the MCMC before making a comparison. Since the orbital information provides no constraint on the distance, this effectively forced the MCMC to explore a distribution along the input prior. It is possible for the parallax posterior to shift off this prior if it provides better agreement with the relation as determined by the rest of the sample. However, in practice this does not happen; for all systems the parallax posteriors matched the input values.

For computational efficiency, we assumed Gaussian errors on $a\arcsec^3/P^2$. Although $a\arcsec$ and $P$ were often correlated and non-Gaussian, posteriors of $a\arcsec^3/P^2$ were all well-described by a Gaussian (Figure~\ref{fig:correlated}). 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{LHS6167_corner.eps}
\caption{Example joint posterior on semi-major axis and orbital period (bottom left) for the system LHS 6167. Grey regions show 1, 2, and 3$\sigma$ (from darkest to lightest) of the points. The histograms above and to the right show the one-dimensional distributions of each parameter. The parameter fed into the \mmk\ fit is $a\arcsec^3/P^2$ (in arcsec$^3$ per year$^2$), which we show in the top right inset. }
\label{fig:correlated}
\end{center}
\end{figure}

For main-sequence dwarfs at fixed metallicity, more massive stars should always be brighter. Thus we required that the resulting fit have a negative derivative (higher \mks\ always gives lower mass) over the full range of input objects considered. We tested running without this constraint, and found similar results over most of the parameter range considered. The major difference was near the edges of the input sample. Without the negative derivative constraint, the fit would often become double valued where there were few points to constrain it.

To handle any variation not included in our formalism, we fit for an additional dimensionless parameter $\sigma_e$. This parameter was implemented as a fractional uncertainty in the total mass, added to the measurement uncertainty (from the orbit and parallax errors) in quadrature. $\sigma_e$ can be interpreted as missing physics (e.g., age, detailed abundances, and/or activity/rotation) driving an intrinsic scatter in the \mmk, or as underestimated uncertainties in our input parallaxes or orbital parameters (and hence the final assigned mass). We tested implementing similar missing error terms on the assigned $K$-band magnitudes (in case of stellar variability) or directly on the parallax priors, and found consistent results. We opted to keep $\sigma_e$ as a fractional error on the total mass, which we feel is more physically motivated.

\subsection{Results and Uncertainties}

We show the resulting posteriors for the polynomial coefficients ($a_i$) in Figure~\ref{fig:fitpost}. The spread in the posteriors for individual coefficients is large, suggesting significant errors on each coefficient. However, the coefficients are also highly correlated; for a given value assigned to four of the five fit coefficients, there is a relatively narrow set of solutions for the final constant. The final fit was tightly constrained over the full sequence, which we show in Figure~\ref{fig:relation} for individual masses, and combined masses in Figure~\ref{fig:m_m} (a more realistic representation of how the fit was done). 

\begin{figure*}[p]
\begin{center}
\includegraphics[width=0.9\textwidth]{output_7_eMs.pdf}
\caption{Posterior projections for the $a_i$ values derived from our MCMC fit to Equation~\ref{eqn:mmk2} as well as the additional error term $\sigma_e$. Contours denote the 1, 2, and 3$\sigma$ confidence intervals, and the dashed lines in the histogram mark 1$\sigma$. The $\sigma_e$ parameter represents the fractional error in the total mass, added to account for intrinsic variation in the relation or underestimated uncertainties in the input masses. Figure was generated using {\tt corner.py} \citep{corner}.}
\label{fig:fitpost}
\end{center}
\end{figure*}

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=\textwidth]{MK_mass_0_7_1.eps}
\caption{Absolute $K_S$-band magnitude as a function of mass for targets in our sample (circles). Points are color-coded by their estimated metallicity. We show a typical error ellipse in grey to highlight that errors on mass and \mks\ measurements are correlated, and usually parallel to the $M_*$-\mks\ relation (both depend on the common parallax). The black dashed line indicates the best-fit (highest likelihood) from our MCMC analysis. To provide an estimate of the scatter in the relation as a function of mass, we show 100 randomly selected fits from the MCMC chain in grey. Note that our orbit fits only provide {\it total} mass; we used the mass ratios derived from the best-fit \mmk\ relation for the purposes of this figure. Figure~\ref{fig:m_m} shows the total mass comparison, which is more reflective of how the comparison is done. }
\label{fig:relation}
\end{center}
\end{figure*}

\begin{figure}[ht]
\begin{center}
\includegraphics[width=0.48\textwidth]{Mass_mass_7_0.eps}
\caption{Predicted total (system) $M_*$ from the \mmk\ relation as a function of the total mass determined from the orbit fit. Ellipses represent $\simeq1\sigma$ distribution of values for each point, accounting for parallax errors common to both the predicted and dynamical mass, but not accounting for scatter in the final \mmk\ relation ($\sigma_e$). Color-coding by [Fe/H] matches that of Figure~\ref{fig:relation}.}
\label{fig:m_m}
\end{center}
\end{figure}


Coefficients for powers of the same parity (even or odd) were strongly correlated to each other. This was expected, as a decrease in the slope (from linear) is best explained using an odd power, and increases with an even power. Coefficients for powers with even parity (with the exception of the $a_0$ term) were also generally centered around zero. This also was expected in the context of the shape of the relation seen in Figure~\ref{fig:relation}, and our requirement that the mass always decrease with decreasing luminosity (increasing \mks). A power with even parity will prefer to turn upwards at low masses. We explored this further by redoing the fit with no even powers (except $a_0$ was retained), but exploring higher-order odd powers. The resulting fit was significantly worse, with a $\sigma_e$ value twice as large compared fits with the same number of free parameters, but including even powers. The resulting fits also showed significant systematic deviations from the empirical data for $0.3M_\odot<M_*<0.5M_\odot$. We opted to include the even orders for all analyses despite their near-zero values. 

We adopted $n=\order$ as the preferred solution. Lower-order fits did a reasonable job fitting most of the sequence, but poorly reproduced the masses of objects with $M_*<0.085M_\odot$. In this regime, the relation becomes increasingly non-linear. The result is that lower-order fits systematically overestimate the masses of the coolest objects in our sample (Figure~\ref{fig:order}) and tend to overestimate $\sigma_e$ to compensate. Higher-order fits explain the data reasonably well, but were not justified statistically (e.g., marginal decrease in $\sigma_e$) and showed slope changes outside the calibration sample that are not expected by theoretical considerations. 

\begin{figure}[h]
\begin{center}
\includegraphics[width=0.48\textwidth]{order.eps}
\caption{Fits of varying order ($n$) to Equation~\ref{eqn:mmk2} compared to the empirical values for the lowest-mass stars in our sample. The fits are similar above 0.085$M_\odot$, but a high-order ($n=\order$) is required to reproduce objects below this as the relation becomes increasing non-linear. The systematic offset seen between the low-mass sample and the best-fit relation can be seen in the coefficient posteriors as well as the best-fit relation (i.e., the distribution of fits are systematically high). }
\label{fig:order}
\end{center}
\end{figure}

We list the best-fit (highest likelihood) coefficient values in Table~\ref{tab:coeff}, as well as median values of $f$ and $\sigma_e$. We also provide trimmed posteriors for each coefficient are included on the \href{https://github.com/awmann/M_-M_K-}{github repository}. Fits using $n=4$ and $n=6$ are included in \ref{tab:coeff} for reference, although we suggest using only the $n=\order$ relation. 

\begin{deluxetable*}{l l l l l l l l l l l l l l}
\tablecaption{Best-fit Coefficients for Equations~\ref{eqn:mmk2} and \ref{eqn:mmk3}}
\tablehead{
\colhead{$n$} & \colhead{$a_0$} & \colhead{$a_1$} & \colhead{$a_2$} & \colhead{$a_3$} & \colhead{$a_4$} & \colhead{$a_5$} & \colhead{$a_6$} & \colhead{f} & \colhead{$\sigma_e$ }
}
\startdata
4 &  -0.649174 &  -0.202871 & $   3.534007\rm{x}10^{-3}$ & $   5.027287\rm{x}10^{-3}$ & $  -2.602814\rm{x}10^{-4}$ & \nodata & \nodata & \nodata &  0.024\\
5 &  -0.646609 &  -0.212461 & $  -2.653431\rm{x}10^{-3}$ & $   7.948519\rm{x}10^{-3}$ & $   3.689931\rm{x}10^{-4}$ & $  -1.922619\rm{x}10^{-4}$ & \nodata & \nodata &  0.019\\
6 &  -0.639096 &  -0.209812 & $  -1.233159\rm{x}10^{-2}$ & $   6.807998\rm{x}10^{-3}$ & $   2.502305\rm{x}10^{-3}$ & $  -1.032515\rm{x}10^{-4}$ & $  -1.214597\rm{x}10^{-4}$ & \nodata &  0.018\\
\hline
4 &  -0.649080 &  -0.200933 & $   3.653071\rm{x}10^{-3}$ & $   5.013043\rm{x}10^{-3}$ & $  -2.585343\rm{x}10^{-4}$ & \nodata & \nodata &  0.0359 &  0.024\\
5 &  -0.641775 &  -0.214926 & $  -5.529392\rm{x}10^{-3}$ & $   8.938656\rm{x}10^{-3}$ & $   6.322845\rm{x}10^{-4}$ & $  -2.702156\rm{x}10^{-4}$ & \nodata &  0.0380 &  0.018\\
6 &  -0.641454 &  -0.214102 & $  -8.457413\rm{x}10^{-3}$ & $   7.796100\rm{x}10^{-3}$ & $   1.501982\rm{x}10^{-3}$ & $  -1.591839\rm{x}10^{-4}$ & $  -5.393466\rm{x}10^{-5}$ &  0.0307 &  0.018\\
 \enddata
\label{tab:coeff}
\tablecomments{The $n=5$ fit is preferred independent of including [Fe/H]. Note that values presented here are the highest likelihood for the $a_i$ values, with the median value for $f$ and $\sigma_e$. Figures~\ref{fig:fitpost} and \ref{fig:fitpost_feh} note the median coefficient values.}
\end{deluxetable*}

To estimate the uncertainty in the relation we computed the standard deviation in the derived masses for a fixed \mks\ across all MCMC steps, which we report in Table~\ref{tab:err}. In the best-constrained regions ($5\lesssim$\mks$\lesssim7$, $0.3\lesssim M_*\lesssim0.6$) the scatter in the relation is $\lesssim$1\%, reaching $\simeq$3\% near the edges. These values in Table~\ref{tab:err} could potentially be used as a reference for estimating errors on the output mass for a given \mks\ if combined with errors from the distance and $K_S$ magnitude. This does not account for intrinsic scatter in the \mmk. To this end, we redid this calculating including $\sigma_e$ as a proxy for intrinsic scatter. It is possible that $\sigma_e$ is purely a representation of missing uncertainties in the input parameters (e.g., orbital parameters, parallaxes, $K_S$). However, even in this case, we cannot rule out the presence of intrinsic variation at the level of $\sigma_e$ without removing (or at least characterizing) the missing errors. We advise using the errors that include $\sigma_e$ for all mass uncertainty estimates.

\begin{deluxetable}{l l l | l l | l l}
\tablecaption{Error in \mmk\ Relation}
\tablehead{
 \colhead{$M_{K_S}$} & \colhead{$M_*$} & \colhead{SpT$^a$} & \colhead{$\sigma_{M_*}^b$} & \colhead{$\sigma_{M_*}^b$} & \colhead{$\sigma_{M_*}^c$} & \colhead{$\sigma_{M_*}^c$}  \\
 \colhead{(mag)} & \colhead{$M_\odot$} & \colhead{} & \colhead{$M_\odot$} & \colhead{\%} & \colhead{$M_\odot$} & \colhead{\%} 
}
\startdata
\multicolumn{7}{c}{No [Fe/H] term ($f=0$), 5th order} \\
\hline
 4.0 & 0.742 & K4.5 & 0.028 & 0.038 & 0.031 & 0.042\\
 4.5 & 0.669 & K7.0 & 0.011 & 0.017 & 0.017 & 0.026\\
 5.0 & 0.6004 & M0.0 & 0.0091 & 0.015 & 0.015 & 0.025\\
 5.5 & 0.5248 & M1.5 & 0.0067 & 0.013 & 0.012 & 0.023\\
 6.0 & 0.4430 & M2.5 & 0.0046 & 0.010 & 0.0098 & 0.022\\
 6.5 & 0.3615 & M3.0 & 0.0034 & 0.010 & 0.0078 & 0.022\\
 7.0 & 0.2871 & M3.5 & 0.0026 & 0.009 & 0.0062 & 0.021\\
 8.0 & 0.1759 & M4.5 & 0.0016 & 0.009 & 0.0038 & 0.021\\
 8.5 & 0.1398 & M5.0 & 0.0014 & 0.010 & 0.0031 & 0.022\\
 9.0 & 0.1143 & M6.0 & 0.0013 & 0.011 & 0.0026 & 0.022\\
 9.5 & 0.0971 & M6.5 & 0.0012 & 0.013 & 0.0023 & 0.023\\
10.0 & 0.0860 & M7.5 & 0.0013 & 0.015 & 0.0021 & 0.025\\
10.5 & 0.0791 & M9.0 & 0.0013 & 0.016 & 0.0020 & 0.025\\
11.0 & 0.0745 & L1.0 & 0.0019 & 0.025 & 0.0024 & 0.032\\
\hline
\multicolumn{7}{c}{[Fe/H] term ($f$), 5th order} \\
\hline
 4.0 & 0.753 & K4.5 & 0.029 & 0.039 & 0.032 & 0.043\\
 4.5 & 0.671 & K7.0 & 0.011 & 0.016 & 0.017 & 0.025\\
 5.0 & 0.5990 & M0.0 & 0.0091 & 0.015 & 0.014 & 0.024\\
 5.5 & 0.5231 & M1.5 & 0.0067 & 0.013 & 0.012 & 0.022\\
 6.0 & 0.4423 & M2.5 & 0.0045 & 0.010 & 0.0093 & 0.021\\
 6.5 & 0.3618 & M3.0 & 0.0035 & 0.010 & 0.0075 & 0.021\\
 7.0 & 0.2880 & M3.5 & 0.0027 & 0.009 & 0.0059 & 0.021\\
 8.0 & 0.1769 & M4.5 & 0.0016 & 0.009 & 0.0036 & 0.021\\
 8.5 & 0.1405 & M5.0 & 0.0015 & 0.010 & 0.0030 & 0.021\\
 9.0 & 0.1147 & M6.0 & 0.0013 & 0.011 & 0.0025 & 0.022\\
 9.5 & 0.0974 & M6.5 & 0.0013 & 0.013 & 0.0022 & 0.022\\
10.0 & 0.0862 & M7.5 & 0.0013 & 0.015 & 0.0020 & 0.024\\
10.5 & 0.0794 & M9.0 & 0.0013 & 0.016 & 0.0020 & 0.025\\
11.0 & 0.0750 & L1.0 & 0.0018 & 0.024 & 0.0023 & 0.030\\
\enddata
\label{tab:err}
\tablecomments{This table assumes \mks\ (and [Fe/H]) are known perfectly. Total errors on $M_*$ should take into account errors in the measured parameters and the relation. }
\tablenotetext{$a$}{Spectral types are given for reference, but are extremely rough because of a significant dependence on metallicity and how the spectral typing is done (e.g., which indices are used, NIR versus optical). It is not recommended to use this table as a means to compute \mks\ or $M_*$ from a spectral type or vice versa. }
\tablenotetext{$b$}{The uncertainty in the resulting $M_*$ at a given $M_{K_S}$ ignoring $\sigma_e$}
\tablenotetext{$c$}{The uncertainty in the resulting $M_*$ at a given $M_{K_S}$ accounting for $\sigma_e$}
\end{deluxetable}

A more robust account of errors than using Table~\ref{tab:err} would be to use the full coefficient posteriors to account for asymmetry around the best-fit relation. To aid with this, we included the fit posteriors and a simple code that provides output $M_*$ posteriors\footnote{\href{https://github.com/awmann/M_-M_K-}{https://github.com/awmann/M\_-M\_K-}} given a $K_S$, distance, and associated uncertainties. The program combines the scatter in the coefficient posteriors with the median value of $\sigma_e$. Over most of the relation, particularly $0.1M_\odot<M_*<0.5M_\odot$, $\sigma_e$ is the dominant source of uncertainty in estimating masses. 

\subsection{The role of metallicity}\label{sec:metal}

We explored the the effects of [Fe/H] on the \mmk\ relation using the Mesa Isochrones and Stellar Tracks \citep[MIST,][]{MIST0,MIST1}. We also tested models from the Dartmouth Stellar Evolution Database \citep[DSEP,][]{Dotter2008}, and found results to be broadly in agreement. We preferred MIST because their model atmospheres include a newer set of molecular lines (e.g., TiO) that are important in M dwarfs and may impact the synthetic photometry. The Lyon models \citep[BHAC15,][]{BHAC15} employ a model atmosphere in reasonable agreement with nearby stars with interferometrically determined \teff\ values \citep{Boyajian2012,Mann2013c}, and go to lower masses than DSEP and MIST. However, the BHAC15 models cover only solar metallicity. 

We show the expected \mks\ tracks from MIST for different metallicities in Figure~\ref{fig:mk_metal} alongside our empirical determinations. MIST models do not extend below 0.1$M_\odot$, so we restricted our comparison to above that mass. For this comparison we assumed a fixed age of 5\,Gyr, although the choice of age from 1-10\,Gyr makes a negligible difference for the mass range shown (Figure~\ref{fig:age}). 

Note that metal-rich stars are expected to be {\it less luminous} for a fixed $M_*$, whereas the opposite trend is seen for a fixed \teff\ and most color selections. Higher metal abundance increases the stellar radius for a fixed $M_*$ (because of higher opacity), which lowers the density and pressure near the core, decreasing the overall rate of fusion and hence the total luminosity. 

Above 0.4$M_\odot$ there is a slight trend for metal-rich stars in our sample to land below the median sequence, as expected from the models. However, many metal-poor stars also land below the sequence, and there is no obvious trend below 0.4$M_\odot$. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{Model_metal_0.eps}
\caption{\mks\ as a function of $M_*$ using MIST tracks of different metallicities (dashed lines) compared to empirical mass determinations (points). Color-coding by metallicity is the same for the points and lines, and matches the color scale of Figure~\ref{fig:relation}. The plot cuts at 0.1$M_\odot$, as the MIST models do not go below this limit. }
\label{fig:mk_metal}
\end{center}
\end{figure}

The residuals from our best-fit relation confirmed a weak (or no) effect on the derived $M_*$ due to changes in [Fe/H], as we show in Figure~\ref{fig:metal_resid}. A Spearman's rank test yielded no significant correlation between the residuals and [Fe/H]. We tried resampling the measurements using their uncertainties, and $<$1\% of samples showed a significant correlation. We also repeated this test, but restricted to just the best-characterized systems ($<5\%$ precision on mass) and still found no significant trend with [Fe/H]. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{residual_metal7.eps}%% needs to be replaced
\caption{Fractional difference between the orbital and predicted system mass as a function of metallicity of the system. The top panel contains all systems, while the bottom shows just those with $<$5\% uncertainties on $M_*$. Points are color-coded by the masses of components, with the inner dot corresponding to the primary star's estimated mass, and the outer circle the companion's estimated mass. Errors consider only input errors on total $M_*$.}%Quoted errors in mass account for the scatter in the \mmk\ relation.} 
\label{fig:metal_resid}
\end{center}
\end{figure}

Our sample is limited in its [Fe/H] range; 64\% of the targets are $-0.2<$[Fe/H]$<+0.2$ and only one target has [Fe/H]$<-0.5$. It is possible that our best-fit relation masked any [Fe/H] term by shifting the fit to match the typical metallicity of stars at a given \mks. We explored this by fitting for a term in [Fe/H] of the form:
\begin{eqnarray}\label{eqn:mmk3}
M_{tot} &=& (1+f[\rm{Fe/H]})\left(10^{b_1} + 10^{b_2}\right),
\end{eqnarray}
where $b_j$ is defined in Equation~\ref{eqn:mmk2_b}. This form assumes that a linear change in [Fe/H] corresponds to a fractional change in $M_*$ (e.g., f=0.1 would correspond to a 10\% change in derived $M_*$ per dex in [Fe/H] for a fixed \mks). This is generally consistent with the evolutionary models, although there is a small change in the scale ($f$) over the range of masses considered here. 

For this analysis we excluded the two L dwarfs from the sample because their metallicities are less reliable (extrapolated from an M dwarf calibration). As with our fit to Equation~\ref{eqn:mmk2}, we tested range of values for $n$ (number of $a_i$ coefficients). Our MCMC fitting method was otherwise identical to that outlined in Section~\ref{sec:relation}. Since we were primarily interested in the {\it relative} effect of [Fe/H], and not necessarily the absolute scale, we assumed the smaller (relative) errors on [Fe/H] (see Section~\ref{sec:feh}). 

We show the output coefficient posteriors in Figure~\ref{fig:fitpost_feh} and list the best-fit coefficients in Table~\ref{tab:coeff}. As with our fits neglecting $f$, we found significantly better agreement with the lowest-mass objects in the sample using $n=\order$, although $n=4$ and $n=6$ are listed in Table~\ref{tab:coeff} for reference. 

\begin{figure*}[p]
\begin{center}
\includegraphics[width=0.97\textwidth]{output_8feh_eMs.pdf}
\caption{Same as Figure~\ref{fig:fitpost}, but for the fit following Equation~\ref{eqn:mmk3}, i.e., including the [Fe/H] term, $f$. }
\label{fig:fitpost_feh}
\end{center}
\end{figure*}

Consistent with our previous analysis, our $f$ value is consistent with zero (no impact of [Fe/H] on the \mmk\ relation) at 1.7$\sigma$. This suggests our relation will work reasonably well even on more extreme metallicity samples (e.g., Halo stars). However, it is also possible that [Fe/H] is less important than abundances of elements that specifically impact the strength of molecular features in M dwarf spectra. Higher C/O, for example, suppresses available Oxygen for TiO formation, weakling a major source of opacity in the optical \citep[e.g., C, O, Ti,][]{2012ApJ...747L..27F,2015ApJ...804...40G,Veyette2016a}. This also might explain some of the extra scatter in the relation ($\sigma_e$) if there is sufficient variance of these abundances in the given sample. Testing this will require a means to determine more detailed abundances of M dwarfs \citep[e.g.,][]{Veyette2017}, and/or to add in subdwarf binaries or other systems with more extreme abundances to provide increased leverage on any metallicity effects. 

To compare to the models, we fit the MIST grid points in the same manner as the empirical dataset following Equation~\ref{eqn:mmk3}. In Figure~\ref{fig:f} we show the posterior on $f$ from the model grid compared to that from the dynamical masses. The models predict a significantly larger [Fe/H] effect then supported by our binary sample. The difference between the two posteriors ($f_{\rm{model}}-f_{\rm{dynamical}}$) is greater than zero at $4.1\sigma$. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{F_plot.eps}
\caption{Comparison of the posterior on $f$ (fractional change in $M_*$ per dex in metallicity for a fixed \mks; Equation~\ref{eqn:mmk3}) predicted by the MIST models (black) compared to that using our dynamical masses (red). There are an identical number of points in each posterior and the bin sizes are the same. }
\label{fig:f}
\end{center}
\end{figure}

The difference between model and empirical predictions for $f$ holds for different subsets of the data and accounting for potential systematics in the assigned [Fe/H]. There is some evidence in the binary sample that [Fe/H] effects are stronger at the high-mass end (see Figure~\ref{fig:relation}). We tested this by repeating the analysis excluding binaries with one or more component masses below $0.35M_\odot$. While we found a marginally larger $f$ value using just the higher-mass sample ($f=0.056\pm0.035$\,dex$^{-1}$), this was still 2.5$\sigma$ discrepant from the model prediction and consistent with the result from the entire binary sample at $<1\sigma$. The difference also held if we restrict our sample to $0.1<M_\odot<0.6$, where the M dwarf [Fe/H] relations are best calibrated \citet{Mann2013a,Mann2014}.

The model discrepancy also cannot be explained by $\sigma_e$. Whatever interpretation we apply to this value, it only amounts to $\simeq$2\% variation in $M_*$ for a given \mks. The models predict a metallicity effect of $\simeq0.17$ per dex, and since our sample covers about 1 dex in [Fe/H], this translates to an expected $\simeq$17\% variation in mass over the full sample, or 8\% if we just consider the majority of the targets. It is possible that $\sigma_e$ is being driven in part by erroneous assigned [Fe/H] (or underestimated errors on [Fe/H]) which could decrease our derived $f$ value, but the effect is too small to reconcile with the models. 

Overestimating the effect of [Fe/H] may be related to missing opacity/molecular lines in the atmospheric models. Missing opacity at optical wavelengths could strengthen the effect of [Fe/H] by underestimating the number of saturated features (if a line is saturated adding [Fe/H] cannot make it stronger). The effect at NIR wavelengths would be weaker, since there are fewer molecular bands, but underestimated opacity in the optical would also change the continuum levels in the NIR as well as how those levels change with [Fe/H]. 

If the issue is related to the atmospheric models, the effect should change as a function of mass/\teff\ as molecular lines become stronger with decreasing temperature. However, this is hard to test with the current sample, since we don't have a large spread in [Fe/H] when compared to the [Fe/H] measurement uncertainties over the full mass range. Recent comparison suggest models reproduce optical and NIR spectra of M dwarfs to $\simeq$5\% \citep[e.g.,][]{Lepine:2013,Mann2013c}, with the exception of a few molecular features like CaOH, AlH, and NaH \citep{Rajpurohit:2013}. These bands are mostly blueward of 6000\AA, so blue flux ratios of our targets could help test this, as well as adding in more extreme metallicity systems. Erroneous model continuum opacities could have a larger effect than individual missing lines or molecular bands. Poor continuum opacities are usually absorbed into normalization parameters \citep[e.g.,][]{Cushing:2008fj}, and hence difficult to test without direct constraints on the radius, such as those from long-baseline optical interferometry \citep[e.g.,][]{Boyajian2015,Kane2017}.

\subsection{Comparison to previous relations}\label{sec:other}

\subsubsection{\citet{Delfosse2000}}

\citet{Delfosse2000} provided one of the most commonly used \mmk\ relations, covering $0.1M_\odot<M_*<0.6M_\odot$. Like our work, the calibration was built primarily on astrometric binaries. Nearly all the targets in \citet{Delfosse2000} were included in our sample, with the exception of triple systems and eclipsing binaries, both of which we avoided because of the complexity of computing total masses in the first scenario and in the latter, estimating \mks\ and the effect of tides and enhanced activity on the radii of stars on short-period, eclipsing orbits. Because of the sample overlap, consistency is expected. However, a comparison can be useful to see how past use of \citet{Delfosse2000} may change with our more precise results.

We show the comparison in Figure~\ref{fig:delfosse}, including the points used in the \citet{Delfosse2000} calibration as well as the two fit lines. Given errors often quoted for the \citet{Delfosse2000} relation (5-10\%), the two fits are in remarkable ($<$5\%) agreement over most of the mass range ($0.15M_\odot \lesssim M_* \lesssim 0.5M_\odot$). Only at the high-mass end do the two relations diverge by as much as 10\%, but \citet{Delfosse2000} had few calibrators in this regime. While the two relations are in excellent agreement, the relation presented here is a factor of 2-5$\times$ more precise over the whole mass regime. 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Delfosse_comp.eps}
\caption{Absolute $K_S$-band magnitude as a function of mass for astrometric binaries analyzed by \citet{Delfosse2000} (red circles). The resulting $M_*$-\mks\ relation from \citet{Delfosse2000} is shown as a teal dashed line, while the best-fit relation from this paper is shown as a blacked dashed line (with error in grey as in Figure~\ref{fig:relation}). The bottom panel shows the residual of the \citet{Delfosse2000} points compared to our relation.}
\label{fig:delfosse}
\end{center}
\end{figure}

\subsubsection{\citet{Mann2015b}}

\citet{Mann2015b} built a catalog of 183 M dwarfs with precise \teff\ and $R_*$, calibrated against radii measurements from long-baseline optical interferometry \citep{Boyajian2012} and precision bolometric fluxes \citep[e.g.,][]{Mann2015a,2015MNRAS.447..846B}. Masses were computed for these stars by interpolating the parameters onto an updated version of the DSEP models as described in \citet{Feiden2013,Feiden2014} and \citet{Muirhead2014}. Although these masses were model-dependent, they accurately reproduced the mass-radius relation from low-mass eclipsing binaries. This suggested that the model-based masses were accurate to $\simeq$3\% or better, and motivated the development of a \mmk\ relation from the \citet{Mann2015b} sample. A comparison to our relation can be seen in part as a test on the updated DSEP models, in addition to the results given in \citet{Mann2015b}. 

We show our fit with uncertainties alongside \citet{Mann2015b}'s in Figure~\ref{fig:mann}. The two fits track each other extremely well, with a maximum divergence of $\simeq$5\%. Given the quoted 2-3\% uncertainties from \citet{Mann2015b} and the 2-3\% errors in our relation, this difference is not significant. There is a hint of tension at the high-mass end, where our MCMC posterior is asymmetric, and at 0.2-0.3$M_\odot$ where the difference is the largest, but never does the the offset exceed the estimated uncertainties. 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Mann_comp.eps}
\caption{Comparison of $M_*$-\mks\ from \citet{Mann2015b}, shown as a teal dashed line, to that from this paper, which is shown in black, with 100 randomly selected realizations of the MCMC (as with Figures \ref{fig:relation} and \ref{fig:delfosse}). Residual is shown in the bottom panel. Individual points from \citet{Mann2015b} on which the calibration is based are not shown (for clarity), but they follow a tight sequence around the teal line. Only the range of masses covered by \citet{Mann2015b} are shown. }
\label{fig:mann}
\end{center}
\end{figure}


\subsubsection{\citet{Benedict2016}}
Like our work, the \citet{Benedict2016} relation was also based primarily on masses derived from M dwarf astrometric binaries. \citet{Benedict2016} sample uses absolute astrometry from {\it HST} fine guidance sensors and radial velocities for a subset of systems. In addition to the precision provided by {\it HST}, this combination yields individual (component) masses, and, in many cases, independent constraints on parallaxes. So although our sample is larger and contains most of the targets in \citet{Benedict2016}, their analysis is not subject to many of the complications of our own. 

We compare our \mmk\ relation \citet{Benedict2016}'s in Figure~\ref{fig:benedict}. The two relations are in excellent agreement for $0.09M_\odot\lesssim M_* \lesssim 0.25M_\odot$. Below this regime, the \citet{Benedict2016} fit is effectively anchored by one star, GJ1245C, because the two other stars in this low-mass regime (GJ 2005B and C) have relatively large errors. GJ1245AC is in our sample, but we use a parallax from \citet{GaiaDr2} on GJ 1245B for this system, which places it $10\sigma$ (2.5\%) more distant than the parallax adopted by \citet{Benedict2016}. Our orbital parameters for this system are in excellent agreement with \citet{Benedict2016} if we adopt their distance, but the \citet{GaiaDr2} parallax makes the final parameters more consistent with our \mmk\ relation than adopting the \citet{Benedict2016} parallax. Since the \citet{Benedict2016} distance accounted for the binarity of this system, the origin of the difference between these two parallaxes is unclear. If GJ 1245B is itself an unresolved binary, this could explain the discrepant parallax (although there is no evidence of this). If the \citet{Benedict2016} parallax is correct, this reduces the total mass to 0.189$\pm$0.001$M_\odot$, while the predicted mass is 0.207$M_\odot$ for the adjusted $M_K$ values (8.90 and 10.02 for the primary and companion, respectively). To reconcile this dynamical and predicted mass using the \citet{Benedict2016} parallax, we need to explain why GJ 1245AC is $\simeq$0.3~mag more luminous than predicted by other similar-mass objects, such as youth \citep{2015ApJ...800...95L,2017ApJ...834...85N}. 

 Above 0.3$M_\odot$, \citet{Benedict2016} predicts masses as much as 10\% higher than our own for a fixed \mks. Our fit agrees reasonably well with the astrometric binaries fit by \citet{Benedict2016} in this mass regime. The divergence is driven instead, by literature mass determinations \citet{Benedict2016} included in their \mmk\ fit. Inspection of these literature points makes the origin of the discrepancy more clear; many are eclipsing binaries and have $\Delta K$-band magnitudes of mixed quality and/or lack parallaxes needed for a precise \mks. GU Boo, for example, has absolute magnitudes estimated from an optical eclipse depth combined with bolometric corrections \citep{Lopez2005}, which are drawn from models that perform poorly on M dwarfs \citep{1998A&AS..130...65L,Hauschildt1999}. Similarly, for GJ 2069 AC (CU Cnc) \citet{Benedict2016} adopted \mks\ from \citet{Ribas2003} that disagree with the 2MASS $K_S$ and Gaia DR2 parallax (for either AC or B) using any $\Delta K_S$. We conclude that the \mks\ determinations for these eclipsing systems need to be revised before including them in future analyses of the \mmk\ relation. 


\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Benedict_comp.eps}
\caption{Absolute $K_S$-band magnitude as a function of $M_*$ for astrometric binaries analyzed by \citet{Benedict2016} (red circles) and those used in the \citet{Benedict2016} relation, but pulled from the literature (blue circles). The resulting $M_*$-\mks\ relation from \citet{Benedict2016} is shown as a teal dashed line, while the best-fit relation from this paper is as a black dashed line (with random samplings in grey as in earlier figures). The bottom panel shows the residual of the \citet{Benedict2016} points compared to our relation, with the \citet{Benedict2016} relation in teal for reference. Errors in the residuals only reflect errors in $M_*$ and \mks, and do not account for errors in our $M_*$-\mks\ relation. }
\label{fig:benedict}
\end{center}
\end{figure}

%% problematic points:
%% GJ 278 C GJ 278 D (YY Gem): can't figure out where the K magnitudes came from?
%% GJ 570 B GJ 570 C: This is in our sample. We get total mass of 0.8330.053, they get 0.9760.012. They report delk~1.18, while we get 0.995. 
%% GJ 2069 A GJ 2069 C: Junky (bolometric correction) parallax and K 
%% GU Boo A GU Boo B: Crappy parallax and K

%\subsection{Testing mass ratio predictions}
%This test is a bit of a wash. There's broad agreement, but there's a few points that are way off. They are the same ones we mismatch on with Benedict. I think they are doing something funny with SB1s (not accounting for bias from the companion lines?). Can't quite tell from the paper. This is probably not worth the effort. 

%\subsection{Applications}
% This would be a section where we calculate the mass of a few more famous systems, e.g., Kepler-42, GJ1214, Trappist-1, etc. 
%I think this would be cool but the paper is SUPER long. 

\section{Conclusions \& Discussion}\label{sec:discussion} 

\subsection{Summary}
The mass-luminosity relation has proven to be a critical tool for estimating masses of cool stars for decades, and has applications from studying extrasolar planets to measuring the initial mass function and mass-to-light ratio in massive galaxies. The \mmk\ relation has been particularly useful because $K$-band magnitudes are widely available through 2MASS and other sources, extinction is usually negligible for nearby stars at these wavelengths, and there is minimal affect by metallicity. With the arrival of Gaia parallaxes combined with existing 2MASS photometry, nearly all the early M-dwarfs out to $\simeq$100\,pc and late M-dwarfs out to $\simeq$50\,pc have precise ($\lesssim1\%$) parallaxes and \mks\ magnitudes, massively increasing the utility of this relation. 

We endeavored to improve on existing \mmk\ relations and evaluate the role of [Fe/H] on the relation by expanding the sample of calibrators and using new techniques to measure the metallicity of binary M dwarfs. As part of this effort, we have been monitoring a set of nearby late K and M dwarf visual binaries using adaptive optics imaging with the goal of mapping their orbits and estimating their masses. We combined these data with similar data from Keck, CFHT, Gemini, and VLT archives, as well as astrometric measurements from the literature. The combination of literature astrometry and the recent Keck measurements were particularly important to provide the required baseline to fit long-period ($P>10$ years) orbits. 

We used these data to fit the orbits for 52 binaries, which we combined with parallaxes from the literature or derived from MEarth astrometry to determine the total masses of each system. We combined this with seven ultracool binaries from \citep{Dupuy2017}, which were analyzed in a nearly identical way to the procedure used in this paper and provide significantly improved coverage near the hydrogen burning limit. Seven binaries have total mass determinations better than 1\%, with a median precision of 6\%.

We used our dynamical masses and resolved \mks\ magnitudes to fit for an empirical relation between $M_*$ and \mks. The relation covers almost an order of magnitude in $M_*$, from $\simeq0.7M\odot$ down to the hydrogen burning limit ($\simeq0.075M_\odot$) and includes stars spanning the range of [Fe/H] expected for the Solar neighborhood ($-0.6<$[Fe/H]$<+0.4$).

The result provides masses precise to $\simeq$2\% over most of the M dwarf sequence. The uncertainty is limited primarily by scatter in the input masses around the best-fit above what is expected given their assigned mass uncertainties (median error on total $M_*$ of 5.6\%). We characterize this scatter with a free parameter ($\sigma_e$), which we find to be $\simeq$2\% for all fits. It is unclear if this term is a sign of intrinsic variation in the \mmk\ due to a missing astrophysical parameter, such as age/activity/rotation \citep[e.g.,][]{Kraus2011,Feiden:2016aa,Somers2017} or detailed abundances \citep[e.g.,][]{2017A&A...604A..97L,Veyette2017}, or underestimated errors in the input masses. Our adopted parallaxes, in particular, could have their uncertainties underestimated due to uncorrected orbital motion in the input astrometry. Although this does not impact many of our systems, for which the parallax was drawn from a wide proper motion companion or accounting for orbital motion, enough of the sample could be impacted by this to explain much of the missing 2\%. 

Using empirically calibrated spectroscopic abundances, we explored the role of [Fe/H] on the \mmk\ relation, comparing our results to expectations from evolutionary models as a guide. While the MIST models follow our empirical data relatively well, they significantly overestimate the importance of [Fe/H] in the \mmk\ relation (4.0$\sigma$). This difference does not appear to be due to systematics in the [Fe/H] estimates and holds even when we only include targets with the most reliable masses and/or metallicities. Interestingly, the effect of [Fe/H] is consistent with zero at 1.7$\sigma$, suggesting a metallicity effect so weak that we will need to include targets with more extreme metallicities to characterize it. 

We compared our relation to recent similar relations in the literature. Given quoted uncertainties, both the \citet{Delfosse2000} and \citet{Mann2015b} relations follow ours well over most of the sequence. Since the \citet{Mann2015b} masses are rooted in an updated version of the DSEP code, the level of agreement suggests that these models perform extremely well in predicting the masses of old, main-sequence M dwarfs. 

Our results agreed well with the observational sample of astrometric binaries analyzed by \citet{Benedict2016}, but our relation diverges from \citet{Benedict2016} above $\simeq0.35M_\odot$. We attribute this difference to literature points included in the \citet{Benedict2016} fit from earlier analyses (mostly eclipsing binaries) with uncertain distances and $\Delta K_S$ magnitudes. Increasing availability of Gaia parallaxes for these systems as well as ongoing efforts to measure their eclipses in range of wavelengths \citep[e.g.,][]{2017AJ....154..100H} should significantly improve their utility for studying the mass-luminosity relation of M dwarfs.


\subsection{Suggestions when using our \mmk\ relation}\label{sec:caveats}

To help users interested in using \mks\ to compute a realistic $M_*$ and $\sigma_{M_*}$ of single stars with parallaxes and $K_S$ magnitudes, we provide \href{https://github.com/awmann/M_-M_K-}{a simple code} to sample the fit posterior. {\bf Before using that code or the provided MCMC posteriors, take note of the following suggestions:}
\begin{itemize}
\item The fit behaves poorly near the edges of the calibration sample. The scatter in the MCMC posterior accounts for this, but restrict use to $4.0<M_{K_S}<11.0$ ($0.075M_\odot<M_*<0.74M_\odot$), and a `safe' range would be $4.5<M_{K_S}<10.5$ ($0.08M_\odot<M_*<0.67M_\odot$). 

\item Our relation is only valid for main-sequence stars, and the roles of youth and activity are not accounted for here. Based on the Lyon models \citep{BHAC15}, we advise restricting use to $>$100\,Myr above $0.4M_\odot$, $>$300\,Myr to $0.2M_\odot$, $>$500\,Myr to $0.1M_\odot$, and $>1$\,Gyr below 0.1$M_\odot$. A safer cut would be to only use this on stars $>$1 Gyr, similar to the calibration sample. 

\item The sample metallicity spans $-0.60<\rm{[Fe/H]}<+0.45$, but 85\% of the binaries have $-0.40<\rm{[Fe/H]}<+0.30$. We provide a fit that attempts to take into account changes due to [Fe/H], but find a surprisingly weak effect. This suggests the [Fe/H]-free relation is safe to use over the range of metallicities expected in the Solar neighborhood (similar to the calibration sample). However, given the paucity of extreme metallicity systems in our calibration sample, we advise caution when targeting more metal-poor populations like the thick disk or halo ([Fe/H]$\ll-0.5$). The effects of more detailed abundances (e.g., [$\alpha$/Fe]) are completely untested.

\item The relation is only tested above the hydrogen burning limit. Since the boundary likely depends on metallicity \citep{2001RvMP...73..719B}, it is also not possible to use a simple $M_{K_S}$ cut even if the target is known to be old. Objects just below the hydrogen burning limit age slowly \citep{BHAC15}, so the relation given here may give reasonable results for many of these, but we urge caution when interpreting $M_*$ values for $M_{K_S}>10.5$. 

\item Since the origin of the $\sigma_e$ value is unclear, we suggest always including this as an irreducible source of error when estimating the mass of a target. 

\end{itemize}


\subsection{Future directions}

We intentionally selected targets that had $\Delta K$ measurements, as \mks\ was known to give the tightest relation with $M_*$ for M dwarfs. Unfortunately, there is no other band with contrast ratios for all systems considered here. Most of our monitoring was done with NIRC2 on Keck, so many systems have a $\Delta H$, but only about 1/3 of the sample have measurements in an optical band. This limits the utility of the sample, as Gaia $G$, $BP$, and $RP$ are now widely available for early and mid-M dwarfs, and are generally measured with better precision than 2MASS $K_S$. The growing capabilities of speckle cameras \citep[e.g.,][]{2009AJ....137.5057H} offer the opportunity to add optical contrasts. These can be converted to Gaia bandpasses, given reasonable assumptions about the component spectra, and used to derive a $M_{G}-M_*$ (or $M_G-M_*$-[Fe/H]) relation that can be easily applied to millions of K and M dwarfs. Complementary optical data also provide colors for individual components, from which we can measure component \teff\ and luminosity \citep[e.g.,][]{2017ApJ...845...72K}.

Our sample was limited mostly to stars in the Solar neighborhood, and hence was heavily biased towards the narrow [Fe/H] distribution of nearby stars. We identified five additional [Fe/H]$<-0.5$ systems including two subdwarf binaries. However all systems had short baselines in the literature compared to their expected orbital periods. It may take 1-2 more years to complete their orbits at the required precision for this kind of analysis. The availability of Gaia parallaxes will also help improve the precision of the known metal-poor systems and aid in the identification of new ones. Lastly, as new methods arrive to measure detailed abundances of M dwarfs \citep{Veyette2016a,Veyette2017} we can explore effects beyond just [Fe/H]. This is especially useful for systems with large enough radial velocity differences between component stars to separate out individual spectra at high resolution.


Although the sample studied here contained 118 stars, we only had half that many data points (59) constraining the fit, as the mass ratios were not known. This complicates the fit at the bottom of the sequence somewhat, where the relation is steeper. Here, small changes in the shape can have a larger impact on the implied mass ratio for a given system, providing a means to generate many reasonable solutions to the same set of system masses. This can be seen in Figure~\ref{fig:relation} as a spread in the range of possible solutions \mks$>10$ despite relative well-determined masses for these systems. Later Gaia data releases will include full astrometry information, which, when combined with a measure of the flux ratio and our existing astrometry will enable a global fit for individual masses as well as the system parallax. 

The presence of unresolved tight companions (triples or quadruples) could bias the overall relation. A close-in third star orbiting one of the two binary components might be stable, and would not have been detected in our AO data. An unresolved, less massive companion would drive the total mass of the system higher, but has a much smaller effect on the total luminosity. So unresolved triples will sit {\it low} in Figure~\ref{fig:relation} (higher mass for a fixed \mks). A few stars do sit well below the fit, but not more so than expected given their mass uncertainties. Many of our targets have some radial velocity data in the literature \citep[e.g.,][]{1999A&A...344..897D,Raghavan2010,Benedict2016}, which rule out the presence of any unresolved stellar companion. However, a more detailed analysis will require re-analysis of the radial velocity data to determine the maximum mass of an undetected companion for each individual system and convert that into a bias on the relation. 

Ages of our binary sample are not known, preventing any study into the effects of age on the \mmk\ relation. However, our larger sample of binaries with orbit measurements still in progress contains known members of nearby young moving groups and the Hyades cluster. Many of these have complete or nearly complete orbital solutions, and will soon provide a powerful set of mass benchmarks with known ages. These systems span ages from 10-650\,Myr, offering the chance to both test pre-main-sequence models of M dwarfs \citep{2015ApJ...813L..11M,2016ApJ...817..164R,2016ApJ...818..156C,2016AJ....152..175N} and explore the role of activity on M dwarf parameters \citep[e.g.,][]{Spada2013,2018arXiv180404133K}. The current sample can be included in such work when combined with age indicators like kinematics \citep{2018MNRAS.tmp..966W}, ultraviolet flux \citep{Ansdell2015}, and rotation periods expected from the Transiting Exoplanet Survey Satellite \citep[{\it TESS},][]{2014SPIE.9143E..20R}. 


\acknowledgements
AWM was supported through Hubble Fellowship grant 51364 awarded by the Space Telescope Science Institute, which is operated by the Association of Universities for Research in Astronomy, Inc., for NASA, under contract NAS 5-26555. This work was supported by a NASA Keck PI Data Award (award numbers 1554237, 1544189, 1535910, and 1521162), administered by the NASA Exoplanet Science Institute. Data presented herein were obtained at the W. M. Keck Observatory from telescope time allocated to the National Aeronautics and Space Administration through the agency's scientific partnership with the California Institute of Technology and the University of California. The Observatory was made possible by the generous financial support of the W. M. Keck Foundation.

The authors wish to recognize and acknowledge the very significant cultural role and reverence that the summit of Mauna Kea has always had within the indigenous Hawaiian community. We are most fortunate to have the opportunity to conduct observations from this mountain.

The authors acknowledge the Texas Advanced Computing Center (TACC) at The University of Texas at Austin for providing grid resources that have contributed to the research results reported within this paper. URL: http://www.tacc.utexas.edu.

Based on observations obtained at the Gemini Observatory (acquired through the Gemini Observatory Archive), which is operated by the Association of Universities for Research in Astronomy, Inc., under a cooperative agreement with the NSF on behalf of the Gemini partnership: the National Science Foundation (United States), the National Research Council (Canada), CONICYT (Chile), Ministerio de Ciencia, Tecnolog\'{i}a e Innovaci\'{o}n Productiva (Argentina), and Minist\'{e}rio da Ci\^{e}ncia, Tecnologia e Inova\c{c}\~{a}o (Brazil). Observations taken from programs GN-2008B-Q-57, GN-2009B-Q-10, GN-2010B-Q-9, and GN-2011A-Q-26.

Based on observations collected at the European Organisation for Astronomical Research in the Southern Hemisphere under ESO programmes 071.C-0388(A), 072.C-0570(A), 073.C-0155(A), 075.C-0521(A), 075.C-0733(A), 077.C-0783(A), 078.C-0441(A), 079.C-0216(A), 080.C-0424(A), 081.C-0430(A), 082.C-0518(A), 082.C-0518(B), 085.C-0867(B), 086.C-0515(A), 086.C-0515(B), 090.C-0448(A), 091.D-0804(A), 098.C-0597(A), 382.C-0324(A), and 382.D-0754(A).

 This research has made use of the Keck Observatory Archive (KOA), which is operated by the W. M. Keck Observatory and the NASA Exoplanet Science Institute (NExScI), under contract with the National Aeronautics and Space Administration. 

Based on observations obtained at the Canada-France-Hawaii Telescope (CFHT) which is operated by the National Research Council of Canada, the Institut National des Sciences de l'Univers of the Centre National de la Recherche Scientifique of France, and the University of Hawaii. 

This work presents results from the European Space Agency (ESA) space mission Gaia. Gaia data are being processed by the Gaia Data Processing and Analysis Consortium (DPAC). Funding for the DPAC is provided by national institutions, in particular the institutions participating in the Gaia MultiLateral Agreement (MLA). The Gaia mission website is \href{https://www.cosmos.esa.int/gaia}{https://www.cosmos.esa.int/gaia}. The Gaia archive website is \href{https://archives.esac.esa.int/gaia}{https://archives.esac.esa.int/gaia}.

\software{emcee, corner.py, mpfit, scipy, pyfits, astropy, python, spextools, IDL}

\facilities{Keck:II (NIRC2), IRTF (SpeX), CFHT (PUEO, aobir), VLT:Antu (NaCo); Gemini:North (NIRI)}

\bibliography{$HOME/Dropbox/fullbiblio}


\input{sample.tex}

\input{orbit.tex}

\clearpage

\appendix 
\section{Converting Observed $\Delta K_X$ to 2MASS $\Delta K_S$ for M dwarfs} \label{sec:a1}
To place all $K$-band magnitudes on the 2MASS system, we derived a relation between $\Delta K_X$ and $\Delta K_S$ as a function of $\Delta K_X$, where $X$ denotes the particular filter (e.g., $K_{\rm{cont}}$, $K'$) used for the AO observations. For photometry, we only used observations taken with a filter somewhere in the $K$-band (all wavelengths are used for astrometry), which included observations with the narrow Bracket-Gamma filter. 

To derive a conversion between contrasts, we used the 183 absolutely-flux calibrated spectra of nearby single stars from \citet{Mann2015b}, which cover a similar range of \teff\ and $M_*$ as the sample considered here. These spectra are mostly empirical; models are only used to fill in gaps in the spectrum or regions of high telluric contamination, none of which land in the regions covered by the filters considered here.

First we randomly sampled two stars from the sample and scaled the absolute level of each spectrum by the star's distance (effectively placing both at 1\,pc). We convolved each of the two stars with the relevant filter profiles for NIRC2\footnote{\href{https://www2.keck.hawaii.edu/inst/nirc2/filters.html}{NIRC2 Filters}}, KIR\footnote{\href{http://www.cfht.hawaii.edu/Instruments/Filters/kir.html}{KIR Filters}}, NIRI\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/imaging/filters}{NIRI Filters}}, and NaCo\footnote{\href{http://www.eso.org/sci/facilities/paranal/instruments/naco/inst/filters.html}{NACO Filters}}, and integrate over the wavelength range of the filters to compute the flux ($F$) in a given band. We used a filter profile for 2MASS $K_S$ from \citet{2003AJ....126.1090C}. The $\Delta K_X$ value for the given pair was then computed as $2.5log_{10}(F_1/F_2)$. 

We repeated this process with 5000 unique combinations of the 183 stars for 12 different filter/instrument combinations. For each filter and instrument combination we computed a best-fit line to $\Delta K_S -\Delta K_X$ as a function of $\Delta K_X$. We show four examples in Figure~\ref{fig:mags}. For the majority of the filters considered, the trend is insignificant compared to errors in the underlying spectra and absolute calibration ($\simeq0.02$\,mag). We did not apply a correction in these cases. 

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{NACO_Ks.eps}
\includegraphics[width=0.47\textwidth]{NIRC2_BrG.eps}
\includegraphics[width=0.47\textwidth]{KIR_Kp.eps}
\includegraphics[width=0.47\textwidth]{NIRC2_Kcont.eps}
\caption{Difference between 2MASS $\Delta K_S$ and four example $\Delta m$ values measured from our AO imaging, built from a grid of absolutely-calibrated spectra and the filter profiles provided for each filter. No corrections are applied for the NIRC2 Bracket-Gamma (BrG) and $K_S$ (K-short) filter, as the trend is not significant compared to potential systematic issues in the calibration of the underlying spectra. }
\label{fig:mags}
\end{center}
\end{figure*}

We did not see a significant difference in any derived correction based on the metallicity of the component stars, as expected based on how [Fe/H] changes $K$-band flux levels (Figure~\ref{fig:metal}). Thus we did not attempt to include [Fe/H] in these relations. We also found no significant effect as a function of the mass of the primary. However, this was difficult to test due to limitations of the input sample. The \citet{Mann2015b} spectral sample covers K7 to M7, but is poorly populated on the extreme ends. While we can make a wide range of combinations of low-contrast systems (M0+M0 to M6+M6), we have limited options for high-contrast (where primary can only be $\sim$ K7-M1) systems where temperature effects would be most clear.

\clearpage

\section{Orbits of binaries}\label{sec:orbitplots}

Here we show diagnostic plots of each of the binaries in our sample. Details of the input points data can be found in Section~\ref{sec:ao} for data analyzed in this paper and in Section~\ref{sec:litas} for astrometry from the literature. The orbital fitting method is described in Section~\ref{sec:orbit}.

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1005AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ2005AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ22AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl54AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1038AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ65AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP9724AB.eps} %%Gl 84
\includegraphics[width=0.32\textwidth]{Orbits/PMJ02133+3648AB.eps} 
\includegraphics[width=0.32\textwidth]{Orbits/HD15285AB.eps} %% Gl98
\caption{Orbital fit for each binary fit in this paper. The black star marks the primary (always at 0, 0). The best-fit (highest likelihood) is shown as a black line, with 50 randomly selected orbit fits from the MCMC shown in grey to provide an estimate of the uncertainties. In some fits, the range of orbital solutions is so small that the grey lines are not visible underneath the best-fit black line. Points are individual separation and position angle measurements with adopted uncertainties, color-coded by the data source (Gemini/NIRI in light blue, VLT/NaCo in blue, CFHT/PUEO in light red, Keck/NIRC2 in dark red, and literature data in green). The dashed line is the line of nodes, the dotted line indicates periastron passage, and the arrow marks the direction of motion. }
\label{fig:orbits1}
\end{center}
\end{figure*}

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/HIP11542AB.eps} %% Gl99
\includegraphics[width=0.32\textwidth]{Orbits/Gl125AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl190AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1081AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ234AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3412AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3421AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl263AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl277AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3454AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl301BAB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl310AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits2}
\end{center}
\end{figure*}


\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl330AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/LHS6167AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ340AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP46706AB.eps}%% Gl352
\includegraphics[width=0.32\textwidth]{Orbits/Gl381AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ416AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl469AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl473AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl494AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ570AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ600AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ623AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits3}
\end{center}
\end{figure*}

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1210AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl660AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ661AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ4024AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl695AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl747AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ748AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP95995AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP96656AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1245AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl7912AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl804AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits4}
\end{center}
\end{figure*}


\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl831AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl844AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HD239960AB.eps} 
\includegraphics[width=0.32\textwidth]{Orbits/GJ4287AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl8934AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl900AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl913AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits5}
\end{center}
\end{figure*}

\clearpage
\input{astrom_table.tex}


\end{document}
