\documentclass[twocolumn]{aastex62}
%\documentclass[iop,revtex4]{emulateapj}
\let\pwiflocal=\iffalse \let\pwifjournal=\iffalse
\input{setup}
\usepackage[outdir=./]{epstopdf}

\newcommand{\ktwo}{{\it K2}}
\newcommand{\av}{$A_V$}
\newcommand{\mks}{$M_{K_S}$}
\newcommand{\mmk}{$M_{K_S}-M_*$}
\usepackage{mathrsfs}
%\usepackage[colorlinks=true,urlcolor=blue,citecolor=black]{hyperref}
%\usepackage{xcolor}
%\usepackage[colorlinks = true,
% linkcolor = blue,
% urlcolor = blue,
% citecolor = blue,
% anchorcolor = blue]{hyperref}
%\newcommand{\href}{\href}%
%\newcommand{\href}[3][blue]{\href{#2}{\color{#1}{#3}}}%
%\slugcomment{To be Submitted to ApJ}

\shorttitle{Mass-luminosity relation of cool stars}
\shortauthors{Mann et al.}
\submitjournal{The Astrophysical Journal}


\bibliographystyle{apj}


\begin{document}
 
\title{How to Constrain your M dwarf II:\\ the mass-luminosity-metallicity relation from 0.70$M_\odot$ to 0.075$M_\odot$
%$M_*$-$M_{K_S}$ relation from 0.7$M_\odot$ to 0.075$M_\odot$%. \\
%or \\
%How to constrain your M dwarf II: \\
 %the $M_*$-$M_{K_S}$ relation from 0.7$M_\odot$ to 0.075$M_\odot$
 } 
 

\correspondingauthor{Andrew W. Mann}
\email{mann.andrew.w@gmail.com}

\author[0000-0003-3654-1602]{Andrew W. Mann}
\altaffiliation{Hubble Fellow}
\affiliation{Columbia University, Department of Astronomy, 550 West 120th Street, New York, NY 10027}
\affiliation{Department of Physics and Astronomy, University of North Carolina at Chapel Hill, Chapel Hill, NC 27599-3255, USA}

\author[0000-0001-9823-1445]{Trent Dupuy}
\affiliation{Gemini Observatory, Northern Operations Center, 670 N. Aohoku Place, Hilo, HI 96720, USA}
 
\author[0000-0001-9811-568X]{Adam Kraus}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0002-5258-6846]{Eric Gaidos}
\affiliation{Department of Geology \& Geophysics, University of Hawaii at M\={a}noa, Honolulu, Hawaii 96822 USA}

\author[0000-0001-9982-1332]{Aaron Rizzuto}
\altaffiliation{51 Peg b Fellow}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0002-6194-043X]{Michael Ireland}%
\affiliation{Research School of Astronomy \& Astrophysics, Australian National University, Canberra ACT 2611, Australia}

\author[0000-0003-4142-9842]{Megan Ansdell}%
\affiliation{Department of Astronomy, University of California at Berkeley, Berkeley, CA 94720, USA}

%\author{Jean-Luc Beuzit}
%\affiliation{Observatoire de Grenoble, Institut de Planetologie et d'Astrophysique de Grenoble, BP 53, 38041 Grenoble Cedex 9, France}

\author[0000-0001-7730-2240]{Jason Dittmann}
\altaffiliation{51 Peg b Fellow}
\affiliation{Massachusetts Institute of Technology, 77 Massachusetts Avenue, Cambridge, Massachusetts 02138, USA}
%\affiliation{Harvard-Smithsonian Center for Astrophysics, 60 Garden St., Cambridge, MA, 02138}

\author[0000-0002-6879-3639]{Chao-Ling Hung}
\affiliation{Department of Physics, Manhattan College, 4513 Manhattan College Parkway, Riverdale, NY 10471, USA}

\author[0000-0002-8332-8516]{Samuel Factor}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

%\author[0000-0003-0536-4607]{Thierry Forveille}
%\affiliation{Observatoire de Grenoble, Institut de Planetologie et d'Astrophysique de Grenoble, BP 53, 38041 Grenoble Cedex 9, France}

\author[0000-0001-6301-896X]{Raquel A. Martinez}
\affiliation{Department of Astronomy, The University of Texas at Austin, Austin, TX 78712, USA}

\author[0000-0003-3573-8163]{Dary Ru\'iz-Rodr\'iguez}
\affiliation{Chester F. Carlson Center for Imaging Science, School of Physics \& Astronomy, and Laboratory for Multiwavelength Astrophysics,
Rochester Institute of Technology, 54 Lomb Memorial Drive, Rochester NY 14623 USA}
\affiliation{Research School of Astronomy and Astrophysics, Australian National University, Canberra, ACT 2611, Australia}

\watermark{Draft}

\begin{abstract}
The mass-luminosity relation for late-type stars has long been a critical tool for estimating masses of late-type stars. Recent advancements in techniques to measure [Fe/H] for M dwarfs, an increasing number of benchmark systems near the hydrogen burning limit, the availability of {\it Gaia} parallaxes, and the need for higher-precision masses of cool stars motivate an update to existing empirical mass-luminosity relations. Here we present an empirical relation between \mks\ and $M_*$ spanning 0.70$M_\odot$ down to the hydrogen burning limit ($\simeq0.075M_\odot$). The relation is calibrated from 61 nearby binary systems, whose orbits we determine using a a combination of our own monitoring with NIRC2 on Keck, archival adaptive optics data, and astrometry from the literature. Using these orbits and Kepler's law, we determine total masses of each system to better than 1\% in the best cases (median precision of 6.1\%). We join our mass determinations with resolved \mks\ magnitudes for binary component stars to derive an empirical \mmk\ relation, which yields masses of single stars to 2-3\% for $0.18M_\odot<M_*<0.70M_\odot$, and 3-6\% for $0.075M_\odot<M_*<0.18M_\odot$. Our relation is mostly consistent with earlier work, with differences attributable to issues with the input sample. We find [Fe/H] has a weak effect on the \mmk\ for the range of metallicities expected in the Solar neighborhood ($\simeq$1\% change in $M_*$), but may exceed uncertainties in the relation ($>3\%$) for subdwarfs. Our results also suggest that evolutionary models likely overestimate the role of [Fe/H] on the \mmk\ relation, but the difference is not significant with the current sample. Future studies can build on this sample to further explore the role of [Fe/H], as well as the effects that activity and youth have on the mass-luminosity relation.
\end{abstract}

\keywords{stars: fundamental parameters; stars: low-mass; stars: luminosity function, mass function}
\NewPageAfterKeywords

% without latex:

%% To do:
%% Applications section (Trappist-1, etc.)
%% compare mass ratios (ARGHHHH!!) We are going to punt this for now
%% fit with an extra error term  (this is almost done,I hope!)
%% general improvement of plots in appendix (almost done)


\section{Introduction}\label{sec:intro}
Over the past decade, M dwarfs have become critically important across a wide range of astrophysics. On the small scale, M dwarfs have become attractive targets for the identification and characterization of exoplanets. The small size, low mass, and low luminosity of late-type dwarfs facilitates the discovery of small \citep[e.g.][]{Muirhead2012,Martinez:2017aa,Mann:2018} and habitable-zone \citep[e.g.,][]{Tarter2007,Shields:2016aa,2017Natur.544..333D}. Close-in, rocky planets are also significantly more common around M dwarfs than their Sun-like counterparts \citep{Dressing2013,2013PNAS..11019273P,Mulders2015,Gaidos2016b}, and are more likely to harbor close-in multi-planet systems \citep[e.g.,][]{Muirhead2015,Ballard2016}.

The properties of both Milky Way and more distant galaxies are inexorably linked to the properties of their most numerous constituents \citep[$>$70\% of stars in the Solar neighborhood are M dwarfs,][]{Henry:1994fk,Reid:2004lr}. Late-type dwarfs weigh heavily on the Galactic mass function \citep[e.g.,][]{Covey:2008lr}, and are useful probes of the Milky Way's structure \citep[e.g.,][]{2008ApJ...673..864J,2017ApJ...843..141F}, kinematics \citep[e.g.,][]{2007AJ....134.2418B,2015RAA....15..860Y} and chemical evolution \citep{Woolf:2012lr,2015AJ....149..140H}. Although K and M dwarfs are much fainter than their higher-mass counterparts, they are numerous enough to impact the integrated light of many massive galaxies, so M dwarf fundamental properties are an essential component of the initial mass function \citep[e.g.,][]{2012ApJ...747...69C,2016ApJ...821...39M} and mass-to-light ratio \citep{2015MNRAS.452L..21S} in nearby galaxies. M dwarf - white dwarf pairs are even a plausible progenitor for Type Ia supernovae \citep{2012ApJ...758..123W}, and hence may be important on cosmological scales.

%Late-type stars also play an important role on extragalactic and potentially cosmological scales. Recent non-detection of Type Ia supernovae progenitors have shifted the field from single-degenerate origins (evolved star and a white dwarf) towards a double-degenerate model (two white dwarfs), however, single degenerate models with an M dwarf and a white dwarf are still plausible . 

For all these areas, it is essential that we have a method to estimate the fundamental parameters of late-type dwarfs. Spectra, photometry, and distances of stars provide a relatively direct means to measure \teff\ \citep[e.g.,][]{Rojas-Ayala:2012uq,Mann2013c}, luminosity \citep[e.g.,][]{2002AJ....124.2721R}, metallicity \citep[e.g.,][]{2005A&A...442..635B,2010ApJ...720L.113R}, and radii \citep[e.g., via Stefan-Boltzmann, ][]{Newton2015A,2018arXiv180404133K}. Masses, however, are much more difficult to infer from observational data alone. 

In the case of a binary, it is possible to directly determine the mass of a star through Kepler's laws, provided the orbit can be mapped out on reasonable timescales. For shot-period systems, this can be done by monitoring the radial velocity variation of binary components, which can yield a measurement of individual component masses, but is limited by constraints on the orbital inclination. In systems where binary components can be spatially resolved, monitoring of the position and separation of the binary can yield a measurement of the total system mass, assuming the parallax is known or measurable from the same astrometry. 

For single stars, mass estimates can be derived from evolutionary models \citep[e.g.,][]{Muirhead2012a,2012ApJ...747...69C}. However, differences between empirical and model-predicted mass-radius and radius-luminosity relations for late-type stars \citep[e.g.,][]{Boyajian2012,Feiden2012a} raise concerns about the reliability of model-based masses. Further, the masses derived depend on both the model grid used \citep{Spada2013,MIST1}, and the observed parameter over which the interpolation is done \citep[e.g., color versus luminosity,][]{Mann:2012,Mann2015b}. Ultimately, these models need to be tested, and if necessary, refined. 

A more empirical approach to estimating single-star masses is to use a relation between mass and luminosity \citep[e.g.,][]{Henry:1993fk, Delfosse2000}, calibrated using binaries with more direct mass determinations. Absolute magnitude is usually used as an easily measured proxy for luminosity. Models predict a tighter relation using NIR bands than for optical, as the effect of detailed abundances on the absolute flux levels of M dwarfs is is much weaker past 1.2\um\ when compared to bluer regions of the spectrum. As a result, the $M_K-M_*$ relation provides the most precise masses and has become the most commonly used relation. 

%, as methods to measure precise spectroscopic metallicities of M dwarfs have only recently become possible recently \citep[e.g.,][]{2010ApJ...720L.113R,2014A&A...568A.121N}, previous studies were unable to test what role metallicity does have on the $M_K$-mass relation, if any. 
%This method is effective for stars below $\simeq0.7M_\odot$, as the relation between mass and luminosity changes negligibly on Gyr timescales \citep{BHAC15,MIST1}. 

The empirical mass-luminosity relations of \citet{Henry:1993fk} and \citet{Delfosse2000} provide mass determinations with $\simeq$10\% precision, with more recent improvements by \citet{Benedict2016}. As fields that rely on M dwarf parameters have pushed to higher precision, there has been need for proportionately improved precision on M dwarf masses. With he arrival of {\it Gaia} parallaxes late-type dwarfs even beyond the Solar neighborhood will have $<1\%$ parallaxes, making scatter in the \mmk\ relation the primary source of error. Existing relations have gaps in their calibration sample, particularly below $0.1M_\odot$ and could not investigate the impact of metallicity on the \mmk\ relation. 

Here we present a revised empirical relation between $M_*$ and $M_{K_S}$ spanning almost an order of magnitude in mass, from 0.075$M_\odot$ to 0.70$M_\odot$. The relation is built on orbital fits to visual binaries from a combination of adaptive optics imaging and astrometric measurements in the literature. In Section~\ref{sec:targets} we detail our selection of nearby late-type binaries with orbits amenable to mass determinations. We overview our astrometric and spectroscopic observations in Section~\ref{sec:obs}, including those from telescope archives and the literature. Our orbit-fitting procedure is explained in Section~\ref{sec:orbit}. We describe our method to determine other parameters of each system ([Fe/H], distance, and \mks) in Section~\ref{sec:params}. Our method and results from fitting the \mmk\ relation is described in Section~\ref{sec:relation}, including an analysis of the errors as a function of \mks, a detailed look at the effects of [Fe/H], and a comparison to earlier relations. We conclude in Section~\ref{sec:discussion} with a brief summary, and a discussion of the important caveats and complications to consider when using our relation, as well as future directions we are taking to expand on the work given here.

 {\it If you want to use the relations in this manuscript, we advise at least reading Section~\ref{sec:caveats} to understand the potential limitations of our provided \href{https://github.com/awmann/M_-M_K-}{program and posteriors}.}


\section{Target Selection}\label{sec:targets}
%$0.075M_\odot \lesssim M_* \lesssim0.70M_\odot$ stars on their main sequence

Our selection of binaries was designed to sample the region of mass space over which the mass-luminosity relation should not evolve significantly between the zero-age main sequence and the age of the Universe. We quantified this using the \citet{BHAC15} models, which we show in Figure~\ref{fig:age}. Above $0.75M_\odot$, a fixed luminosity (the observable) could correspond to a $\simeq$5\% range in masses over 1-10\, Gyr. Stars with $\simeq0.1M_\odot$ take a long time (100-1000\,Myr) to arrive on the main sequence, but obey a tight relation beyond this point. Those objects below $\simeq0.08M_\odot$ are predicted to never reach the main sequence and hence obey no mass-luminosity relation (although this transition likely depends on metallicity). We therefore attempt to select systems spanning $0.075M_\odot \lesssim M_* \lesssim0.70M_\odot$.

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Model_age2.eps}
\caption{Stellar luminosity as a function of mass predicted by the \citet{BHAC15} models, color-coded by age (metallicity fixed at Solar). The grey regions denote masses excluded by this study due to a significant age dependence on the mass-luminosity relation.}
\label{fig:age}
\end{center}
\end{figure}

We first selected systems by cross-matching catalogs of nearby M dwarfs \citep{Lepine:2013, Gaidos2014, 2014ApJ...784..156D,Winters2015}, with the fourth catalog of interferometric measurements of binary stars \citep[INT4,][]{Hartkopf:2001}, and adaptive optics (AO) images from the Keck Observatory Archive (KOA). As part of this cross-match, we also included targets matching the M dwarf selection criteria of \citet{Gaidos2014}, but with a bluer color cut ($V-J>1.8$) to incorporate additional late-K dwarfs. We kept any binaries with separations less than 5\arcsec. We then added in other known late-type binaries from \citet{2008MNRAS.384..150L}, \citet{Janson2012}, \citet{Jnn2014}, and \citet{Ward-Duong2015}. This provided a list of more than 300 systems.

From here we selected those for which we expect to be able to obtain a precise orbit on a reasonable (few year) timescale. We assumed the average of available separation measurements represented the typical semi-major axis. We then identified systems for which we would have at least 30\% of the orbit within the two years of our orbital monitoring program with Keck. This cut accounted for existing data. As a result, long-period binaries with extensive previous observations were included, depending on the baseline available, while those with only a single epoch would generally need to have orbits of $\ll$10 years to be observed. After this cut we were left with 125 systems. With the exception of 38 systems in the far South ($\delta<-30^\circ$, outside the range of Keck), all of these were included in our observing program.

We removed 21 systems from our analysis because of an unresolved tertiary (or quaternary) component noted in the literature \citep[e.g.,][]{2010ApJ...720.1727L,2002A&A...382..118T,2018ApJS..235....6T}. In their current form, such systems are not useful for our analysis, as we have no $\Delta K$ magnitudes or mass ratios for the unresolved components. Since many of these are double- or triple-lined systems, it is possible to recover their parameters with multi-epoch radial velocities, and some systems already have the necessary data in the literature \citep[e.g.,][]{Sgr2000}. We are actively monitoring these systems with high-resolution near-infrared spectrographs \citep{2010SPIE.7735E..1MY,Park2014,2012SPIE.8446E..2CR}, but they are excluded from the analysis done here. Triples where the third component is more distant (and well resolved) were retained.

A total of 18 systems were flagged as young, all of which were tagged to nearby young moving groups or clusters \citep{Shkolnik2012, Kraus2014, Gagne2014, Malo2014a, Gagne2015, 2017AJ....153...95R, 2017AJ....154...69S, Rizzuto2017, 2018MNRAS.475.2955L}. We continued to monitor these targets even after flagging them as young, but they were not included in the analysis for this paper. Many of these are expected to be pre-main-sequence stars and hence will not follow the same mass-luminosity relation. Even for those that are on the main-sequence, such young M dwarfs may have higher luminosities for a given mass \citep[e.g.,][]{2015ApJ...807....3K,Stassun2012,Somers2017}. These young systems will be the subject of a future study into the effects of age and activity on the parameters of M dwarfs. We note that this did not remove any young stars in the field population.

After the completion of our observing program, we removed targets for which we had $<$30\% of the orbit or fewer than six unique measurements. We attempted to fit orbits of the remaining 70 systems (Section~\ref{sec:orbit}). Seven of the orbits fits failed to converge, mostly because their semi-major axes were much larger than expected (e.g., eccentric systems caught near periapsis). An additional 14 were removed because the derived mass for the system was too imprecise (errors $>$25\%) to be useful. Most of these 14 were systems with a poor or no parallax. This left us with 53 binaries (106 stars).

We added in eight targets with orbits from \citet{Dupuy2017}, primarily to fill in the sample around the end of the M dwarf sequence. These eight were selected because they are massive enough to sustain hydrogen fusion and satisfy all our other selection criteria. Systems from \citet{Dupuy2017} also had their orbits fit using a nearly identical method to our own, often using similar or identical data and observational methods (primarily Keck/NIRC2). 

Basic parameters of the final 61 systems included in our analysis are given in Table~\ref{tab:sample}.

\section{Observations and Data Reduction}\label{sec:obs} 

\subsection{Near-infrared Spectra with IRTF/SpeX}

To estimate the metallicities of our targets we obtained near-infrared spectra for 59 of 61 targets using the SpeX spectrograph \citep{Rayner2003} on the NASA Infrared Telescope Facility (IRTF) atop Maunakea. Observations were taken between May 2011 and November 2017. Most data were taken as part of programs to characterize the fundamental properties of nearby M dwarfs \citep[e.g.,][]{Mann2013c,Gaidos2014,Terrien2015}. All spectra were taken in SXD mode, providing simultaneous wavelength coverage from 0.9 to 2.5$\mu$m. For 57 of the targets, observations were taking using the 0.3$\times15\arcsec$ slit, which yielded a resolution of $R\simeq2000$. Spectra for three targets were taken from \citet{2009ApJ...706..328D}, \citet{Dupuy2012}, or \citet{Dupuy2017}, using the 0.5$\times15\arcsec$ or 0.8$\times15\arcsec$ slits, which gave spectral resolutions of $\simeq$750-1500. 

For Gl 65 and HD 239960 the SpeX slit was aligned to get spectra of both targets simultaneously. For all other targets the binary was unresolved or too poorly resolved to separate in the reduction procedure, and instead the slit was aligned with the parallactic angle. Each target was nodded between two positions along the slit to remove  sky background. Depending on the target brightness and conditions, between 6 and 30 individual exposures were taken following this nodding pattern, with exposure times varying from 8s to 180s. An A0V-type star was observed immediately before or after each target to measure (and remove) telluric lines and flux calibrate the spectrum. The final stacked spectra had S/N of $>100$ per resolving element in the $K$-band for all but the four faintest targets (which had S/N$>50$). 

Basic data reduction was performed with \textit{SpeXTool} package \citep{Cushing2004}. This included flat fielding, sky subtraction, extraction of the one-dimensional spectrum, wavelength calibration, stacking of individual exposures, and merging of separate orders. Telluric lines were removed and the spectrum was flux calibrated using the A0V star observations and the \textit{xtellcor} software package \citep{Vacca2003}. When possible, the same A0V star was used for multiple targets taken near each other in time. 

Two of the three targets lacking a SpeX data are too warm (earlier than K5) to derive a metallicity from NIR spectra (Gl 792.1 and Gl 765.2), and the third (Gl 54) is too far south to be observed with IRTF. 

\subsection{Adaptive Optics Imaging and Masking}\label{sec:ao}

We analyzed a mix of AO data from our own program with Keck/NIRC2 and archival imaging from the Keck II Telescope, the Canada France Hawaii Telescope (CFHT), the Very Large Telescope (VLT), and the Gemini North Telescope. In general we analyzed all usable images (e.g., non saturated, components resolved) regardless of observing mode and filter. 

For our analysis, we considered a single dataset a collection images with a unique filter, target, or observing date. Each combined dataset consisted of a  $\Delta m$ (for a given filter), separation, and position angle. 

We separate the observations and reduction by instrument/telescope below. The full list of astrometry and contrast measurements is given in Table~\ref{tab:astrom}, sorted by target. 

\subsubsection{Keck II/NIRC2 Imaging and Masking}

As part of a long-term monitoring program with Keck II atop Maunakea, between June 2015 and November 2017 we observed 49 of the 53 multiple-star systems fit in this paper. All observations were taken using the facility AO imager NIRC2 using the vertical angle mode (fixed angle relative to elevation axis) and the narrow camera ($\approx$10\,mas\,pixel$^{-1}$). Depending on target brightness and observing conditions, imaging was usually taken with either the $K'$ ($\lambda_c=2.124$\um) or narrow $K_{\rm{cont}}$ ($\lambda_c=2.2706$\um) filters, and non-redundant aperture masking (NRM) was always taken using the 9-hole mask and $K'$ filter. After acquiring the target and allowing the AO loops to close, we took four to 10 images or 6-8 interferograms, adjusting coadds and integration time based on the brightness of the target. As most of our targets are bright, observations were generally taking using the Natural Guide Star (NGS) system \citep{2000PASP..112..315W,2004ApOpt..43.5458V}, only utilizing the Laser Guide Star (LGS) mode for the faintest ($R\gtrsim13$) targets or in mixed conditions. In total, our observations provided 154 datasets.

In addition to our own data, we downloaded images from the Keck Observatory Archive (KOA), spanning March 2002 to November 2015, all also taken with the NIRC2 imager. Archive data comprised a wide range of observing modes, filters, and cameras, although the majority was taken with the narrow camera and one of the $H$- or $K$-band filters. We included nearly all data with clear detections of both binary components independent of the observing setup. We discarded saturated images, those taken with the coronagraph atop one or both binary components, and those with extremely poor AO correction. A total of 40 datasets were used from the archive. 

The same data reduction was applied to both observations from our own program and those from the archive, following our custom procedure described in \citet{Kraus2016a}. To briefly summarize, we linearized each frame then dark and flat corrected using calibration data taken the same night. In cases where no appropriate darks or flats were taken in the same night, we use a set from the nearest available night. We interpolated over ``dead'' and ``hot'' pixels, which were identified from superflats and superdarks built from data spanning 2006 to 2016. Because flats are rarely taken in narrowband filters, we used superflats built from the nearest (in wavelength) broadband filter where appropriate (e.g., for $K_{\rm{cont}}$ we used $K$ or $K'$). Pixels with flux levels $>10\sigma$ above the median of the eight adjacent pixels (primarily cosmic rays) were replaced with the median (average of the 4th and 5th ranked). Images were visually inspected as part of identifying the binary location, and a handful ($<$1\%) of images were negatively impacted by our cosmic ray removal (e.g., removal of part of the source). These images were manually corrected.


\subsubsection{CFHT/PUEO Imaging}

We obtained data for 31 of our targets the Canadian Astronomy Data Centre take with the 3.6m Canada-France-Hawaii Telescope (CFHT) using the Adaptive Optics Bonnette \citep[AOB, often referred to as PUEO after the Hawaiian owl,][]{1994SPIE.2201..833A} and the KIR infrared camera \citep{1998SPIE.3354..760D}. After removing bad observations (e.g., saturated, unresolved, or poor AO correction), 226 datasets were included. Observations spanned December 1997 to January 2007, covering most of the time PUEO was in use at CFHT (1996 to 2011). Most observations were taken in a few-year period from 2000 to 2003. Observations spanned a range of filters across $JHK$ bands, but the majority used either the narrowband [Br$\gamma$] or [FeII] filters. All observations used a 3-5 point dither pattern and took at least two images at each dither location. 

Data reduction for PUEO observations followed the same basic steps as our NIRC2 data. We first applied flat-fielding and dark correction using a set of superflats and superdarks built by splitting the datasets into 6 month blocks and combining calibration data within the same time period. We identified bad pixels by making large median stacks of science data taken across dozens of objects, which were then replaced with the median of the eight surrounding pixels To identify cosmic rays, we median stacked consecutive images of each target (at a fixed location), then compared the stack to individual images. Pixels $>10\sigma$ above the robust mean of the stacks are replaced with the median of the eight surrounding points. Because PUEO/KIR data were taken in sets of $>$5 images before the object was dithered, this median stacking was effective for removing nearly all cosmic rays.


\subsubsection{VLT/NaCo Imaging}

We downloaded AO-assisted images from the ESO archive taken with the Nasmyth Adaptive Optics System Near-Infrared Imager and Spectrograph (NAOS-CONICA, or NaCo) instrument on VLT. Data spanned November 2001 to October 2016, with about half of these 70 datasets taken from 2001 to 2005. Based on the program abstracts, $\lesssim$1/2 of the observations were meant to use these binaries as astrometric or photometric calibration (e.g., science case is unrelated to M dwarfs or binaries). Data were available for 20 of our targets, excluding saturated or otherwise unusable data. Observations were taken with a wide range of filters, cameras, and observing patterns, but the majority were taken using the S13 camera ($\approx$13\,mas\,pixel$^{-1}$) with either broadband $K_s$ and $L$, or narrowband [FeII] and [Br$\gamma$] filters, and always following a 2-4 point dither pattern. 

Basic data reduction was applied to NaCo images following a similar procedure as with the PUEO and NIRC2 data. We applied flat-fielding and dark corrections to each observation using the standard set of calibrations taken each night as part of the VLT queue. In the case where calibration (dark or flat) images were missing or unusable, we used the nearest (in time) set of calibration images matching the filter (for flats) and exposure setup (for darks). Flats taken in broadband filters were used for flat-fielding narrow-band images at similar wavelengths. We built bad pixel masks using median stacks of all images taken within a night after applying flat and dark corrections. To identify and remove cosmic rays we used the L.A. Cosmic software \citep{2001PASP..113.1420V}.


\subsubsection{Gemini/NIRI Imaging}

We retrieved 39 datasets for 8 of our targets from the Gemini archive, all taken with the AO imager NIRI \citep{2003PASP..115.1388H} on the Gemini North Telescope. All observations were taken between August 2008 and February 2011 and were taken with the assistance of the ALTtitude conjugate Adaptive optics for the InfraRed (ALTAIR). Most observations were taken with the f32 camera ($\approx$21\,mas\,pixel$^{-1}$) using broadband $J$-, $H$-, or $K$-band filters. All observations followed a 2-4 point dither pattern and took at least two images at each dither location. 

Data from NIRI were reduced using the same basic tools as for all other adaptive optics data. First, we applied flat and dark corrections to each set of images using the standard calibration images taken as part of the Gemini queue, usually within 24h of the target observations. In most cases, flats taken in broadband filters were used for narrowband flat-fielding. We then identified bad pixels from median stacking all images within a given night. Observations with a target near or on top of a heavily impacted pixel were discarded (identified with the mask). We used the L.A. Cosmic software for the identification and removal of cosmic rays. 

\section{Measuring astrometry and photometry}\label{sec:astrometry}

Extracting separations and position angle measurements followed a similar multi-step procedure across all instruments, excluding the NRM data (which is described below). Our method is based largely on that described in \citet{2016ApJ...817...80D} and \citet{Dupuy2017}, which is built on the techniques from \citet{2008ApJ...689..436L} and \citet{2010ApJ...721.1725D} and we briefly describe here. 

We first cross-correlated each image with a model Gaussian PSF to identify the most significant peaks. The cross-correlation peak occasionally centers on instrumental artifacts, often struggles to separate out partially overlapping binaries, and can easily identify the wrong source for triple systems. So this step was checked by eye and updated as needed. The eye-check phase also allowed us to manually remove data of poor quality: e.g., no or poor AO correction, saturated data, or an unresolved system. We used these centers as the initial guess for the $X, Y$ pixel position used in the next phase. 

We then fit the PSF centers by either: 1) fitting the binary image with a PSF modeled by three-component elliptical 2D Gaussians using the least-squares minimization routine MPFIT \citep{Markwart2009}, or 2) running StarFinder, a routine designed to measure astrometry and photometry from adaptive optics data by deriving a PSF template from the image and iteratively fitting this model to the components \citep[for more details see][]{2000A&AS..147..335D}. Although the results of these two methods generally agreed, StarFinder was preferred, as it used a more realistic model of the PSF and worked even with mediocre AO correction provided the component PSFs were well separated. StarFinder, however, failed on the tightest binaries, where it was unable to distinguish two stars and thus incorrectly built a pathological, extended PSF that fit the blended image. The Gaussian fit was used for any case where StarFinder failed. 

As part of the PSF fit, both methods provide a flux ratio of the PSF normalization factors, which we used this to determine $\Delta m$ in the relevant band. Data from all filters are used for astrometry, although only $\Delta K$ magnitude measurements were used in the estimate of \mks\ (Section~\ref{sec:mags}).

PSF fitting provides pixel-position ($x$, $y$) measurements of each component, but converting these to separation and position angle (PA) on the sky requires an astrometric calibration of the instrument. For the NIRC2 narrow camera, we used the \citet{Yelda2010} distortion solution for data taken before 2015 Apr 13 UT, and \citet{2016PASP..128i5004S} for data taken after this. These calibrations include a pixel scale and orientation determination of 9.952$\pm$0.002 mas\,pixel$^{-1}$ and $0.252\pm0.009^\circ$ for the former, and 9.971$\pm$0.004 mas\,pixel$^{-1}$ and $0.262\pm0.020^\circ$ for the latter. For the NIRC2 wide camera we used the solution from Fu et al. (2012, priv. comm.)\footnote{\href{http://homepage.physics.uiowa.edu/~haifu/idl/nirc2wide/}{http://homepage.physics.uiowa.edu/$\sim$haifu/idl/nirc2wide/}}, with a pixel scale of $39.686\pm0.008$ mas\,pixel$^{-1}$ and the same orientation as the narrow camera. 

For the f32 camera on NIRI, we used the distortion solution from the Gemini webpage\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/undistort.pro}{http://www.gemini.edu/sciops/instruments/niri/undistort.pro}}. For other instruments and cameras data were always taken following a dither pattern to sample different regions of the CCD distortion pattern. So the RMS between dithered images should reflect errors due to uncorrected distortion (which is included in our errors; see below). For KIR, we adopted a pixel scale of 34.8$\pm$0.1 mas pixel$^{-1}$ \citep{2003ApJ...589..410S} and an orientation of $0\pm2^\circ$\footnote{\href{http://www.cfht.hawaii.edu/Instruments/Detectors/IR/KIR/}{KIR specifications, filters, and performance.}}. For NaCo, we assumed a pixel scale of 13.24$\pm0.05$ mas pixel$^{-1}$ for the S13 camera \citep{2003A&A...411..157M,2005A&A...435L..13N} and the values given in the ESO documentation for all others\footnote{\href{http://www.eso.org/sci/facilities/paranal/instruments/naco/doc.html}{NaCo Documentation, user manual, calibration, and reduction.}} (with the same error). The rotation taken from the NaCo headers was assumed to be correct to 0.4$^\circ$ \citep{Sef2008}. For NIRI observations, we used a pixel scale provided by Gemini\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/imaging/pixel-scales-fov-and-field-orientation}{NIRI pixel scales, field of view, and field orientation.}} for each camera (117.1, 49.9, and 21.9 mas pixel$^{-1}$ for f6, f14, and f32, respectively), with a global uncertainty of 0.05 mas pixel$^{-1}$ on the pixel scale and 0.7$^\circ$ on the orientation. The NIRI orientation error was determined using observations of the same target between observing runs (separated by weeks to months), but over which no orbital motion should have been visible ($P>$50 years). 

Extraction of separations and position angles from of masking observations followed the appendix of \citet{Kraus2008} with the aid of the latest version of the `Sydney' aperture-masking interferometry code\footnote{\href{https://github.com/mikeireland/idlnrm}{https://github.com/mikeireland/idlnrm}}. To remove systematics, the observation of each target observed with NRM was paired with a calibration observation of another nearby star taken in the same night with a similar magnitude and airmass. Binary system profiles were then fit to the closure phases to produce estimates of the separation, position angle, and contrast of the binary components. More details on the analysis of masking data can be found in \citet{2006ApJ...650L.131L}, \citet{Kraus2008} and \citet{2012ApJ...744..120E}.

Data from a single night and with the same filter and target were combined into a single measurement (after applying all corrections above), with errors estimated using the RMS in the individual images within a night. This scatter across images was combined with the uncertainty in the orientation and pixel scale in quadrature. We assumed pixel scale and orientation uncertainties were correlated within a night and filter (so they do not decrease with $\sqrt{N}$). 

We applied an additional correction for differential atmospheric refraction \citep{2010SPIE.7736E..1IL} using filter wavelength information and weather data from the header (for VLT) or from the CFHT weather archive\footnote{\href{http://mkwc.ifa.hawaii.edu/archive/wx/cfht/}{CFHT weather archive.}} (for Keck, CFHT, and Gemini). We neglected the chromatic component of this effect as the correction is already small compared to measurement errors. 


\subsection{Literature Astrometry}\label{sec:litas}

We also include astrometric measurements from the literature for 51 of the 53 binaries in our sample. To help identify sources of astrometry, we used the fourth catalog of interferometric observations of binary stars \citep[INT4,][]{Hartkopf:2001}. We only used measurements that included both a separation and position angle. In cases of literature data also available in one of the archives above, we adopted our own measurements over the literature data to ensure more homogeneous measurements and errors. We did not utilize $\Delta m$ measurements from the literature, although in some cases this information was used to verify the astrometry was for the correct binary system or component.  

In total, we used 571 measurements (each including a separation and position angle) from 61 references. The literature astrometry was asymmetrically distributed; roughly half of the points were for just 10 targets, predominately taken with the goal of measuring their orbits. Approximately 180 measurements came from speckle observations on the Special Astrophysical Observatory (SAO) 6m \citep[e.g.,][]{Bag2002}, WIYN \citep[e.g.,][]{Hor2017}, or SOAR \citep[][]{Tok2017b}, which tend to observe a wide range of nearby and/or bright binaries. About 160 points came from {\it HST}, primarily using the fine guidance sensors \citep[e.g.,][]{Benedict2016}, and focused on monitoring a small subset ($\simeq$10 binaries) of the sample to obtain precise orbits and masses. The rest of the measurements were from a mix of surveys focusing on taking many epochs of specific systems to determine orbits \citep[e.g.,][]{Koh2012} and broader surveys (e.g., for multiplicity) that obtain 1-2 epochs on each of dozens of binaries \citep[e.g.,][]{Janson2012}.  

One complication using older literature astrometry was the issue of inhomogeneous reporting of separation and position angle errors. Many references provided measurements without errors, and many more reported errors without accounting for field distortion or errors in the pixel scale and orientation. We mitigated this problem by generating an error common to a given reference. For each literature source, we identified a set of binaries where an orbit can be fit (with $<$5\% errors on the angular separation) without astrometry from that particular reference. Some literature sources were merged for this comparison, provided they used the same instrument and basic analysis. We included binaries outside the sample considered here. We fit the orbit following the method outlined in Section~\ref{sec:orbit}, using only the least-squares method for efficiency. We then compared the expected position angle and separation to the measurements from the reference in question. From this difference we computed the required missing error term, which, when added in quadrature with the reported errors (zero for those without errors) would yield a reduced $\chi^2$ ($\chi^2_\nu$) of 1. This process was repeated twice, each time updating the errors where appropriate (although the change is small between iterations). References where we could not test the reported errors (e.g., due to insufficient data) and those with extremely large required error terms ($>$50\,mas) were not used. This term is added in quadrature with literature reported uncertainties (if any are reported). 

All literature astrometry used in this paper is listed alongside our own measurements in Table~\ref{tab:astrom}. 

\subsection{Summary of input astrometry}

In total we measured or gathered 1100 unique datasets, approximately half of which we measured from adaptive optics images and the other half were from the literature. Most of the astrometry measurements done in this paper came from either NIRC2 (194 points) or PUEO (226), with a smaller contribution from NaCo (70) and NIRI (39). Although they represent only $\simeq$20\% of the total astrometric measurements, the NIRC2 measurements are the most critical in constraining orbital parameters. This is because NIRC2 astrometry was 1-2 orders of magnitude more precise than those from the literature, and a factor of 3-8$\times$ more precise than those from PUEO, NIRI, and NaCo. We characterized the relative importance of each data source using the total number of separation measurements weighted by their uncertainties. Under this metric, the NIRC2 points contributed $\gtrsim10\times$ more total orbital information than the literature data. Measurements from CFHT/PUEO had a comparable total contribution to the literature data, each of which had $\simeq2\times$ the impact of NaCo measurements, and $\simeq3\times$ that of data from NIRI. This metric likely underestimated the importance of the NIRC2 data, particularly that from our own program; literature and archive images tended to be concentrated on the best-characterized systems, while our NIRC2 observations were specifically coordinated to complete orbits and cover under- or un-sampled regions of binary orbits. 

\section{Orbit Fitting}\label{sec:orbit}

We fit the astrometry with the Monte Carlo Markov Chain (MCMC) software \textit{emcee} \citep{Foreman-Mackey2013}, a python implementation of the affine-invariant ensemble sampler \citep{goodman2010}. For each system, we fit for seven orbital elements: the orbital period ($P$), combined angular semi-major axis ($a\arcsec$), eccentricity ($e$), inclination ($i$), epoch of periastron passage ($T_0$), argument of periastron ($\omega$), and position angle of the line of nodes ($\Omega$). Parameters were limited by physical or definitional constraints, e.g., $P>0$, $0<e<1$, and $0<i<\pi$, but were given no additional boundaries. 

We applied priors of 1/$P$, 1/$a\arcsec$, and $\sin(i)$ to $P$, $a\arcsec$, and $i$, respectively. All other parameters evolved under uniform priors. Walkers were initialized with the best-fit orbit determined using \textit{MPFIT} \citep{Markwart2009} with a spread in starting values based on the \textit{MPFIT} estimated errors. Each MCMC chain was initially run for $10^5$ steps with 100 walkers. We tested to see if a chain converged using the autocorrelation time \citep{2010CAMCS...5...65G} and chains were checked by eye for signs on convergence. In about 1/3 of the systems the fit did not converge after the initial $10^5$ steps, so we ran these for $10^6$ total steps. Those that did not converge after $10^6$ steps were not included in our final sample. These are not counted in our final sample of 61 binaries (see Section~\ref{sec:targets}), as these were the least-well characterized systems. We saved every 100 steps in the chain, and the first 5\% of each chain was removed for burn-in. 

Systems of near-equal mass may have the primary and companion misidentified, both in our own measurements and also those taken from the literature. We identified such points by eye during the \textit{MPFIT} stage and manually adjusted the position angles before starting the MCMC run. In total $\simeq$16 points were corrected this way, almost all of which were for three systems with contrast ratios close to unity. A more robust solution to this problem would be to feed a double-peaked prior at the reported value and $\pm$180$^\circ$ into the likelihood function. However, in all cases the problematic points were obvious by eye, had reported $\Delta m$ consistent with zero, and a simple 180$^\circ$ correction completely fixed the orbit. 

Overall the quality of the fits is extremely good, with $\chi^2_\nu$ values ranging from 0.1 to 2, and cumulative distribution values (the probability of getting the $\chi^2$ or smaller given the degrees of freedom) from 2\% to 99\% (mean probability of 47\%). We show some example orbital fits in Figure~\ref{fig:orbits} (with the full set in the Appendix~\ref{sec:orbitplots}) and provide the median orbital parameters in Table~\ref{tab:orbits}. Orbits span a wide range in orbital period; the tightest binaries have $P<1$\,yr, while the widest have $P>50$\,yr. The two systems with $P>50$\,yr (Gl 301 and Gl 277) were also some of the least-well characterized. 

\begin{figure*}[htb]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl301AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl469AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3454AB.eps}
\caption{Example results of our orbit fitting procedure for Gl 301AB (left), Gl 469AB (middle), and GJ 3454AB (right). Points are individual measurements of the separation and position angle, color-coded by the data source. Black solid line shows the best-fit (highest likelihood). Dark grey lines are drawn by randomly sampling 50 orbit fits from the MCMC chain to display an estimate of the errors. The dotted line connects periastron passage, with an arrow pointing in the orbital direction, and the dashed-line showing the line of nodes. For Gl469AB, high-quality astrometry is available for the full orbit, and the resulting errors on orbital parameters are so small that the grey lines cannot be seen. All orbits are shown in Appendix~\ref{sec:a1}.}
\label{fig:orbits}
\end{center}
\end{figure*}

Our orbital fits made heavy use of literature astrometry, many of which had no reported errors. Our method for assigning or correcting errors assumed that all measurements have a common missing error term per source (Section~\ref{sec:litas}). It is more likely that errors depend on the separation and contrast ratio, as well as quantities that were not consistently reported, like weather, setup, and observational strategy. Further, this technique assumed an uncorrelated error term. In the case of an erroneous pixel scale or imperfectly aligned instrument, all measurements from a common instrument may be off in the same direction. In practice, it is difficult to correct for these effects without access to the actual images. The data suggest this does not impact our results; the final $\chi^2_\nu$ values for the best-fit orbits shows no correlation with the fraction of astrometry from the literature versus our own measurements, and measurements taken on the same target and night but from different sources agree within errors. 

As an additional test, we tried refitting six binaries with the most literature data twice, first doubling the error term added to the literature points, then halving it. In all cases, overall parameters and errors did not change significantly (although the final $\chi^2_\nu$ values changed). The main reason for this is that our measurements are generally far more more precise (with the exception of measurements from {\it HST}) and disproportionately weigh on the final solution, even in cases where most of the data is from the literature. In the case of halving errors, the MCMC would land on a similar solution, but with smaller parameter uncertainties and an extremely poor $\chi^2$ for the degrees of freedom. We conclude this treatment of errors does not significantly impact our final orbital fits. 

\section{Stellar Parameters}\label{sec:params}


\subsection{Parallaxes}\label{sec:plx}

Parallaxes for 59 of the targets were drawn from the literature. In general we adopted the most precise parallax available, although preference is given to those accounting for the binarity of the target and those with a baseline significantly different from the binary's orbital period. A few systems are in hierarchical triples with a wider companion with has an independent parallax measurement, which we used where possible. For $\simeq$1/3 of the sample, we drew parallaxes from the new reduction of the Hipparcos data \citep{van-Leeuwen:2007yq}. For the eight systems from \citet{Dupuy2017} we used their parallaxes, and those from \citet{Benedict2016} for 13 systems overlapping with our own sample. For nine systems we pulled parallaxes from the general catalogue of trigonometric parallaxes \citep{van-Altena1995}. 

%% clearly we need to check some numbers here
About half (29) of our targets do not have entries in the second data release of {\it Gaia} \citep[DR2, ][]{GaiaDr2,2018arXiv180409365G}. They were likely excluded because centroid shifts from orbital motion prevented a five-parameter (single-star) solution (a requirement to be included in DR2). We also found significant differences between the {\it Gaia} values and earlier measurements \citep[including from {\it Gaia} DR1, ][]{gaiadr1}. Many wide triples in {\it Gaia} DR2 (where the third star is several arc seconds away, and hence easily resolved) have significantly different parallaxes reported for the unresolved pair than for the wider companion. Orbital motion is likely impacting the parallax values or uncertainties, an issue that should be resolved in future Gaia data releases that will include fits for orbital motion. We found no such issues with our other parallax sources. So we decided to not use Gaia DR2 parallaxes for any of the binaries unless they had a wide (single) companion with an independent parallax. 

We ultimately used {\it Gaia} DR2 parallaxes for four systems, GJ1245AC, GJ277AC, and GJ4287AB, where we adopted the parallax of their wider common proper motion companion. In all cases the wider associated stars are not known to harbor another unresolved star, and hence they should not be impacted by the same binarity issue. GJ 570BC, Gl 695BC, GJ 2005BC, Gl 22AC, and 2M1047+40 also have nearby associated stars. However, Gl 570A is extremely bright ($G\simeq5$) and hence may have an unreliable parallax due to saturation in DR2, GJ 2005A has no entries in {\it Gaia} DR2, the available parallaxes (from {\it HST} and Hipparcos) for Gl 695BC and Gl 22AC are more precise than the ones for Gl 695A and Gl 22B from {\it Gaia} DR2, and the wide pair to 2M1047+40 is itself a tight binary \citep[LP 213-67AB,][]{Dupuy2017} with a large reported excess astrometric noise in Gaia \citep[a sign of binarity,][]{2018RNAAS...2...20E}.

For three systems we derived new parallaxes using MEarth astrometry \citep{Nutzman:2008gf}. Updated parallaxes were measured following the procedure from \citet{2014ApJ...784..156D}. The only difference was we used a dataset with a baseline $\simeq$two years longer, which helps average out systematic errors arising from centroid motion due to the binary orbit, and significantly reduces the overall uncertainties. 

We list all parallaxes and references in Table~\ref{tab:sample}.

\subsection{Metallicity}\label{sec:feh}

We estimated [Fe/H] using our SpeX spectra and the empirical relations from \citet{Mann2013a} for K5-M6 dwarfs, and \citet{Mann2014} for M6-M9 dwarfs. These relations use a series of atomic lines (primarily Na, Ca, and K features) in the optical or NIR \citep[e.g.,][]{2010ApJ...720L.113R,Terrien:2012lr}, empirically calibrated using wide binaries containing a solar-type primary and an M-dwarf companion \citep[e.g.,][]{2005A&A...442..635B,Johnson2009,Neves2012}. The calibrations were based on the assumption that components of such binaries have similar or identical metallicities \citep[e.g.,][]{2015ApJ...801L..10T}. Similar methods have been used extensively to assign metallicities across the M dwarf sequence \citep[e.g.,][]{Terrien2015,Muirhead2015,Dressing2017,2018ApJ...853...30V,2018ApJ...854..145M}. Final adopted [Fe/H] values are given in Table~\ref{tab:sample}. Errors account for Poisson noise in the spectrum, but because of relatively high SNR are generally dominated by the uncertainties in the calibration itself, which is estimated to be 0.08~dex \citep{Mann2013a,Mann2014}.

%Uncertainties on [Fe/H] from such spectroscopic determinations are generally 0.08-0.12~dex. This exceeds the measurement uncertainties by a factor of 1.5-3 \citep{Newton:2014}. The difference may be due to inhomogeneities in the assigned primary stars' metallicities \citep[e.g.,][]{2015ApJ...805..126B,2016ApJS..225...32B,2016ApJS..226....4H}, as well as complications in using atomic lines as a proxy, which are not expected to scale perfectly with iron abundances \citep{Rojas-Ayala:2012uq,Veyette2016a}. The existing data suggest that relative abundances (one M dwarf relative to another) are far more precise than the overall scale (relative the Sun).

For all but two targets (Gl 65 and HD 239960), our NIR spectra are for the combined flux of the binary components. \citet{Mann2014} explored the issue of measuring metallicities of binaries with unresolved data by combining spectra of single-stars with similar metallicities and re-applying the same calibration. The bias introduced is negligible ($\lesssim0.02$~dex) when compared to overall uncertainties. The added scatter is smaller than the measurement uncertainties, and can be explained entirely by the Poisson noise introduced in the addition of component spectra. 

Three targets (LP415-20, 2M2140+16, and 2M2206-20) have SpeX spectra taken with a wider slit, yielding lower spectral resolution. The bands in \citet{Mann2014} are defined using a homogeneous dataset taken with the narrow (0.3\arcsec) slit, so this difference may impact the derived [Fe/H]. We tested this by convolving a set of single-star SpeX spectra taken with the 0.3\arcsec\ slit with a Gaussian to put them at the appropriate lower resolution. The median of the derived [Fe/H] values changed by $<0.01$~dex, but the change varies between targets. Based on the resulting scatter, we estimate the errors on [Fe/H] from the lower-resolution spectra to be 0.12~dex on a Solar scale and 0.08~dex on a relative scale. These targets are marked separately in Table~\ref{tab:sample}. 

Two of the targets in our sample are L dwarfs (2M0746+20 and 2M1017+13). These both are most likely above the hydrogen burning limit, and hence are included in our analysis. However, the \citet{Mann2014} method contains no L dwarf calibrators. We report our derived [Fe/H] values for these systems, but advise treating the assigned values with skepticism until an L dwarf calibration becomes available. 

Two targets (Gl 792.1 and Gl 765.2) are too warm (earlier than K5) for the calibration of \citet{Mann2013a}. For these we take [Fe/H] values from \citet{2011A&A...530A.138C} and \citet{2010A&ARv..18...67T}, respectively. These [Fe/H] measurements are not necessarily on the same scale as those from \citet{Mann2013a}, which are calibrated against abundances of Sun-like stars from \citet{2015ApJ...805..126B,2016ApJS..225...32B}. Given reported variations in [Fe/H] for these stars, as well as [Fe/H] determination differences \citep{2014AJ....148...54H,2016ApJS..226....4H} we adopt conservative 0.08~dex uncertainties on both systems. For the other target lacking a SpeX spectrum (Gl 54), we derive [Fe/H] using the optical calibration of \citet{Mann2013a} and a moderate-resolution optical spectrum taken from \citet{Gaidos2014}.

\subsection{$K_S$-magnitudes} \label{sec:mags}

We adopted unresolved $K_S$ magnitudes from the Two Micron All Sky Survey \citep[2MASS,][]{Skrutskie2006}. Some of the brightest stars in our sample are near or beyond saturation in 2MASS. For these targets we recalculated $K_S$ magnitudes using available optical and NIR spectra, following the method of \citet{Mann2015a} and \citet{Mann2015b}, using available optical spectra from \citet{Gaidos2014}. Synthetic magnitudes were broadly consistent with 2MASS $K_S$ magnitudes (and at similar precision) for fainter targets ($K_S>7$). We only updated $K_S$ magnitudes for bright systems where where our synthetic photometry differed from the 2MASS value by more than 2$\sigma$ (five systems). We mark these systems in Table~\ref{tab:sample}. 

While all targets considered here had at least one measurement in a filter centered with the $K$ band, none of the filters used were an exact match for 2MASS $K_S$. Many of the observations were taken with narrow-band $K_{\rm{cont}}$ ($\lambda_c\simeq2.27$\um) or Br$\gamma$ ($\lambda_c\simeq2.17$\um) filters, for example. We transformed these into 2MASS magnitudes before computing the final $\Delta K_S$. These corrections were usually small ($\lesssim0.1$ magnitudes), and details on their derivation are given in Appendix~\ref{sec:a1}.

To compute $\Delta K_S$, we calculated the robust weighted mean of contrast ratios derived from our AO data (Section~\ref{sec:astrometry}). For $\Delta K_S$, we used all data centered somewhere within the $K$ band. Errors on contrasts for a given dataset were the RMS in flux measurements among consecutive images. The errors may be underestimated errors because of imperfect PSF modeling, flat-fielding, uncorrected non-linearities in the detector, as well as intrinsic variability of the star. We compared $\Delta K_X$ measurements of the same star using the same filter and instrument but on different nights (Figure~\ref{fig:magnitudes}). The comparison suggested a missing error term of 0.016\,magnitudes for NIRC2, 0.02 for PUEO and NaCo, and 0.03 for NIRI. We only tested this for $K$-band filters, but we found consistent values for different $K$-band filters from the same instrument. We included this term as an additional error term in our computation of $\Delta K_S$.

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{errors.eps}
\caption{Distribution of contrast ratio differences (in units of standard deviations) for data taken on the same target but in different nights. The red line is before adding the missing error term, while the blue line shows the distribution after adding this. The grey dashed line shows the expected Normal distribution. The histograms are offset slightly for clarity, although identical bins are used as input.}
\label{fig:magnitudes}
\end{center}
\end{figure}

We did not use literature contrast ratios (even those in $K$-band), as we cannot perform and the same corrections applied to those from our own analysis. The exception was Gl 762.1, for which we have no AO data. For this target we adopt the value from \citet{CIA2010}.

For GJ 2005BC and Gl 900BC, the 2MASS PSF includes flux from the A component. In both cases we use our AO data to measure $\Delta K$ between all three components. The total $K_S$ magnitude given in Table~\ref{tab:sample} already have the A component removed. 

\section{The Mass-Luminosity Relation}\label{sec:relation}

\subsection{Methodology}

For main-sequence stars, the mass-luminosity relation traditionally takes the form:
\begin{equation}\label{eqn:ml}
\frac{L_*}{L_\odot} = C \left(\frac{M_*}{M_\odot}\right)^\alpha,
\end{equation}
where $\alpha$ depends on the dominant energy transport mechanism (e.g., radiative versus convective) and internal structure of the star \citep{2004sipp.book.....H}. 

We rewrite Equation~\ref{eqn:ml} in terms of \mks\ (and $\log(M_*/M_\odot)$) instead of $L_*$. Absolute magnitudes are more easily measured than overall luminosity, and avoid introducing errors from uncertain bolometric corrections or the need to take flux-calibrated spectra in order to measure the bolometric flux directly. Switching to \mks\ also mitigates effects of abundances. The $K$-band is heavily dominated by metal-insensitive CO and H$_2$O absorption bands. Optical bands are dominated by strong molecular (e.g. TiO, CO, CaH, MgH, and VO) bands that introduce a strong dependence to [Fe/H] and [$\alpha$/Fe] (Figure~\ref{fig:metal}). 

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=\textwidth]{metallicity_effect.eps}
\caption{Effect of changes in [M/H] on a model spectrum at \teff=3200\,K, $\log(g)=5$ in $g$- (left), $r$ (middle), and $K$-band (right). The top panel shows [M/H]=0 (black) and [M/H]=+0.5 (red) spectra from the CFIST BT-SETTL models \citep{2012RSPTA.370.2765A}. The bottom panel shows the ratio of the two, highlighting how small an effect [M/H] has in the $K$-band compared to optical regions. The one feature that stands out in the $K$-band is the Na doublet, which is a commonly used as a metallicity diagnostic for dwarfs \citep{2010ApJ...720L.113R,Terrien:2012lr,Newton:2014}, and a gravity diagnostic for pre-main-sequence stars \citep[e.g.,][]{Schlieder2012}. }
\label{fig:metal}
\end{center}
\end{figure*}

Our sample encompasses almost an order of magnitude in mass and hence a range of underlying stellar physics. No single power law is expected to fit over the full sequence. Instead, we assumed that $\alpha$ depends on \mks, which we approximated as a polynomial. This yields a \mmk\ relation of the form:
\begin{equation}\label{eqn:mmk}
\log \left( \frac{M_*}{M_\odot} \right) = \sum_{i=0}^{n} a_i(M_{K_S}-zp)^i,
\end{equation}
where $a_i$ are the fit coefficients. The number of coefficients ($n$) was determined by testing how the fit improves with increasing $n$. The constant $zp$ is a zero-point (or anchor) magnitude, which we fixed at 7.5. This approximately corresponded to the logarithmic central mass of stars in our sample. 

For the left hand side, we computed the total system mass ($M_{\rm{tot}}$) for each binary by combining the the orbital period ($P$) and total angular semi-major axis ($a\arcsec$) from our fits to the orbital parameters (Section~\ref{sec:orbit}) with the parallaxes ($\pi$, Section~\ref{sec:plx}), following a rewritten form of Kepler's laws:
\begin{equation}\label{eqn:mass}
M_{\rm{tot}} = M_{1}+M_{2} = \frac{(a\arcsec/\pi)^3}{P^2},
\end{equation}
where $P$ is in years, $a\arcsec$ and $\pi$ are in arcseconds, and $M_{\rm{tot}}$ is in Solar masses. 

Because Equation~\ref{eqn:mass} does not provide component masses, when fitting for the $a_i$ coefficients we performed the comparison between the predicted and dynamical {\it total} mass for each system. For this, we rewrote Equation~\ref{eqn:mmk} in terms of total mass:
\begin{eqnarray}\label{eqn:mmk2}
M_{tot} &=& 10^{b_1} + 10^{b_2},\\
b_j &=& \sum_{i=0}^{n} a_i(M_{K_S,j}-zp)^i, \label{eqn:mmk2_b}
\end{eqnarray}
where \mks$_{,1}$ and \mks$_{,2}$ are the primary and companion absolute $K$-band magnitudes, which were calculated from our measured $\Delta K_S$ and unresolved $K_S$ magnitudes (Section~\ref{sec:mags}). Equation~\ref{eqn:mmk2} could easily be modified for higher-order star systems, providing individual \mks\ magnitudes and the total mass of the system are known. %Additionally, in the case where the mass ratio is known for some systems (e.g., from radial velocities), we could trivially add this in as an additional constraint. 

We fit for the $a_i$ terms in Equation~\ref{eqn:mmk2} using the MCMC code \textit{emcee}, which lets us fit for the strong covariance between coefficients. Each coefficient evolved under uniform priors without limits, and was initialized to the best-fit value derived from \textit{MPFIT}. We ran the MCMC chain with 600 walkers for $10^6$ steps after a burn-in of 50,000 steps. We tested values of $n$ (number of $a_i$ terms) from three to six. %THIS NEEDS CHECKING We found significant improvement in both $\chi^2$ and the Bayes factor for the best-fit relation using up to five constants, but both metrics gave negligible improvement when we move to a sixth. 

Errors on the dynamical mass are correlated to the errors on \mks. The system mass scales with the cube of the semi-major axis, which depends linearly with the parallax. As a result, the parallax was a major, if not the largest, source of uncertainty on the mass for most systems. Similarly, our $K_S$ magnitudes had relatively small errors (0.01-0.03\,mag), so \mks\ errors tended to be dominated by the parallax. Because this correlation is usually along (parallel to) the direction of the \mmk\ relation, it can tighten the fit if properly taken into account (when compared to assuming uncorrelated errors). 

Our strategy was to treat distances of each system as a free parameter, letting them evolve under a prior from the observed parallax. The MCMC fit to Equation~\ref{eqn:mmk2} was provided $a\arcsec^3/P^2$ and $K_S$ (with uncertainties) for each system, from which total mass and \mks\ were recomputed from the varying parallax of each system at each step in the MCMC before making a comparison. Since the orbital information provides no constraint on the distance, this effectively forced the MCMC to explore a distribution along the input prior. It is possible for the parallax posterior to shift off this prior if it provides better agreement with the relation as determined by the rest of the sample. However, in practice this does not happen; for all systems the parallax posteriors matched the input values.% (Figure~\ref{fig:parallax}). 
%% Well we should test this with the extra plx error. 


%\begin{figure*}[htb]
%\begin{center}
%\includegraphics[width=0.32\textwidth]{plx_GJ1005.eps}
%\includegraphics[width=0.32\textwidth]{plx_GJ661.eps}
%\includegraphics[width=0.32\textwidth]{plx_Gl310.eps}
%\caption{A comparison of example input 1$\sigma$ priors (black lines) to the output posteriors (red distributions). Gl 310 represents one of the largest differences between the prior and posterior, highlighting that the measured parallax prior dominates the MCMC exploration. }
%\label{fig:parallax}
%\end{center}
%\end{figure*}

For computational efficiency we assumed Gaussian errors on $a\arcsec^3/P^2$. Although $a\arcsec$ and $P$ were often correlated and non-Gaussian, posteriors of $a\arcsec^3/P^2$ were well-described by a Gaussian (Figure~\ref{fig:correlated}). The only deviations were the systems with the worst parameters overall, which tended to have somewhat asymmetric posteriors, but also had a relatively small impact on the final fit. %However, these systems had little influence over the final fit.

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{LHS6167_corner.eps}
\caption{Example joint posterior on semi-major axis and orbital period (bottom left) for the system LHS 6167. Grey regions show 1, 2, and 3$\sigma$ (from darkest to lightest) of the points. The histograms above and to the right show the one-dimensional distributions of each parameter. The parameter fed into the \mmk\ fit is $a\arcsec^3/P^2$ (in arcsec$^3$ per year$^2$), which we show in the top right inset. }
\label{fig:correlated}
\end{center}
\end{figure}

For main-sequence dwarfs at fixed metallicity, more massive stars should always be brighter. Thus we required that the resulting fit have a negative derivative (higher \mks\ always gives lower mass) over the full range of input objects considered. We tested running without this constraint, and found similar results over most of the parameter range considered. The major difference was near the edges of the input sample. Without the negative derivative constraint, the fit would often become double valued where there were few points to constrain the fit.

\subsection{Results and Uncertainties}

Our initial fit was extremely tight, suggesting mass errors $<1\%$ over the the entire $M_*$ range considered. However, this fit yielded a $\chi^2$ of (57 degrees of freedom). The larger scatter could be due to missing physics, such as metallicity (which we discuss in Section~\ref{sec:metal}). It is also possible that errors on individual mass determinations are underestimated. This could be due to uncorrected systematic errors in the orbital solutions, stellar variability, and/or underestimated errors on %% come back to this later

We show the output coefficient posteriors in Figure~\ref{fig:fitpost}. The spread in the posteriors for individual coefficients is rather large, suggesting significant errors on each coefficient. However, the coefficients are also highly correlated; for a given value assigned to four of the five fit coefficients, there is a relatively narrow set of solutions for the final constant. 

\begin{figure*}[p]
\begin{center}
\includegraphics[width=0.9\textwidth]{output_params_5.pdf}
\caption{Posterior projections for the $a_i$ values derived from our MCMC fit to Equation~\ref{eqn:mmk2}. Contours denote the 1, 2, and 3$\sigma$ confidence intervals, and the dashed lines in the histogram mark 1$\sigma$.
Figure was generated using corner.py \citep{corner}.}
\label{fig:fitpost}
\end{center}
\end{figure*}

The final fit was tightly constrained over most of the sequence which we show in Figure~\ref{fig:relation} for individual masses, and combined masses in Figure~\ref{fig:m_m} (a more realistic representation of how the fit was done). We provide the best fit (highest likelihood) coefficient values in Table~\ref{tab:coeff}. Since the gain from four to five coefficients was small (but significant), we include coefficients for both in Table~\ref{tab:coeff}, but we adopt the five-parameter (4th order) solution for all analyses and figures.


\begin{figure*}[htp]
\begin{center}
\includegraphics[width=\textwidth]{MK_mass_1.eps}
\caption{Absolute $K_S$-band magnitude as a function of mass for targets in our sample (circles). Points are color-coded by their estimated metallicity. We show a typical error ellipse in grey to highlight that errors on mass and \mks\ measurements are correlated, and usually parallel to the $M_*$-\mks\ relation (both depend on the common parallax). The black dashed line indicates the best-fit (highest likelihood) from our MCMC analysis. To provide an estimate of the scatter in the relation as a function of mass, we show 100 randomly selected fits from the MCMC chain in grey. Note that our orbit fits only provide {\it total} mass; we used the mass ratios derived from the best-fit \mmk\ relation for the purposes of this figure. }
\label{fig:relation}
\end{center}
\end{figure*}


\begin{figure}[ht]
\begin{center}
\includegraphics[width=0.47\textwidth]{Mass_mass_5_0.eps}
\caption{Predicted total (system) $M_*$ from the \mmk\ relation as a function of the total mass determined from the orbit fit. Ellipses represent $\simeq1\sigma$ distribution of values for each point, accounting for parallax errors common to both the predicted and dynamical mass, but not accounting for scatter in the final \mmk\ relation. Color-coding by [Fe/H] matches that of Figure~\ref{fig:relation}.}
\label{fig:m_m}
\end{center}
\end{figure}


\begin{deluxetable*}{l l l l l l l}
\tablecaption{Best-fit Coefficients for Equations~\ref{eqn:mmk2} and \ref{eqn:mmk3}}
\tablehead{
\colhead{$a_0$} & \colhead{$a_1$} & \colhead{$a_2$} & \colhead{$a_3$} & \colhead{$a_4$} & \colhead{f} %& \colhead{$\chi^2$ }
}
\startdata
-0.644537 &  -0.199364 &  2.384413$\times10^{-5}$ &  4.809947$\times10^{-3}$ & -3.287834$\times10^{-5}$ & \nodata \\%& 1.42 \\ 
-0.638246 &  -0.203070 & -3.023017$\times10^{-3}$ &  4.639837$\times10^{-3}$ & \nodata & \nodata \\%& 1.86 \\
\hline
-0.646133 &  -0.195170 &  2.365097$\times10^{-3}$ &  4.469372$\times10^{-3}$ & -1.032628$\times10^{-4}$  & 0.045 \\%& 1.34 \\
 -0.642451 &  -0.197349 &  1.579457$\times10^{-4}$ &  4.668038$\times10^{-3}$ & \nodata & 0.039 \\%& 1.76 \\
 \enddata
\label{tab:coeff}
\tablecomments{The first row is the preferred fit, as the $f$ parameter is not significant. Note that values presented here are the highest likelihood, while Figures~\ref{fig:fitpost} and \ref{fig:fitpost_feh} note the median coefficient values.}
\end{deluxetable*}

To estimate the uncertainty the relation we computed the standard deviation in the derived masses for a fixed \mks\ across all MCMC steps, which we report in Table~\ref{tab:err}. In the best-constrained regions ($5\lesssim$\mks$\lesssim7$, $0.3\lesssim M_*\lesssim0.6$) the scatter in the relation is 2-3\% in $M_*$. The fit is less-well constrained near the edges, where errors on $M_*$ can exceed 5\%. Some of this is due to expected behavior of polynomials near the edge and a lack of data on the extreme ends. Stars at the high-mass end of our sample also have weaker orbital constraints overall.

\begin{deluxetable}{l l l l l l l }
\tablecaption{Error in \mmk\ Relation}
\tablehead{
 \colhead{$M_{K_S}$} & \colhead{$M_*$} & \colhead{$\sigma_{M_*}^a$} & \colhead{$\sigma_{M_*}^a$} & \colhead{SpT$^b$} \\
 \colhead{(mag)} & \colhead{$M_\odot$} & \colhead{$M_\odot$} & \colhead{\%} & 
}
\startdata
\multicolumn{5}{c}{No [Fe/H] term, 5 $a_i$ terms} \\
\hline
 4.0 & 0.712 & 0.024 & 0.033 & K4.5 \\
 4.5 & 0.682 & 0.014 & 0.021 & K7.0 \\
 5.0 & 0.614 & 0.012 & 0.020 & M0.0 \\
 5.5 & 0.526 & 0.010 & 0.019 & M1.5 \\
 6.0 & 0.4354 & 0.0086 & 0.020 & M2.5 \\
 6.5 & 0.3519 & 0.0080 & 0.023 & M3.0 \\
 7.0 & 0.2805 & 0.0076 & 0.027 & M3.5 \\
 8.0 & 0.1775 & 0.0055 & 0.031 & M4.5 \\
 8.5 & 0.1431 & 0.0045 & 0.031 & M5.0 \\
 9.0 & 0.1175 & 0.0038 & 0.032 & M6.0 \\
 9.5 & 0.0989 & 0.0037 & 0.037 & M6.5 \\
10.0 & 0.0855 & 0.0039 & 0.046 & M7.5 \\
10.5 & 0.0765 & 0.0045 & 0.059 & M9.0 \\
11.0 & 0.0710 & 0.0056 & 0.079 & L1.0 \\
\hline
\multicolumn{5}{c}{[Fe/H] term, 4 $a_i$ terms} \\
\hline
 4.0 & 0.732 & 0.027 & 0.037 & K4.5 \\
 4.5 & 0.681 & 0.015 & 0.022 & K7.0 \\
 5.0 & 0.607 & 0.011 & 0.018 & M0.0 \\
 5.5 & 0.521 & 0.010 & 0.019 & M1.5 \\
 6.0 & 0.4346 & 0.0091 & 0.021 & M2.5 \\
 6.5 & 0.3546 & 0.0075 & 0.021 & M3.0 \\
 7.0 & 0.2850 & 0.0060 & 0.021 & M3.5 \\
 8.0 & 0.1813 & 0.0044 & 0.024 & M4.5 \\
 8.5 & 0.1457 & 0.0040 & 0.028 & M5.0 \\
 9.0 & 0.1188 & 0.0038 & 0.032 & M6.0 \\
 9.5 & 0.0989 & 0.0037 & 0.037 & M6.5 \\
10.0 & 0.0848 & 0.0037 & 0.044 & M7.5 \\
10.5 & 0.0755 & 0.0040 & 0.053 & M9.0 \\
11.0 & 0.0703 & 0.0046 & 0.066 & L1.0 \\
\enddata
\label{tab:err}
\tablecomments{This table assumes \mks\ (and [Fe/H]) are known perfectly. Total errors on $M_*$ should take into account errors in the measured parameters and the relation. }
\tablenotetext{$a$}{The uncertainty in the resulting $M_*$ at a given $M_{K_S}$}
\tablenotetext{$b$}{Spectral types are given for reference, but are extremely rough because of a significant dependence on metallicity and how the spectral typing is done (e.g., which indices are used, NIR versus optical). It is not recommended to use this table as a means to compute \mks\ or $M_*$ from a spectral type or vice versa. }
\end{deluxetable}

The values in Table~\ref{tab:err} can be used as an approximate reference for estimating errors on the output mass for a given \mks\ if combined with errors from the distance and $K_S$ magnitude. However, this can be misleading, as the posterior is not Gaussian or symmetric over much of the mass range. It is better to sample the posterior at a given \mks\ to produce a posterior in mass. To facilitate use of our \mmk\ and help provide realistic uncertainties, we include the fit posteriors and provide a simple code that provides output $M_*$ posteriors\footnote{\href{https://github.com/awmann/M_-M_K-}{https://github.com/awmann/M\_-M\_K-}} given an \mks\ and error. 

The fit with the highest likelihood yields a $\chi^2_\nu$ of 1.4 with 57 degrees of freedom (accounting for correlated errors). The larger than expected $\chi^2_\nu$ is primarily driven by a handful of systems that agree with the best-fit to within $\simeq$3\%, but also have small total mass uncertainties ($\lesssim$1\%). The MCMC explores the range of solutions, so if we factor in the scatter in the final \mmk\ relation then the $\chi^2_\nu$ value decreases to 0.98. As a result, using the fit posteriors provides uncertainties on $M_*$ that encompass the larger scatter. 

The larger than expected scatter could be due to systematically underestimated uncertainties, most likely in the input distances. As we noted with the {\it Gaia} DR2 parallaxes (Section~\ref{sec:plx}), orbital motion can shift the centroid and hence impact the measured parallax. This is particularly true for systems with orbital periods near an alias of one year (the parallax signal's period). Most of the systems included were not heavily altered by this because they either had their parallaxes drawn from a nearby bound (and single) star, were calculated accounting for the presence of the binary, or have orbits far from the timescale of the parallactic signal. 

If the parallactic or orbital errors were underestimated this could bias our result towards the most precise points. We explored this possibility by redoing our MCMC analysis adding a parameter that uniformly increases the parallax uncertainty of all systems. The final fit parameters and resulting relation were negligibly different from those derived without the added error term, and the only meaningful change was a reduction in the $\chi^2_\nu$ of the best-fit solution. 

\subsection{The role of metallicity}\label{sec:metal}

We explored the the effects of [Fe/H] on the \mmk\ relation using the Mesa Isochrones and Stellar Tracks \citep[MIST,][]{MIST0,MIST1}. We also tested models from the Dartmouth Stellar Evolution Database \citep[DSEP,][]{Dotter2008}, and found results to be broadly in agreement. We preferred MIST because their model atmospheres include a newer set of molecular lines (e.g., TiO) that are important in M dwarfs and may impact the synthetic photometry. The Lyon models \citep[BHAC15,][]{BHAC15} employ a model atmosphere in reasonable agreement with nearby stars with interferometrically determined \teff\ values \citep{Boyajian2012,Mann2013c}, and go to lower masses than DSEP and MIST. However, the BHAC15 models cover only solar metallicity. 

We show the expected \mks\ tracks from MIST for different metallicities in Figure~\ref{fig:mk_metal} alongside our empirical determinations. MIST models do not extend below 0.1$M_\odot$, so we restricted our comparison to above that mass. For this comparison we assumed a fixed age of 5\,Gyr, although the choice of age from 1-10\,Gyr makes a negligible difference for the mass range shown. Note that metal-rich stars are expected to be {\it less luminous} in \mks\ (and $L_{\rm{bol}}$) for a fixed $M_*$, whereas the opposite trend is seen for a fixed \teff\ and most color selections. Above 0.4$M_\odot$ there is a slight trend for metal-rich stars in our sample to land below the median sequence, as expected from the models. However, many metal-poor stars also land below the sequence, and there is no obvious trend below 0.4$M_\odot$. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{Model_metal_0.eps}
\caption{\mks\ as a function of $M_*$ using MIST tracks of different metallicities (dashed lines) compared to empirical mass determinations (points). Color-coding by metallicity is the same for the points and lines, and matches the color scale of Figure~\ref{fig:relation}. The plot cuts at 0.1$M_\odot$, as the MIST models do not go below this limit. }
\label{fig:mk_metal}
\end{center}
\end{figure}


The residuals from our best-fit relation confirmed a weak (or no) effect on the derived $M_*$ due to changes in [Fe/H], as we show in Figure~\ref{fig:metal_resid}. A Spearman rank test yielded no significant correlation between the residuals and [Fe/H]. We tried resampling the measurements using their uncertainties, and $<$1\% of samples showed a significant correlation. We also repeated this test, but restricted to just the best-characterized systems ($<5\%$ precision on mass) and still found no significant trend with [Fe/H]. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{residual_metal5.eps}
\caption{Fractional difference between the orbital and predicted system mass as a function of metallicity of the system. The top panel contains all systems, while the bottom shows just those with $<$5\% uncertainties on $M_*$. Points are color-coded by the masses of components, with the inner dot corresponding to the primary star's estimated mass, and the outer circle the companion's estimated mass. }%Quoted errors in mass account for the scatter in the \mmk\ relation.} 
\label{fig:metal_resid}
\end{center}
\end{figure}

Our sample is limited in its [Fe/H] range; 64\% of the targets are $-0.2<$[Fe/H]$<+0.2$ and only one target has [Fe/H]$<-0.5$. It is possible that our best-fit relation masked any [Fe/H] term by shifting the fit to match the typical metallicity of stars at a given \mks. We explored this by fitting for a term in [Fe/H] of the form:
\begin{eqnarray}\label{eqn:mmk3}
M_{tot} &=& (1+f[\rm{Fe/H]})\left(10^{b_1} + 10^{b_2}\right),
\end{eqnarray}
where $b_j$ is defined in Equation~\ref{eqn:mmk2_b}. This form assumes that a linear change in [Fe/H] corresponds to a fractional change in $M_*$ (e.g., f=0.1 would correspond to a 10\% change in derived $M_*$ per dex in [Fe/H] for a fixed \mks). This is generally consistent with the evolutionary models, although there is a small change in the scale ($f$) over the range of masses considered here. 

For this analysis we excluded the two L dwarfs from the sample because of questionable assigned metallicities. As with our fit to Equation~\ref{eqn:mmk2}, we tested range of values for $n$ (number of $a_i$ coefficients). When including the [Fe/H] term, we found significant improvements in the fit up to $n=4$, compared to $n=5$ without $f$. Our MCMC fitting method was otherwise identical to that outlined in Section~\ref{sec:relation}. Since we were primarily interested in the {\it relative} effect of [Fe/H], and not necessarily the absolute scale, we assumed the smaller (relative) errors on [Fe/H] (see Section~\ref{sec:feh}).

We show the output coefficient posteriors in Figure~\ref{fig:fitpost_feh} and list the best-fit coefficients in Table~\ref{tab:coeff} for both the third- ($n=4$) and fourth-order ($n=5$) fits. The best-fit value of $f$ is consistent with zero (0.06$\pm$0.06 per dex [Fe/H]). The relatively large errors are a consequence of the narrow range of [Fe/H] values compared to overall measurement uncertainties. 

\begin{figure*}[p]
\begin{center}
\includegraphics[width=0.97\textwidth]{output_params_4feh.pdf}
\caption{Same as Figure~\ref{fig:fitpost}, but for the fit following Equation~\ref{eqn:mmk3}, i.e., including the [Fe/H] term, $f$. }
\label{fig:fitpost_feh}
\end{center}
\end{figure*}


To compare to the models, we fit the MIST grid points in the same manner as the empirical dataset following Equation~\ref{eqn:mmk3}. In Figure~\ref{fig:f} we show the posterior on $f$ from the model grid compared to that from the dynamical masses. While the posteriors have some overlap, more than 96\% of the difference between the two posteriors ($f_{\rm{model}}-f_{\rm{dynamical}}$) is greater than zero, indicating (with marginal significance) that the models overpredict the effect of [Fe/H] on the \mmk\ relation. 

\begin{figure}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{F_plot.eps}
\caption{Comparison of the posterior on $f$ (fractional change in $M_*$ per dex in metallicity for a fixed \mks; Equation~\ref{eqn:mmk3}) predicted by the MIST models (black) compared to that using our dynamical masses (red). There are an identical number of points in each posterior and the bin sizes are the same. }
\label{fig:f}
\end{center}
\end{figure}

If real, it is unclear if this difference between the models and empirical data applies to the full mass range considered; there is some indication that the metallicity effect is stronger for higher-mass stars in the sample. This could be due to a problem with missing opacity/molecular lines in the atmospheric models, which would be strongest for the lowest-mass stars. Missing opacity at optical wavelengths could strengthen the effect of [Fe/H] by underestimating the number of saturated features (if a line is saturated adding [Fe/H] cannot make it stronger). The effect at NIR wavelengths would be weaker, since there are fewer molecular bands, but underestimated opacity in the optical would also change the continuum levels in the NIR as well as how those levels change with [Fe/H]. 


Since the effect of [Fe/H] is stronger at bluer wavelengths, optical flux ratios of our targets could help test this hypothesis. Additionally, the models suggest $f$ is $\simeq$30\% larger for [Fe/H]$<-1.0$, so a set of subdwarf binaries will provide more leverage to test over what mass range, if any, the discrepancy with the models is statistically significant. 

\subsection{Comparison to previous relations}\label{sec:other}

\subsubsection{\citet{Delfosse2000}}

\citet{Delfosse2000} provided one of the most commonly used \mmk\ relations, covering $0.1M_\odot<M_*0.6M_\odot$. Like our work, the calibration was build primarily on astrometric binaries. Nearly all the targets in \citet{Delfosse2000} were included in our sample, with the exception of triple systems and eclipsing binaries, both of which we intentionally avoided because of the complexity of computing total masses in the first scenario and estimating \mks\ in the latter. Because of the sample overlap, consistency is expected. However, a comparison can be useful to see how past use of \citet{Delfosse2000} may change with our more precise results.

We show the comparison in Figure~\ref{fig:delfosse}, including the points used in the \citet{Delfosse2000} calibration as well as the two fit lines. The relations are in agreement to better than 10\% over the full mass range considered, and within 5\% over most of the calibration region ($0.15M_\odot \lesssim M_* \lesssim 0.5M_\odot$). Given errors often quoted for the \citet{Delfosse2000} relation (5-10\%) the two fits are consistent. However, the relation presented here is a factor of 2-3 more precise over the whole mass regime. 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Delfosse_comp.eps}
\caption{Absolute $K_S$-band magnitude as a function of mass for astrometric binaries analyzed by \citet{Delfosse2000} (red circles). The resulting $M_*$-\mks\ relation from \citet{Delfosse2000} is shown as a teal dashed line, while the best-fit relation from this paper is shown as a blacked dashed line (with error in grey as in Figure~\ref{fig:relation}). The bottom panel shows the residual of the \citet{Delfosse2000} points compared to our relation.}
\label{fig:delfosse}
\end{center}
\end{figure}

\subsubsection{\citet{Mann2015b}}

\citet{Mann2015b} built a catalog of 183 M dwarfs with precise \teff\ and $R_*$, calibrated against radii measurements from long-baseline optical interferometry \citep{Boyajian2012} and precision bolometric fluxes \citep[e.g.,][]{Mann2015a,2015MNRAS.447..846B}. Masses were computed for these stars by interpolating the parameters onto an updated version of the DSEP models as described in \citet{Feiden2013,Feiden2014} and \citet{Muirhead2014}. Although these masses were model-dependent, they accurately reproduced the mass-radius relation from low-mass eclipsing binaries. This suggested that the model-based masses were accurate to $\simeq$3\% or better, and motivated the development of a \mmk\ relation from the \citet{Mann2015b} sample. A comparison to our relation can be seen in part as a test on the updated DSEP models, in addition to the results given in \citet{Mann2015b}. 

We show our fit with uncertainties alongside \citet{Mann2015b}'s in Figure~\ref{fig:mann}. The two fits track each other extremely well, with a maximum divergence of $\simeq$5\%. Given the quoted 2-3\% uncertainties from \citet{Mann2015b} and the 2-3\% scatter in our relation, this difference is not significant. There is a hint of tension at the high-mass end, where our MCMC posterior is asymmetric, and at 0.2-0.3$M_\odot$ where the difference is the largest, but never does the the offset exceed the estimated uncertainties. 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Mann_comp.eps}
\caption{Comparison of $M_*$-\mks\ from \citet{Mann2015b}, shown as a teal dashed line, to that from this paper, which is shown in black, with 100 randomly selected realizations of the MCMC (as with Figures \ref{fig:relation} and \ref{fig:delfosse}). Residual is shown in the bottom panel. Individual points from \citet{Mann2015b} on which the calibration is based are not shown (for clarity), but they follow a tight sequence around the teal line. Only the range of masses covered by \citet{Mann2015b} are shown. }
\label{fig:mann}
\end{center}
\end{figure}




\subsubsection{\citet{Benedict2016}}
Like our work, the \citet{Benedict2016} relation was also based primarily on masses derived from M dwarf astrometric binaries. \citet{Benedict2016} sample uses absolute astrometry from {\it HST} fine guidance sensors and radial velocities for a subset of systems. In addition to the precision provided by {\it HST}, this combination yields individual (component) masses, and, in many cases, independent constraints on parallaxes. So although our sample is larger and contains most of the targets in \citet{Benedict2016}, their analysis is not subject to many of the complications of our own. 

We compare our \mmk\ relation \citet{Benedict2016}'s in Figure~\ref{fig:benedict}. The two relations are in excellent agreement for $0.09M_\odot\lesssim M_* \lesssim 0.25M_\odot$. Below this regime, the \citet{Benedict2016} fit is effectively anchored by one star, GJ1245C, because the two other stars in this low-mass regime (GJ 2005B and C) have relatively large errors. GJ1245AC is in our sample, but we use a parallax from \citet{GaiaDr2} on GJ 1245B for this system, which places it $10\sigma$ (2.5\%) more distant than the parallax adopted by \citet{Benedict2016}. Our parallax-free orbital parameters for this system are in excellent agreement with \citet{Benedict2016}, but the \citet{GaiaDr2} parallax makes the final parameters more consistent with our overall relation. Since the \citet{Benedict2016} parallax accounted for the binarity of this system, the origin of difference between these two parallaxes is unclear. If GJ 1245B is itself an unresolved binary, this could explain the discrepant parallax (although there is no evidence of this in the literature). If the \citet{Benedict2016} parallax is correct, we need to explain why GJ 1245C is significantly more luminous than similar-mass stars, such as youth \citep{2015ApJ...800...95L,2017ApJ...834...85N}.

%It is possible that GJ1245 is young, which would help explain its luminosity. GJ1245ABC (B is $\simeq$7\arcsec\ away) all have sub-day rotation periods and show significant flaring \citep{2015ApJ...800...95L,2017ApJ...834...85N}. Late-M dwarfs lose their initial rotation slowly, so such short rotation periods and flare rates are not uncommon at this mass \citep{Newton2016,2018arXiv180307708P}. We can only conclude that GJ1245 is likely $<2$\,Gyr, which cannot necessarily explain its luminosity. Further, GJ1245A ($M_*=0.117M_\odot$, \mks=8.890) lands slightly {\it below} our relation, showing no evidence of overluminosity. The system would need to land in a narrow range of ages where A is solidly on the main-sequence, but C is still contracting \citep[$\simeq$400-600\,Myr based on Lyon models, ][]{BHAC15}. 

 Above 0.3$M_\odot$, \citet{Benedict2016} predicts masses as much as 10\% higher than our own for a fixed \mks. Our fit agrees reasonably well with the astrometric binaries fit by \citet{Benedict2016} in this mass regime. The divergence is driven, instead by literature mass determinations \citet{Benedict2016} included in their \mmk\ fit. Inspection of these literature points makes the origin of the discrepancy more clear; many are eclipsing binaries and have $\Delta K$-band magnitudes of mixed quality and/or lack parallaxes needed for a precise \mks. GU Boo, for example, has absolute magnitudes estimated from an optical eclipse depth combined with bolometric corrections \citep{Lopez2005}, which are drawn from models that perform poorly on M dwarfs \citep{1998A&AS..130...65L,Hauschildt1999}. Similarly, for GJ 2069 AC (CU Cnc) \citet{Benedict2016} adopted \mks\ from \citet{Ribas2003} that disagree with the 2MASS $K_S$ and {\it Gaia} DR2 parallax (for either AC or B) using any $\Delta K_S$. We conclude that the \mks\ determinations for these systems need to be revised before including them in future analyses of the \mmk\ relation. 


\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.47\textwidth]{Benedict_comp.eps}
\caption{Absolute $K_S$-band magnitude as a function of $M_*$ for astrometric binaries analyzed by \citet{Benedict2016} (red circles) and those used in the \citet{Benedict2016} relation, but pulled from the literature (blue circles). The resulting $M_*$-\mks\ relation from \citet{Benedict2016} is shown as a teal dashed line, while the best-fit relation from this paper is as a black dashed line (with random samplings in grey as in earlier figures). The bottom panel shows the residual of the \citet{Benedict2016} points compared to our relation, with the \citet{Benedict2016} relation in teal for reference. Errors in the residuals only reflect errors in $M_*$ and \mks, and do not account for errors in our $M_*$-\mks\ relation. }
\label{fig:benedict}
\end{center}
\end{figure}

%% problematic points:
%% GJ 278 C GJ 278 D (YY Gem): can't figure out where the K magnitudes came from?
%% GJ 570 B GJ 570 C: This is in our sample. We get total mass of 0.8330.053, they get 0.9760.012. They report delk~1.18, while we get 0.995. 
%% GJ 2069 A GJ 2069 C: Junky (bolometric correction) parallax and K 
%% GU Boo A GU Boo B: Crappy parallax and K

%\subsection{Testing mass ratio predictions}
%One drawback of our ana

\section{Conclusions \& Discussion}\label{sec:discussion} 

\subsection{Summary}
The mass-luminosity relation has proven to be a critical tool for estimating masses of cool stars for decades, and has applications from studying extrasolar planets to measuring the initial mass function and mass-to-light ratio in massive galaxies. The \mmk\ relation has been particularly useful because \mks\ is easily measured if the stellar distance is known, and because it mitigates the effect of metallicity when compared to bluer bands. With the arrival of {\it Gaia} parallaxes combined with existing 2MASS photometry, nearly all the early M-dwarfs out to $\simeq$100\,pc and late M-dwarfs out to $\simeq$50\,pc have precise ($\lesssim1\%$) parallaxes and \mks\ magnitudes, massively increasing the utility of this relation. 

We endeavored to improve on existing \mmk\ relations and explore the role of [Fe/H] by expanding the sample of calibrators and using new techniques to measure the metallicity of binary M dwarfs. As part of this effort, we have been monitoring a set of nearby late K and M dwarf visual binaries using adaptive optics imaging with the goal of mapping their orbits and estimating their masses. We combined these data with similar data from Keck, CFHT, Gemini, and VLT archives, as well as astrometric measurements from the literature. The combination of literature astrometry and the recent Keck measurements were particularly important to provide the baseline on long-period ($P>10$ years) systems. 

We used these data to fit the orbits for 53 binaries, which we combined with parallaxes from the literature or derived from MEarth astrometry to determine the total masses of each system. We combined this with eight ultracool binaries from \citep{Dupuy2017}, which were analyzed in a nearly identical way to the procedure used in this paper and provide significantly improved coverage near the hydrogen burning limit. Seven binaries have total mass determinations better than 1\%, with a median precision of 6\%.

We used our dynamical masses and resolved \mks\ magnitudes to fit for an empirical relation between $M_*$ and \mks. The result provides masses precise to 2-3\% from $0.3-0.6M_\odot$ and $<5$\% over the whole M dwarf sequence. The relation also covers almost an order of magnitude in $M_*$, from $\simeq0.7M\odot$ down to the hydrogen burning limit ($\simeq0.075M_\odot$). The scatter around the best-fit relation is larger than expected from the mass uncertainties, especially when considering that errors in \mks\ and $M_*$ are correlated. This might be due to underestimated errors in the parallaxes (possibly from centroid motion of the binary), or intrinsic scatter from additional physics (e.g., metallicity and age). 

Using empirically calibrated spectroscopic abundances, we explored the role of [Fe/H] on the \mmk\ relation, comparing our results to expectations from evolutionary models as a guide. While the MIST models follow our empirical data relatively well, there is some evidence (96\%) that the models are overestimating the effect of [Fe/H]. We consider this suggestive, but not conclusive at this time, as the narrow metallicity range of our sample limits our ability to explore this further. 

We compared our relation to recent similar relations in the literature. Given quoted uncertainties, both the \citet{Delfosse2000} and \citet{Mann2015b} relations follow ours well over most of the sequence. Since the \citet{Mann2015b} masses are rooted in an updated version of the DSEP code, the level of agreement suggests that these models perform extremely well in predicting the masses of old, main-sequence M dwarfs. 

Our results agreed well with the observational sample of astrometric binaries analyzed by \citet{Benedict2016}, but our relation diverges from \citet{Benedict2016} above $\simeq0.35M_\odot$. We attribute this difference to literature points included in the \citet{Benedict2016} fit from earlier analyses (mostly eclipsing binaries) with uncertain distances and $\Delta K_S$ magnitudes. Increasing availability of {\it Gaia} parallaxes for these systems as well as ongoing efforts to measure their eclipses in range of wavelengths \citep[e.g.,][]{2017AJ....154..100H} should significantly improve their utility for studying the mass-luminosity relation of M dwarfs.


%\subsection{Complicating factors}


%%something about systematics in the AO data we analyzed?

%A more troubling scenario would be a mix of very low-mass objects (brown dwarfs) around a subset of the targets, such that no individual object appears as an outlier but the relation is statistically biased. We tested this by randomly adding companions to stars, assuming a conservative $\simeq20\%$ of M dwarf binaries are in triple systems \citep{Fischer1992}. Masses to the added companions were assigned assuming a uniform companion distribution, and periods following a log-normal distribution from \citet{Raghavan2010} and requiring a stability criterion of a 10:1 period ratio. We then excluded systems where the third star would have been detected, the resulting mass would make it $>3\sigma$ outlier in the \mmk\ relation, and those that would be detected using existing radial velocity data \citep{1999A&A...344..897D,Beu2004,Benedict2016} and show no evidence of an undetected triple. Further 

%% I think we should comment on how Dupuy stars at the HBL were selected. 

%Based on our selection criteria and lack of activity in the late K and early M dwarfs, we expect $>90\%$ of our sample to be older than 1-2\,Gyr \citep{2017ApJ...834...85N}. Many of the coolest stars in our sample are rapidly rotating and/or show H$\alpha$ emission \citep{Gaidos2014,2015ApJ...800...95L}, but not at atypical levels for even old stars in this mass range \citep{2015AJ....149..158S}. 


\subsection{Suggestions when using our \mmk\ relation}\label{sec:caveats}


To help users interested in using \mks\ to compute a realistic $M_*$ and $\sigma_{M_*}$, we provide \href{https://github.com/awmann/M_-M_K-}{a simple code} to sample the fit posterior. {\bf Before using that code or the provided MCMC posteriors, take note of the following suggestions:}
\begin{itemize}
\item The fit behaves poorly near the edges of the calibration sample. The scatter in the MCMC posterior accounts for this, but restrict use to $4.0<M_{K_S}<11.0$ ($0.07M_\odot<M_*<0.70M_\odot$), and a `safe' range would be $4.5<M_{K_S}<10.5$ ($0.08M_\odot<M_*<0.68M_\odot$). 

\item Our relation is only valid for main-sequence stars, and the role of youth and activity is not included here. Based on the Lyon models \citep{BHAC15}, we advise restricting use to $>$100\,Myr above $0.4M_\odot$, $>$300\,Myr to $0.2M_\odot$, $>$500\,Myr to $0.1M_\odot$, and $>1$\,Gyr below 0.1$M_\odot$. A safer cut would be to only use this on stars $>$1 Gyr, similar to the input calibration sample.

\item The result is only tested over $-0.60<\rm{[Fe/H]}<+0.45$. We provide a fit that attempts to take into account changes due to [Fe/H], but the effect is poorly constrained (fractional change of $0.06\pm0.06$ in $M_*$ per dex in [Fe/H]). Assuming the target is within the metallicity range of M dwarfs in the Solar neighborhood \citep[$-0.05\pm0.18$,][]{Gaidos2014} then the $M_*$ uncertainty introduced by the unknown [Fe/H] value is $\simeq$1\%. However, when targeting more metal-poor populations like the thick disk or halo ([Fe/H]$\lesssim-0.5$) the effect on the derived $M_*$ may be $>$5\%. We advise avoiding this relation for stars or populations with [Fe/H]$<-0.5$. The effects of more detailed abundances (e.g., [$\alpha$/Fe]) are completely untested.

\item The relation is only tested above the hydrogen burning limit. Since the boundary likely depends on metallicity \citep{2001RvMP...73..719B}, it is also not possible to use a simple $M_{K_S}$ cut even if the target is known to be old. Objects just below the hydrogen burning limit age slowly \citep{BHAC15}, so the relation given here may give reasonable results for many of these, but we urge caution when interpreting $M_*$ values for $M_{K_S}>10.5$. 

\end{itemize}


\subsection{Future directions}

We intentionally selected targets that had $\Delta K$ measurements, as \mks\ was known to give the tightest relation with $M_*$ for M dwarfs. Unfortunately, there is no other band with contrast ratios for all systems considered here. Most of our monitoring was done with NIRC2 on Keck, so many systems have a $\Delta H$, but only about 1/3 of the sample have measurements in an optical band. This limits the utility of the sample, as {\it Gaia} $G$, $BP$, and $RP$ are now widely available for early and mid-M dwarfs, and are generally measured with better precision than 2MASS $K_S$. The growing capabilities of speckle cameras \citep[e.g.,][]{2009AJ....137.5057H} offer the opportunity to add optical contrasts. These can be converted to {\it Gaia} bandpasses, given reasonable assumptions about the component spectra, and used to derive a $M_{G}-M_*$ (or $M_G-M_*$-[Fe/H]) relation that can be easily applied to millions of K and M dwarfs. Complementary optical data also provide colors for individual components, from which we can measure component \teff\ and luminosity \citep[e.g.,][]{2017ApJ...845...72K}.

Our sample was limited mostly to stars in the Solar neighborhood, and hence was heavily biased towards the narrow [Fe/H] distribution of nearby stars. We identified five additional [Fe/H]$<-0.5$ systems including two subdwarf binaries. However all systems had short baselines in the literature compared to their expected orbital periods. It may take 1-2 more years to complete their orbits at the required precision for this kind of analysis. The availability of {\it Gaia} parallaxes will also help improve the precision of the known metal-poor systems and aid in the identification of new ones. Lastly, as new methods arrive to measure detailed abundances of M dwarfs \cite{Veyette2016a,Veyette2017} we can explore effects beyond just [Fe/H]. 

Although the sample studied here contained 122 stars, we only had half that many data points (61) constraining the fit, as the mass ratios were not known. This complicates the fit at the bottom of the sequence, where the relation is steeper. Here, small changes in the shape can have a significant impact on the implied mass ratio for a given system, providing a means to generate many reasonable solutions to the same set of system masses. This can be seen in Figure~\ref{fig:relation} as a spread in the range of possible solutions \mks$>10$. Later Gaia data releases will include full astrometry information, which, when combined with a measure of the flux ratio and our existing astrometry will enable a global fit for individual masses as well as the system parallax. 

The presence of unresolved tight companions (triples or quadruples) could bias the overall relation. A close-in third star orbiting one of the two binary components might be stable, and would not have been detected in our AO data. An unseen companion would drive the total mass of the system higher, but has much smaller effect on the total luminosity. So unresolved triples will sit {\it low} in Figure~\ref{fig:relation} (higher mass for a fixed \mks). A few stars do sit well below the fit, but no more so than expected given their mass uncertainties. Many of our targets have some radial velocity data in the literature \citep[e.g.,][]{1999A&A...344..897D,Raghavan2010,Benedict2016}, which rule out the presence of any unresolved stellar companion. However a more detailed analysis 

Ages of our binary sample are not known, preventing any study into the effects of age on the \mmk\ relation. However, our larger sample of binaries  with orbit measurements still in progress contains known members of nearby young moving groups and the Hyades cluster. Many of these have complete or nearly complete orbital solutions, and will soon provide a powerful set of mass benchmarks with known ages. These systems also span ages from 10-650\,Myr, offering the chance to both test pre-main-sequence models of M dwarfs \citep{2015ApJ...813L..11M,2016ApJ...817..164R,2016ApJ...818..156C,2016AJ....152..175N} and explore the role of activity on M dwarf parameters \citep[e.g.,][]{Spada2013,2018arXiv180404133K}. The current sample can be included in such work when combined with optical activity indicators and rotation periods like those expected from the Transiting Exoplanet Survey Satellite \citep[{\it TESS},][]{2014SPIE.9143E..20R}. 

%We endeavored to select stars that land above the hydrogen burning limit, as stars below this range should not follow a strict mass-luminosity relation. Most of our objects near this boundary came from \citet{Dupuy2017}, and we adopted their classification as stellar or substellar. It is possible that some objects near the low-mass edge of our sample are brown dwarfs. Inclusion of any such substellar (old) systems would bias the fit towards higher $M_*$ for a given \mks. Objects just below this limit decline in luminosity slowly, and still may follow the same relation on $\simeq$Gyr timescales, so we expect this bias, if present, to be small. Further, the excellent agreement between all points $<0.85M_\odot$ suggests all objects are obeying the same \mmk\ relation (Figure~\ref{fig:relation}).


\acknowledgements
AWM was supported through Hubble Fellowship grant 51364 awarded by the Space Telescope Science Institute, which is operated by the Association of Universities for Research in Astronomy, Inc., for NASA, under contract NAS 5-26555. This work was supported by a NASA Keck PI Data Award (award numbers 1554237, 1544189, 1535910, and 1521162), administered by the NASA Exoplanet Science Institute. Data presented herein were obtained at the W. M. Keck Observatory from telescope time allocated to the National Aeronautics and Space Administration through the agency's scientific partnership with the California Institute of Technology and the University of California. The Observatory was made possible by the generous financial support of the W. M. Keck Foundation.

The authors wish to recognize and acknowledge the very significant cultural role and reverence that the summit of Mauna Kea has always had within the indigenous Hawaiian community. We are most fortunate to have the opportunity to conduct observations from this mountain.

The authors acknowledge the Texas Advanced Computing Center (TACC) at The University of Texas at Austin for providing grid resources that have contributed to the research results reported within this paper. URL: http://www.tacc.utexas.edu.

Based on observations obtained at the Gemini Observatory (acquired through the Gemini Observatory Archive), which is operated by the Association of Universities for Research in Astronomy, Inc., under a cooperative agreement with the NSF on behalf of the Gemini partnership: the National Science Foundation (United States), the National Research Council (Canada), CONICYT (Chile), Ministerio de Ciencia, Tecnolog\'{i}a e Innovaci\'{o}n Productiva (Argentina), and Minist\'{e}rio da Ci\^{e}ncia, Tecnologia e Inova\c{c}\~{a}o (Brazil). Observations taken from programs GN-2008B-Q-57, GN-2009B-Q-10, GN-2010B-Q-9, and GN-2011A-Q-26.

Based on observations collected at the European Organisation for Astronomical Research in the Southern Hemisphere under ESO programmes 071.C-0388(A), 072.C-0570(A), 073.C-0155(A), 075.C-0521(A), 075.C-0733(A), 077.C-0783(A), 078.C-0441(A), 079.C-0216(A), 080.C-0424(A), 081.C-0430(A), 082.C-0518(A), 082.C-0518(B), 085.C-0867(B), 086.C-0515(A), 086.C-0515(B), 090.C-0448(A), 091.D-0804(A), 098.C-0597(A), 382.C-0324(A), and 382.D-0754(A).

 This research has made use of the Keck Observatory Archive (KOA), which is operated by the W. M. Keck Observatory and the NASA Exoplanet Science Institute (NExScI), under contract with the National Aeronautics and Space Administration. 

Based on observations obtained at the Canada-France-Hawaii Telescope (CFHT) which is operated by the National Research Council of Canada, the Institut National des Sciences de l'Univers of the Centre National de la Recherche Scientifique of France, and the University of Hawaii. 

This work presents results from the European Space Agency (ESA) space mission Gaia. Gaia data are being processed by the Gaia Data Processing and Analysis Consortium (DPAC). Funding for the DPAC is provided by national institutions, in particular the institutions participating in the Gaia MultiLateral Agreement (MLA). The Gaia mission website is \href{https://www.cosmos.esa.int/gaia}{https://www.cosmos.esa.int/gaia}. The Gaia archive website is \href{https://archives.esac.esa.int/gaia}{https://archives.esac.esa.int/gaia}.

\software{emcee, corner.py, mpfit, scipy, pyfits, astropy, python, spextools, IDL}

\facilities{Keck:II (NIRC2), IRTF (SpeX), CFHT (PUEO, aobir), VLT:Antu (NaCo); Gemini:North (NIRI)}

\bibliography{$HOME/Dropbox/fullbiblio}

\input{astrom_table.tex}
%\clearpage

\input{sample.tex}

\input{orbit.tex}

\clearpage

\appendix 
\section{Converting Observed $\Delta K_X$ to 2MASS $\Delta K_S$ for M dwarfs} \label{sec:a1}
To place all $K$-band magnitudes on the 2MASS system, we derived a relation between $\Delta K_X$ and $\Delta K_S$ as a function of $\Delta K_X$, where $X$ denotes the particular filter (e.g., $K_{\rm{cont}}$, $K'$) used for the AO observations. For photometry, we only used observations taken with a filter somewhere in the $K$-band (all wavelengths are used for astrometry), which included observations with the narrow Bracket-Gamma filter. 

To derive a conversion between contrasts, we used the 183 absolutely-flux calibrated spectra of nearby single stars from \citet{Mann2015b}, which cover a similar range of \teff\ and $M_*$ as the sample considered here. These spectra are mostly empirical; models are only used to fill in gaps in the spectrum, none of which land in the regions covered by the filters considered here.

First we randomly sampled two stars from the sample and scaled the absolute level of each spectrum by the star's distance (effectively placing both at 1\,pc). We convolved each of the two stars with the relevant filter profiles for NIRC2\footnote{\href{https://www2.keck.hawaii.edu/inst/nirc2/filters.html}{NIRC2 Filters}}, KIR\footnote{\href{http://www.cfht.hawaii.edu/Instruments/Filters/kir.html}{KIR Filters}}, NIRI\footnote{\href{http://www.gemini.edu/sciops/instruments/niri/imaging/filters}{NIRI Filters}}, and NaCo\footnote{\href{http://www.eso.org/sci/facilities/paranal/instruments/naco/inst/filters.html}{NACO Filters}}, and integrate over the wavelength range of the filters to compute the flux ($F$) in a given band. We used a filter profile for 2MASS $K_S$ from \citet{2003AJ....126.1090C}. The $\Delta K_X$ value for the given pair was then computed as $2.5log_{10}(F_1/F_2)$. 

We repeated this process with 5000 unique combinations of the 183 stars for 12 different filter/instrument combinations. For each filter and instrument combination we computed a best-fit line to $\Delta K_S -\Delta K_X$ as a function of $\Delta K_X$. We show four examples in Figure~\ref{fig:mags}. For the majority of the filters considered, the trend is insignificant compared to errors in the underlying spectra and absolute calibration ($\simeq0.02$\,mag). We did not apply a correction in these cases. 

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.47\textwidth]{NACO_Ks.eps}
\includegraphics[width=0.47\textwidth]{NIRC2_BrG.eps}
\includegraphics[width=0.47\textwidth]{KIR_Kp.eps}
\includegraphics[width=0.47\textwidth]{NIRC2_Kcont.eps}
\caption{Difference between 2MASS $\Delta K_S$ and four example $\Delta m$ values measured from our AO imaging, built from a grid of absolutely-calibrated spectra and the filter profiles provided for each filter. No corrections are applied for the NIRC2 Bracket-Gamma (BrG) and $K_S$ (K-short) filter, as the trend is not significant compared to potential systematic issues in the calibration of the underlying spectra. }
\label{fig:mags}
\end{center}
\end{figure*}

We did not see a significant difference in any derived correction based on the metallicity of the component stars, as expected based on how [Fe/H] changes $K$-band flux levels (Figure~\ref{fig:metal}). Thus we did not attempt to include [Fe/H] in these relations. We also found no significant effect as a function of the mass of the primary. However, this was difficult to test due to limitations of the input sample. The \citet{Mann2015b} spectral sample covers K7 to M7, but is poorly populated on the extreme ends. While we can make a wide range of combinations of low-contrast systems (M0+M0 to M6+M6), we have limited options for high-contrast (where primary can only be $\sim$ K7-M1) systems where temperature effects would be most clear.

\clearpage

\section{Orbits of binaries}\label{sec:orbitplots}

Here we show diagnostic plots of each of the binaries in our sample. 

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1005AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ2005AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ22AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl54AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1038AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ65AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP9724AB.eps} %%Gl 84
\includegraphics[width=0.32\textwidth]{Orbits/PMJ02133+3648AB.eps} 
\includegraphics[width=0.32\textwidth]{Orbits/HD15285AB.eps} %% Gl98
\caption{Orbital fit for each binary fit in this paper. The black star marks the primary (always at 0, 0). The best-fit (highest likelihood) is shown as a black line, with 50 randomly selected orbit fits from the MCMC shown in grey to provide an estimate of the uncertainties. In some fits, the range of orbital solutions is so small that the grey lines are not visible underneath the best-fit black line. Points are individual separation and position angle measurements with adopted uncertainties, color-coded by the data source (Gemini/NIRI in green, VLT/NaCo in blue, CFHT/PUEO in light red, Keck/NIRC2 in dark red, and literature data in light blue). The dashed line is the line of nodes, the dotted line indicates periastron passage, and the arrow marks the direction of motion. }
\label{fig:orbits1}
\end{center}
\end{figure*}

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/HIP11542AB.eps} %% Gl99
\includegraphics[width=0.32\textwidth]{Orbits/Gl125AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl190AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1081AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ234AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3412AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3421AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl263AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl277AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ3454AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl301AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl310AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits2}
\end{center}
\end{figure*}


\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl330AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/LHS6167AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ340AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP46706AB.eps}%% Gl352
\includegraphics[width=0.32\textwidth]{Orbits/Gl381AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ416AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl469AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl473AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl494AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ570AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ600AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ623AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits3}
\end{center}
\end{figure*}

\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1210AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl660AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ661AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ4024AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl695AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl747AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ748AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP95995AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HIP96656AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ1245AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl7912AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl804AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits4}
\end{center}
\end{figure*}




\begin{figure*}[htp]
\begin{center}
\includegraphics[width=0.32\textwidth]{Orbits/Gl831AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/GJ4210AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl844AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/HD239960AB.eps} 
\includegraphics[width=0.32\textwidth]{Orbits/GJ4287AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl8934AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl900AB.eps}
\includegraphics[width=0.32\textwidth]{Orbits/Gl913AB.eps}
\caption{Figure~\ref{fig:orbits1} continued.}
\label{fig:orbits5}
\end{center}
\end{figure*}
\end{document}


